// print-save.js - å°åˆ·ãƒ»ä¿å­˜é–¢é€£ã®æ©Ÿèƒ½ã‚’åˆ†é›¢
// å…ƒãƒ•ã‚¡ã‚¤ãƒ«: remotesign.html
// åˆ†é›¢æ—¥: 2025-08-20

// ==========================================
// ç”»åƒä¿å­˜é–¢æ•°ç¾¤
// ==========================================

// ğŸ–¼ï¸ 180åº¦å›è»¢ç”»åƒä¿å­˜é–¢æ•°
function saveRotatedImage() {
  
  try {
    // æœ€çµ‚çš„ãªç”»åƒç”¨ã®canvasã‚’ä½œæˆ
    const finalCanvas = document.createElement('canvas');
    const finalCtx = finalCanvas.getContext('2d');
    finalCanvas.width = canvas.width;
    finalCanvas.height = canvas.height;
    
    // 1. èƒŒæ™¯ã‚’å…ˆã«æç”»ï¼ˆå›è»¢ã•ã›ãªã„ï¼‰
    if (backgroundImage) {
      finalCtx.drawImage(backgroundImage, 0, 0, finalCanvas.width, finalCanvas.height);
    } else {
      // ç™½èƒŒæ™¯ã§å¡—ã‚Šã¤ã¶ã—
      finalCtx.fillStyle = '#ffffff';
      finalCtx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
    }
    
    // 2. ãƒšã‚¤ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’180åº¦å›è»¢ã•ã›ã¦æç”»
    if (drawingCommands.length > 0) {
      
      // 180åº¦å›è»¢å¤‰æ›ã‚’é©ç”¨
      finalCtx.save();
      finalCtx.translate(finalCanvas.width, finalCanvas.height);
      finalCtx.rotate(Math.PI);
      
      // æç”»ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œï¼ˆåº§æ¨™ã¯å…ƒã®ã¾ã¾ã€ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒå›è»¢ã—ã¦ã„ã‚‹ï¼‰
      drawingCommands.forEach(cmd => {
        if (cmd.type === 'start') {
          finalCtx.beginPath();
          finalCtx.moveTo(cmd.x, cmd.y);
        } else if (cmd.type === 'draw') {
          finalCtx.lineWidth = cmd.thickness || 8;
          finalCtx.strokeStyle = cmd.color || 'black';
          finalCtx.lineTo(cmd.x, cmd.y);
          finalCtx.stroke();
        }
      });
      
      finalCtx.restore();
    } else {
      alert('ä¿å­˜ã§ãã‚‹æç”»ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }
    
    // ãƒ•ã‚¡ã‚¤ãƒ«åã«ç¾åœ¨æ™‚åˆ»ã‚’å«ã‚ã‚‹
    const now = new Date();
    const timestamp = now.toISOString().slice(0, 19).replace(/[:-]/g, '').replace('T', '_');
    const filename = `rotated_drawing_${timestamp}.png`;
    
    // ä¿å­˜å‡¦ç†
    finalCanvas.toBlob(function(blob) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      alert(`180åº¦å›è»¢ç”»åƒã‚’ ${filename} ã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ`);
    }, 'image/png');
    
  } catch (error) {
    console.error('âŒ 180åº¦å›è»¢ç”»åƒä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
    alert('ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

// ğŸ–¼ï¸ 360åº¦å›è»¢ç”»åƒä¿å­˜é–¢æ•°
function saveDoubleRotatedImage() {
  
  try {
    // æœ€çµ‚çš„ãªç”»åƒç”¨ã®canvasã‚’ä½œæˆ
    const finalCanvas = document.createElement('canvas');
    const finalCtx = finalCanvas.getContext('2d');
    finalCanvas.width = canvas.width;
    finalCanvas.height = canvas.height;
    
    // 1. èƒŒæ™¯ã‚’å…ˆã«æç”»ï¼ˆå›è»¢ã•ã›ãªã„ï¼‰
    if (backgroundImage) {
      finalCtx.drawImage(backgroundImage, 0, 0, finalCanvas.width, finalCanvas.height);
    } else {
      // ç™½èƒŒæ™¯ã§å¡—ã‚Šã¤ã¶ã—
      finalCtx.fillStyle = '#ffffff';
      finalCtx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
    }
    
    // 2. ãƒšã‚¤ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’360åº¦å›è»¢ã•ã›ã¦æç”»ï¼ˆã¤ã¾ã‚Šå…ƒã®å‘ãï¼‰
    if (drawingCommands.length > 0) {
      
      // 360åº¦å›è»¢ = å…ƒã®å‘ããªã®ã§ã€å¤‰æ›ãªã—ã§æç”»
      drawingCommands.forEach(cmd => {
        if (cmd.type === 'start') {
          finalCtx.beginPath();
          finalCtx.moveTo(cmd.x, cmd.y);
        } else if (cmd.type === 'draw') {
          finalCtx.lineWidth = cmd.thickness || 8;
          finalCtx.strokeStyle = cmd.color || 'black';
          finalCtx.lineTo(cmd.x, cmd.y);
          finalCtx.stroke();
        }
      });
      
    } else {
      alert('ä¿å­˜ã§ãã‚‹æç”»ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }
    
    // ãƒ•ã‚¡ã‚¤ãƒ«åã«ç¾åœ¨æ™‚åˆ»ã‚’å«ã‚ã‚‹
    const now = new Date();
    const timestamp = now.toISOString().slice(0, 19).replace(/[:-]/g, '').replace('T', '_');
    const filename = `normal_drawing_${timestamp}.png`;
    
    // ä¿å­˜å‡¦ç†
    finalCanvas.toBlob(function(blob) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      alert(`é€šå¸¸å‘ãç”»åƒã‚’ ${filename} ã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ`);
    }, 'image/png');
    
  } catch (error) {
    console.error('âŒ é€šå¸¸å‘ãç”»åƒä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
    alert('ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

// ==========================================
// å°åˆ·å‡¦ç†é–¢æ•°ç¾¤
// ==========================================

// ğŸ–¨ï¸ å®Ÿéš›ã®å°åˆ·å‡¦ç†é–¢æ•°
function actualPrintProcess() {
  try {
    // æ–°ã—ã„canvasã‚’ä½œæˆï¼ˆtaintedã«ãªã‚‰ãªã„ã‚ˆã†ã«ï¼‰
    const cleanCanvas = document.createElement('canvas');
    const cleanCtx = cleanCanvas.getContext('2d');
    cleanCanvas.width = canvas.width;
    cleanCanvas.height = canvas.height;
    
    // ç™½èƒŒæ™¯ã§å¡—ã‚Šã¤ã¶ã—ï¼ˆèƒŒæ™¯ç”»åƒã¯ä½¿ã‚ãªã„ï¼‰
    cleanCtx.fillStyle = '#ffffff';
    cleanCtx.fillRect(0, 0, cleanCanvas.width, cleanCanvas.height);
    
    // ä¿å­˜ã•ã‚ŒãŸæç”»ã‚³ãƒãƒ³ãƒ‰ã‚’å†å®Ÿè¡Œï¼ˆ360åº¦å›è»¢ = å…ƒã®å‘ãï¼‰
    if (drawingCommands.length > 0) {
      
      // æç”»ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œï¼ˆå›è»¢ãªã— = å…ƒã®å‘ãï¼‰
      drawingCommands.forEach(cmd => {
        if (cmd.type === 'start') {
          cleanCtx.beginPath();
          cleanCtx.moveTo(cmd.x, cmd.y);
        } else if (cmd.type === 'draw') {
          cleanCtx.lineWidth = cmd.thickness || 8;
          cleanCtx.strokeStyle = cmd.color || 'black';
          cleanCtx.lineTo(cmd.x, cmd.y);
          cleanCtx.stroke();
        }
      });
      
    } else {
      alert('å°åˆ·ã§ãã‚‹æç”»ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }
    
    // å°åˆ·ç”¨ã®æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ä½œæˆ
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
      <html>
        <head>
          <title>å°åˆ·ç”¨ç”»åƒ</title>
          <style>
            body { margin: 0; text-align: center; }
            img { max-width: 100%; height: auto; }
            @media print {
              body { margin: 0; }
              img { max-width: 100%; height: auto; }
            }
          </style>
        </head>
        <body>
          <img src="${cleanCanvas.toDataURL()}" alt="æç”»ç”»åƒ"/>
        </body>
      </html>
    `);
    
    printWindow.document.close();
    
    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã‹ã‚‰å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
    printWindow.onload = function() {
      setTimeout(() => {
        printWindow.print();
      }, 500);
    };
    
    alert('å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‹ãã¾ã™');
    
  } catch (error) {
    console.error('âŒ å°åˆ·å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
    alert('å°åˆ·å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

// ==========================================
// ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
// ==========================================
console.log('âœ… print-save.js loaded successfully');