<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self' wss://realtime-sign-server-1.onrender.com ws://localhost:* wss://localhost:*; img-src 'self' data: blob:; media-src 'self';">
  <title>é€ä¿¡å´v3.9-smooth</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="modern">
<button id="themeToggle" onclick="toggleTheme()">ğŸ“ ã‚¯ãƒ©ã‚·ãƒƒã‚¯</button>

<div class="main-container" style="display: flex; justify-content: center; align-items: flex-start; gap: 20px;">
<div class="canvas-container">
<div style="position: relative; display: inline-block; margin: 50px auto 20px auto;">
  <img src="back2.png" alt="èƒŒæ™¯ç”»åƒ" style="transform: scale(1.3); display: block;">
  <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: pink; transform: scale(1.3); transform-origin: center; pointer-events: none; z-index: 1;"></div>
  <canvas id="drawCanvas" width="283" height="420" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scale(1.3); transform-origin: center; cursor: crosshair; background: transparent; z-index: 10;"></canvas>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«: Clearã€è‡ªåˆ†ã ã‘å‰Šé™¤ã€é€ä¿¡ -->
<div class="main-controls" style="display: flex; align-items: center; gap: 15px;">
  <button onclick="clearCanvas()">Clear</button>
  <button onclick="clearMyDrawing()" style="background-color: #FF6B6B; color: white;">è‡ªåˆ†ã ã‘æ¶ˆå»</button>
  <button onclick="startWaitingAnimation()" style="background-color: #FF9800; color: white; font-size: 18px; padding: 12px 24px; font-weight: bold;">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  <button onclick="saveDoubleRotatedImage()" style="background-color: #4CAF50; color: white; font-size: 18px; padding: 12px 24px; font-weight: bold;">æ¸¡ã™</button>
  <div id="countdownTimer" style="font-size: 16px; font-weight: bold; color: #333; display: none; background-color: #FFF3CD; border: 2px solid #FFEAA7; border-radius: 8px; padding: 8px 12px;">
    <span id="countdownText">--ç§’</span>
  </div>
</div>

<!-- é€æ˜ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¨åŒæœŸã™ã‚‹ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º -->
<div id="syncCountdown" style="
  position: fixed;
  top: 20px;
  right: 50px;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 15px 20px;
  border-radius: 10px;
  font-size: 24px;
  font-weight: bold;
  z-index: 9999;
  display: none;
">5</div>

<!-- å¹•ãŒé–‰ã˜ã¦ã„ã¾ã™è¡¨ç¤º -->
<div id="curtainClosedDisplay" style="
  position: fixed;
  top: 20px;
  right: 50px;
  background: rgba(200, 50, 50, 0.9);
  color: white;
  padding: 15px 20px;
  border-radius: 10px;
  font-size: 18px;
  font-weight: bold;
  z-index: 9998;
  display: block;
">å¹•ãŒé–‰ã˜ã¦ã„ã¾ã™</div>

<!-- ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ä¸Šã®ã€Œå¹•ãŒä¸Šã‚‹ã¾ã§ã€ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ -->
<div id="curtainCountdown" style="
  position: absolute;
  background: rgba(255, 255, 255, 0.95);
  color: #333;
  padding: 10px 15px;
  border-radius: 8px;
  border: 2px solid #FF9800;
  font-size: 16px;
  font-weight: bold;
  z-index: 10000;
  display: none;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
">
  <div style="font-size: 14px; color: #666;">å¹•ãŒä¸Šã‚‹ã¾ã§</div>
  <div id="curtainTimer" style="font-size: 28px; color: #FF9800; margin-top: 5px;">3</div>
</div>

<!-- å³ã‚µã‚¤ãƒ‰ãƒãƒ¼: ãƒšãƒ³ã®è‰²ã¨å¤ªã•ã‚’ä¸¦ã¹ã¦é…ç½® ï¼ˆClearãƒœã‚¿ãƒ³ã®ç›´ä¸‹ã«ç§»å‹•ï¼‰ -->
<div class="right-sidebar" style="display: flex; gap: 15px; margin-top: 5px;">
  <!-- å·¦åˆ—: è‰² -->
  <div class="pen-colors-vertical" style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
    <h4 style="margin: 0; font-size: 16px; color: #333;">è‰²</h4>
    <button class="color-btn selected" style="background: black; width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ccc;" onclick="setPenColor('black')"></button>
    <button class="color-btn" style="background: red; width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ccc;" onclick="setPenColor('red')"></button>
    <button class="color-btn" style="background: blue; width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ccc;" onclick="setPenColor('blue')"></button>
    <button class="color-btn" style="background: green; width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ccc;" onclick="setPenColor('green')"></button>
  </div>
  
  <!-- å³åˆ—: å¤ªã• -->
  <div class="pen-thickness-vertical" style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
    <h4 style="margin: 0; font-size: 16px; color: #333;">å¤ªã•</h4>
    <button class="thickness-btn" onclick="setPenThickness(10)" title="å¤ªã„ (+30%)" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ccc; background: white; display: flex; align-items: center; justify-content: center;">
      <div style="width: 21px; height: 21px; border-radius: 50%; background: #333;"></div>
    </button>
    <button class="thickness-btn" onclick="setPenThickness(8)" title="æ¨™æº–" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ccc; background: white; display: flex; align-items: center; justify-content: center;">
      <div style="width: 16px; height: 16px; border-radius: 50%; background: #333;"></div>
    </button>
    <button class="thickness-btn selected" onclick="setPenThickness(6)" title="ç´°ã„ (-25%)" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid #333; background: white; display: flex; align-items: center; justify-content: center;">
      <div style="width: 12px; height: 12px; border-radius: 50%; background: #333;"></div>
    </button>
    <button class="thickness-btn" onclick="setPenThickness(4)" title="ã¨ã¦ã‚‚ç´°ã„ (-50%)" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ccc; background: white; display: flex; align-items: center; justify-content: center;">
      <div style="width: 8px; height: 8px; border-radius: 50%; background: #333;"></div>
    </button>
  </div>
</div>
</div>

<!-- èƒŒæ™¯é¸æŠã¯DevToolã«ç§»å‹• -->
<div class="button-group">
  <button onclick="toggleDevTools()" style="background-color: #FFA500; color: white;">ğŸ”§ Dev Tool</button>
</div>

<div id="devTools" style="display: none; border: 2px solid orange; padding: 10px; margin-top: 10px;">
  <h3>é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«</h3>
  
  <div class="button-group">
    <label>ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºèª¿æ•´:</label>
    <input type="range" id="canvasScale" min="0.1" max="3.0" step="0.05" value="1.4" oninput="updateCanvasScale(this.value)">
    <span id="canvasScaleValue">1.4x</span>
  </div>
  
  <div class="button-group">
    <label>ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹å¾…æ©Ÿæ™‚é–“ï¼ˆç§’ï¼‰:</label>
    <input type="range" id="animationStartWait" min="0.1" max="10" step="0.1" value="0.1" oninput="updateAnimationStartWait(this.value)">
    <span id="animationStartWaitValue">0.1ç§’</span>
  </div>
  
  <div class="button-group">
    <label>å›è»¢å¾Œå¾…æ©Ÿæ™‚é–“ï¼ˆç§’ï¼‰:</label>
    <input type="range" id="rotationWait" min="1" max="10" step="0.5" value="1.0" oninput="updateRotationWait(this.value)">
    <span id="rotationWaitValue">1.0ç§’</span>
  </div>
  
  <div class="button-group">
    <label>ğŸµ éŸ³æ¥½ãƒœãƒªãƒ¥ãƒ¼ãƒ ï¼ˆèƒŒæ™¯5ï¼‰:</label>
    <input type="range" id="musicVolume" min="0" max="1" step="0.05" value="0.5" oninput="updateMusicVolume(this.value)">
    <span id="musicVolumeValue">50%</span>
  </div>
  
  <div class="button-group">
    <label>ğŸ–¨ï¸ å°åˆ·é…å»¶æ™‚é–“ï¼ˆç§’ï¼‰:</label>
    <input type="range" id="printDelay" min="0" max="10" step="0.5" value="5.0" oninput="updatePrintDelay(this.value)">
    <span id="printDelayValue">5.0ç§’</span>
  </div>
  
  <div class="button-group">
    <label>èƒŒæ™¯5å‹•ç”»ãƒ‘ã‚¿ãƒ¼ãƒ³:</label>
    <button id="pattern1Btn" onclick="setVideoPattern(1)" style="background: #4CAF50; color: white;">ãƒ‘ã‚¿ãƒ¼ãƒ³1(å›è»¢)</button>
    <button id="pattern2Btn" class="selected" onclick="setVideoPattern(2)" style="background: #2196F3; color: white;">ãƒ‘ã‚¿ãƒ¼ãƒ³2(ãƒ•ã‚§ãƒ¼ãƒ‰)</button>
  </div>
  
  <div class="button-group">
    <button onclick="sendDevSettings()">è¨­å®šã‚’å—ä¿¡å´ã«é€ä¿¡</button>
  </div>
  
  <div class="button-group">
    <label>èƒŒæ™¯é¸æŠ:</label>
    <button onclick="setBackground('./back3.png')">èƒŒæ™¯1</button>
    <button onclick="setBackground('./back2.png')">èƒŒæ™¯2</button>
    <button onclick="setBackground('./back4.png')">èƒŒæ™¯3</button>
    <button onclick="setBackground('./back6.png')">èƒŒæ™¯4</button>
    <button onclick="setBackgroundDev()" style="background: #ffc0cb;">èƒŒæ™¯5(dev)</button>
    <button onclick="setBackground(null)">ç™½</button>
    <button onclick="setSpecialBackgroundToggle()" style="background: linear-gradient(45deg, #ff1493, #00ffff); color: white;">ğŸ¬ å‹•ç”»èƒŒæ™¯</button>
  </div>
  
  <hr style="margin: 15px 0;">
  
  <div class="button-group">
    <label>ãƒ†ã‚¹ãƒˆæ¼”å‡º:</label>
    <button onclick="createFireworks()" style="background: linear-gradient(45deg, #ff4500, #ffd700); color: white;">ğŸ† èŠ±ç«ãƒ†ã‚¹ãƒˆ</button>
    <button onclick="createConfetti()" style="background: linear-gradient(45deg, #ff69b4, #00fa9a); color: white;">ğŸŠ ç´™å¹é›ªãƒ†ã‚¹ãƒˆ</button>
  </div>
  
  <div class="button-group">
    <label>ãƒ“ãƒ‡ã‚ªã‚µã‚¤ã‚º:</label>
    <button id="size100Btn" class="selected" onclick="setVideoSize(100)">100%</button>
    <button id="size90Btn" onclick="setVideoSize(90)">90%</button>
    <button id="size80Btn" onclick="setVideoSize(80)">80%</button>
  </div>
  
  <div class="button-group">
    <button onclick="playVideo()" style="background-color: #FF6B6B; color: white;">ğŸ“¹ ãƒ“ãƒ‡ã‚ªå†ç”Ÿ</button>
  </div>
  
  <div class="button-group">
    <label>ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ:</label>
    <input type="checkbox" id="starEffect" onchange="toggleStarEffect()">
    <label for="starEffect">æ˜Ÿ</label>
    <input type="checkbox" id="fairyDustEffect" onchange="toggleFairyDustEffect()">
    <label for="fairyDustEffect">å¦–ç²¾ã®ç²‰</label>
    <input type="checkbox" id="heartEffect" onchange="toggleHeartEffect()">
    <label for="heartEffect">ğŸ’– ãƒãƒ¼ãƒˆ</label>
    <input type="checkbox" id="penSoundEffect" onchange="togglePenSound()">
    <label for="penSoundEffect">ğŸµ ãƒšãƒ³éŸ³</label>
  </div>
  
  <div class="button-group">
    <label>é€ä¿¡å¾Œæ¼”å‡º:</label>
    <input type="checkbox" id="fireworksEffect" checked>
    <label for="fireworksEffect">ğŸ† èŠ±ç«</label>
    <input type="checkbox" id="confettiEffect" checked>
    <label for="confettiEffect">ğŸŠ ç´™å¹é›ª</label>
    <input type="checkbox" id="backgroundDebug" onchange="toggleBackgroundDebug()">
    <label for="backgroundDebug">ğŸ” èƒŒæ™¯ãƒ‡ãƒãƒƒã‚°</label>
    <input type="checkbox" id="videoPlayback" checked onchange="toggleVideoPlayback()">
    <label for="videoPlayback">ğŸ¬ æ˜ åƒå†ç”Ÿ</label>
  </div>
  
  <div class="button-group">
    <label>ç”¨ç´™ã‚µã‚¤ã‚º:</label>
    <button id="a4Btn" class="selected" onclick="setPaperSize('A4')">A4</button>
    <button id="lBtn" onclick="setPaperSize('L')">Låˆ¤</button>
    <button id="posterBtn" onclick="setPaperSize('poster')">ãƒã‚¹ãƒˆã‚«ãƒ¼ãƒ‰</button>
  </div>
  
  <div class="button-group">
    <label>å°åˆ·ãƒ¢ãƒ¼ãƒ‰:</label>
    <button id="drawOnlyBtn" class="selected" onclick="setPrintMode('drawOnly')">æç”»ãƒ¢ãƒ¼ãƒ‰</button>
    <button id="fullModeBtn" onclick="setPrintMode('fullMode')">ãƒ•ãƒ«ãƒ¢ãƒ¼ãƒ‰</button>
  </div>
  
  <hr style="margin: 15px 0;">
  
  <div class="button-group">
    <label>SwitchBot:</label>
    <input type="checkbox" id="switchBotEffect">
    <label for="switchBotEffect">ğŸ¤– ãƒãƒ–ãƒ«</label>
  </div>
  
  <div class="button-group">
    <button onclick="testSwitchBot()" style="background-color: #FF6B35; color: white;">ğŸ¤– Botãƒ†ã‚¹ãƒˆ</button>
  </div>
  
  <div class="button-group">
    <label>åº§æ¨™ãƒ†ã‚¹ãƒˆ:</label>
    <button onclick="testDrawRightBottom()" style="background-color: #FF1493; color: white;">ãƒ†ã‚¹ãƒˆå³ä¸‹</button>
  </div>
</div>

<div id="countdown"></div>

<!-- ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±è¡¨ç¤º (å·¦ä¸‹å›ºå®š) -->
<div id="versionInfo" style="
  position: fixed;
  bottom: 10px;
  left: 10px;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 12px;
  font-family: monospace;
  z-index: 9999;
  pointer-events: none;
">
  <div>Canvas Drawing Fix v2.1.0</div>
  <div id="writerStatus">Writer ID: æœªå‰²ã‚Šå½“ã¦</div>
</div>

<script>
// ===========================
// ğŸ—ï¸ DOM CACHE SYSTEM - DOMè¦ç´ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ 
// ===========================

class DOMCache {
  constructor() {
    this.cache = new Map();
    this.contextCache = new Map();
  }
  
  // è¦ç´ ã‚’å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨ï¼‰
  getElementById(id) {
    if (!this.cache.has(id)) {
      const element = document.getElementById(id);
      if (element) {
        this.cache.set(id, element);
      }
    }
    return this.cache.get(id);
  }
  
  // Canvas contextã‚’å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨ï¼‰
  getContext(canvasId, contextType = '2d') {
    const key = `${canvasId}_${contextType}`;
    if (!this.contextCache.has(key)) {
      const canvas = this.getElementById(canvasId);
      if (canvas && canvas.getContext) {
        const context = canvas.getContext(contextType);
        this.contextCache.set(key, context);
      }
    }
    return this.contextCache.get(key);
  }
  
  // è¦ç´ ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
  clearCache(id) {
    this.cache.delete(id);
    // Contexté–¢é€£ã‚‚ã‚¯ãƒªã‚¢
    for (const key of this.contextCache.keys()) {
      if (key.startsWith(id + '_')) {
        this.contextCache.delete(key);
      }
    }
  }
  
  // å…¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
  clearAll() {
    this.cache.clear();
    this.contextCache.clear();
    console.log('ğŸ—ï¸ DOMã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢');
  }
  
  // ãƒãƒƒãƒå–å¾—ï¼ˆè¤‡æ•°è¦ç´ ã‚’ä¸€åº¦ã«å–å¾—ï¼‰
  getElements(ids) {
    const result = {};
    for (const id of ids) {
      result[id] = this.getElementById(id);
    }
    return result;
  }
}

// DOMCacheã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
const domCache = new DOMCache();

// ã‚ˆãä½¿ã†è¦ç´ ã‚’äº‹å‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥
const canvas = domCache.getElementById("drawCanvas");
const ctx = domCache.getContext("drawCanvas", "2d");
let drawing = false;
let socket = new WebSocket("wss://realtime-sign-server-1.onrender.com");
// [WriterManagerã«ç§»è¡Œæ¸ˆã¿] myWriterId
let otherWritersData = {}; // ä»–ã®åŸ·ç­†è€…ã®ãƒ‡ãƒ¼ã‚¿

// æç”»çŠ¶æ…‹ç®¡ç†ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let isPaintDrawing = false;
let lastPaintPos = null;

// èƒŒæ™¯ç”»åƒã®ç¯„å›²ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰
let mySessionId = null; // ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºæœ‰ID
let backgroundImage = null;
let currentPaperSize = "A4"; // ç¾åœ¨ã®ç”¨ç´™ã‚µã‚¤ã‚º
let currentPrintMode = "drawOnly"; // ç¾åœ¨ã®å°åˆ·ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šæç”»ãƒ¢ãƒ¼ãƒ‰ï¼‰
let currentVideoSize = 100; // ç¾åœ¨ã®ãƒ“ãƒ‡ã‚ªã‚µã‚¤ã‚ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ100%ï¼‰
let canvasScale = 1.4; // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¹ã‚±ãƒ¼ãƒ«
// ===========================
// ğŸ“‹ UNIFIED SETTINGS OBJECT - è¨­å®šå€¤çµ±ä¸€ç®¡ç†
// ===========================
const APP_SETTINGS = {
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
  animationStartWaitTime: 0.1,  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹å¾…æ©Ÿæ™‚é–“ï¼ˆç§’ï¼‰
  rotationWaitTime: 1.0,         // å›è»¢å¾Œå¾…æ©Ÿæ™‚é–“ï¼ˆç§’ï¼‰
  currentVideoPattern: 2,        // èƒŒæ™¯5å‹•ç”»ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ1:å›è»¢, 2:ãƒ•ã‚§ãƒ¼ãƒ‰ï¼‰
  
  // å°åˆ·è¨­å®š
  printDelayTime: 5.0,          // å°åˆ·é…å»¶æ™‚é–“ï¼ˆç§’ï¼‰
  
  // æç”»è¨­å®š
  currentPenThickness: 6,       // ç¾åœ¨ã®ãƒšãƒ³ã®å¤ªã•ï¼ˆç´°ã„ï¼‰
  currentPenColor: 'black',     // ç¾åœ¨ã®ãƒšãƒ³ã®è‰²
  
  // çŠ¶æ…‹ç®¡ç†
  hasSentData: false            // é€ä¿¡æ¸ˆã¿ãƒ•ãƒ©ã‚°
};

// å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã®å‚ç…§ï¼ˆæ®µéšçš„ã«å‰Šé™¤äºˆå®šï¼‰
let animationStartWaitTime = APP_SETTINGS.animationStartWaitTime;
let rotationWaitTime = APP_SETTINGS.rotationWaitTime;
let currentVideoPattern = APP_SETTINGS.currentVideoPattern;
let printDelayTime = APP_SETTINGS.printDelayTime;
let currentPenThickness = APP_SETTINGS.currentPenThickness;
let currentPenColor = APP_SETTINGS.currentPenColor;
let hasSentData = APP_SETTINGS.hasSentData;

// ==========================================
// ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³å…±é€šã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ–°æ©Ÿèƒ½ - æ—¢å­˜æ©Ÿèƒ½ã«ã¯å½±éŸ¿ãªã—ï¼‰
// ==========================================

// ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–¢é€£å®šæ•°
const COUNTDOWN_CONSTANTS = {
  CURTAIN_SECONDS: 3, // ã€Œå¹•ãŒä¸Šã‚‹ã¾ã§ã€ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ç§’æ•°
  SYNC_SECONDS: 5, // åŒæœŸã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ç§’æ•°  
  UNIFIED_WAIT_TIME: 3000, // çµ±ä¸€å¾…æ©Ÿæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
  NETWORK_DELAY: 100, // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ï¼ˆãƒŸãƒªç§’ï¼‰
  SAFETY_MARGIN: 200, // å®‰å…¨ãƒãƒ¼ã‚¸ãƒ³ï¼ˆãƒŸãƒªç§’ï¼‰
  MAX_RECEIVER_CURTAIN_REMAINING: 3000, // å—ä¿¡å´ã€Œå¹•ãŒä¸Šã‚‹ã¾ã§ã€æœ€å¤§æ®‹ã‚Šæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
  TIMEOUT_DURATION: 5000 // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
};

// ===========================
// ğŸ“Š COUNTDOWN SYSTEM - çµ±ä¸€åŒ–å®Ÿè£…
// ===========================
// 
// ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ:
// 1. COUNTDOWN_CONSTANTS: çµ±ä¸€ã•ã‚ŒãŸè¨­å®šå€¤
// 2. getCountdownElements(): DOMè¦ç´ ã‚¢ã‚¯ã‚»ã‚¹çµ±ä¸€åŒ–
// 3. createCountdownNew(): æ±ç”¨ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³å®Ÿè£…
// 4. calculateCountdownTime(): æ™‚é–“è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
// 5. å„ç¨®çŠ¶æ…‹ç®¡ç†é–¢æ•°: hasStartedCurtainCountdownç­‰
// 6. å®Ÿè£…é–¢æ•°ç¾¤: startReceiverCurtainCountdown, startReceiverSyncCountdownç­‰
// 
// ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å®Œäº†é …ç›®:
// âœ… å®šæ•°çµ±ä¸€åŒ– (COUNTDOWN_CONSTANTS)
// âœ… DOMè¦ç´ å–å¾—çµ±ä¸€åŒ– (getCountdownElements) 
// âœ… æ±ç”¨ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–¢æ•°çµ±ä¸€åŒ– (createCountdownNew)
// âœ… å¤ã„å®Ÿè£…ã®å‰Šé™¤ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
// ===========================

// DOMè¦ç´ å–å¾—ã®å…±é€šé–¢æ•°ç¾¤ï¼ˆDOMCacheåˆ©ç”¨ï¼‰
function getCountdownElements() {
  return {
    // ã€Œå¹•ãŒä¸Šã‚‹ã¾ã§ã€ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–¢é€£
    curtainCountdown: domCache.getElementById('curtainCountdown'),
    curtainTimer: domCache.getElementById('curtainTimer'),
    
    // åŒæœŸã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–¢é€£
    syncCountdown: domCache.getElementById('syncCountdown'),
    
    // ã‚¿ã‚¤ãƒãƒ¼é–¢é€£
    countdownTimer: domCache.getElementById('countdownTimer'),
    countdownText: domCache.getElementById('countdownText'),
    
    // è¡¨ç¤ºåˆ¶å¾¡é–¢é€£
    curtainClosedDisplay: domCache.getElementById('curtainClosedDisplay')
  };
}

// æ±ç”¨ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–¢æ•°ï¼ˆæ–°æ©Ÿèƒ½ - ãƒ†ã‚¹ãƒˆç”¨ï¼‰
function createCountdownNew(options) {
  const {
    element,           // è¡¨ç¤ºè¦ç´ 
    seconds,          // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ç§’æ•°
    onTick,          // æ¯ç§’ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ (count) => {}
    onComplete,      // å®Œäº†æ™‚ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ () => {}
    logPrefix = 'â±ï¸', // ãƒ­ã‚°ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹
    showElement = true, // è¦ç´ ã‚’è¡¨ç¤ºã™ã‚‹ã‹
    hideOnComplete = true // å®Œäº†æ™‚ã«è¦ç´ ã‚’éè¡¨ç¤ºã«ã™ã‚‹ã‹
  } = options;

  if (!element) {
    console.log(`âŒ [æ–°] ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
    return null;
  }

  let count = Math.round(seconds);
  console.log(`${logPrefix} [æ–°] ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹: ${count}ç§’`);

  // è¦ç´ ã‚’è¡¨ç¤º
  if (showElement) {
    element.style.display = 'block';
  }
  
  // åˆæœŸè¡¨ç¤º
  element.textContent = count;
  
  // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³å®Ÿè¡Œ
  const interval = setInterval(() => {
    count--;
    if (count > 0) {
      element.textContent = count;
      console.log(`${logPrefix} [æ–°] ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³: ${count}`);
      
      // æ¯ç§’ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
      if (onTick) {
        onTick(count);
      }
    } else {
      // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³çµ‚äº†
      clearInterval(interval);
      console.log(`${logPrefix} [æ–°] ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³çµ‚äº†`);
      
      // è¦ç´ ã‚’éè¡¨ç¤º
      if (hideOnComplete) {
        element.style.display = 'none';
      }
      
      // å®Œäº†ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
      if (onComplete) {
        onComplete();
      }
    }
  }, 1000);

  return interval; // ã‚¿ã‚¤ãƒãƒ¼IDã‚’è¿”ã™
}
// ===========================
// ğŸ‘¤ WRITER MANAGER - WriterIDç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
// ===========================

class WriterManager {
  constructor() {
    this.myWriterId = null;                    // è‡ªåˆ†ã®WriterID
    this.drawingStates = {};                   // WriterIDåˆ¥ã®æç”»çŠ¶æ…‹
    this.activeWriters = new Set();            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªWriterä¸€è¦§
  }
  
  // è‡ªåˆ†ã®WriterIDã‚’è¨­å®š
  setMyWriterId(id) {
    this.myWriterId = id;
    console.log(`ğŸ‘¤ WriterIDè¨­å®š: ${id}`);
  }
  
  // è‡ªåˆ†ã®WriterIDã‚’å–å¾—
  getMyWriterId() {
    return this.myWriterId;
  }
  
  // è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã©ã†ã‹åˆ¤å®š
  isMyMessage(writerId) {
    return writerId === this.myWriterId;
  }
  
  // æç”»çŠ¶æ…‹ã‚’å–å¾—
  getDrawingState(writerId) {
    if (!this.drawingStates[writerId]) {
      this.drawingStates[writerId] = {
        isDrawing: false,
        lastX: null,
        lastY: null,
        lastTimestamp: null
      };
    }
    return this.drawingStates[writerId];
  }
  
  // æç”»çŠ¶æ…‹ã‚’æ›´æ–°
  updateDrawingState(writerId, state) {
    this.drawingStates[writerId] = {
      ...this.getDrawingState(writerId),
      ...state
    };
  }
  
  // æç”»çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
  resetDrawingState(writerId) {
    delete this.drawingStates[writerId];
  }
  
  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªWriterã‚’è¿½åŠ 
  addActiveWriter(writerId) {
    this.activeWriters.add(writerId);
  }
  
  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªWriterã‚’å‰Šé™¤
  removeActiveWriter(writerId) {
    this.activeWriters.delete(writerId);
    this.resetDrawingState(writerId);
  }
  
  // ã™ã¹ã¦ã®Writerã‚’ã‚¯ãƒªã‚¢
  clearAll() {
    this.myWriterId = null;
    this.drawingStates = {};
    this.activeWriters.clear();
    console.log('ğŸ‘¤ WriterManager: ã™ã¹ã¦ã‚¯ãƒªã‚¢');
  }
}

// WriterManagerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
const writerManager = new WriterManager();

// å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã®å‚ç…§ï¼ˆæ®µéšçš„ã«å‰Šé™¤äºˆå®šï¼‰
let myWriterId = null;
const writerDrawingStates = writerManager.drawingStates;

// æç”»ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹é…åˆ—
let drawingCommands = [];

// ç¾åœ¨ã®æ›¸ãæ‰‹ç”¨ã®ãƒ¬ã‚¬ã‚·ãƒ¼å¤‰æ•°ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ä¿æŒï¼‰
let lastPosition = null; // å‰å›ã®ä½ç½®ã‚’è¨˜éŒ²
let currentPath = []; // ç¾åœ¨ã®ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã®ãƒã‚¤ãƒ³ãƒˆé…åˆ—
// [å‰Šé™¤] smoothingFactor - æœªä½¿ç”¨å¤‰æ•°ã‚’å‰Šé™¤

// ãƒ™ã‚¸ã‚§æ›²ç·šè£œé–“ç”¨ã®ç‚¹å±¥æ­´
let pointHistory = []; // æœ€æ–°3ç‚¹ã‚’ä¿æŒã—ã¦ãƒ™ã‚¸ã‚§æ›²ç·šã‚’æç”»
const MAX_POINT_HISTORY = 3; // ä¿æŒã™ã‚‹ç‚¹ã®æœ€å¤§æ•°
let starEffectEnabled = false; // æ˜Ÿã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®æœ‰åŠ¹/ç„¡åŠ¹ï¼ˆæ¨™æº–ã§OFFï¼‰
let fairyDustEffectEnabled = false; // å¦–ç²¾ã®ç²‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®æœ‰åŠ¹/ç„¡åŠ¹ï¼ˆæ¨™æº–ã§OFFï¼‰
let heartEffectEnabled = false; // ãƒãƒ¼ãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®æœ‰åŠ¹/ç„¡åŠ¹ï¼ˆæ¨™æº–ã§OFFï¼‰- æç”»æ™‚ã®ãƒãƒ¼ãƒˆã¯éè¡¨ç¤º
let penSoundEnabled = false; // ãƒšãƒ³éŸ³ã®æœ‰åŠ¹/ç„¡åŠ¹ï¼ˆæ¨™æº–ã§OFFï¼‰
let specialBackgroundState = 'ready'; // 'ready', 'door_shown', 'door_opened'
let specialBackgroundToggle = false; // ç‰¹æ®ŠèƒŒæ™¯ã®ç”»åƒã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ãƒ•ãƒ©ã‚°

// ğŸ¬ é€ä¿¡å´å‹•ç”»èƒŒæ™¯é–¢é€£å¤‰æ•°
let senderVideoElement = null;
let isSenderVideoActive = false;

// ğŸµ ãƒšãƒ³éŸ³åˆ¶å¾¡
let drawingAudio = null; // æç”»ä¸­ã®éŸ³æ¥½ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
let isDrawingActive = false; // æç”»ä¸­ãƒ•ãƒ©ã‚°
let drawingInactiveTimer = null; // æç”»åœæ­¢ã‚¿ã‚¤ãƒãƒ¼
const DRAWING_PAUSE_DELAY = 500; // æç”»åœæ­¢ã‹ã‚‰ä¸€æ™‚åœæ­¢ã¾ã§ã®é…å»¶ï¼ˆãƒŸãƒªç§’ï¼‰

// ğŸ” èƒŒæ™¯ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºåˆ¶å¾¡
let backgroundDebugEnabled = false;
let lastBackgroundSrc = null;

// èƒŒæ™¯åˆ¥ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºè¨­å®šï¼ˆ1.02å€ã‚µã‚¤ã‚º = 0.6*1.7ï¼‰
const backgroundSizes = {
  'back3': { width: 859, height: 607 },    // èƒŒæ™¯1 - çµ±ä¸€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯” (859/607 â‰ˆ 1.415)
  'back2': { width: 859, height: 607 },    // èƒŒæ™¯2 - çµ±ä¸€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã«å¤‰æ›´
  'back4': { width: 859, height: 607 },    // èƒŒæ™¯3 - çµ±ä¸€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”
  'back5': { width: 859, height: 607 },    // èƒŒæ™¯5 - çµ±ä¸€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”
  'back6': { width: 859, height: 607 },    // èƒŒæ™¯4 - çµ±ä¸€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”
  'white': { width: 859, height: 607 }     // ç™½èƒŒæ™¯ - çµ±ä¸€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”
};

// ğŸš€ éä¾µå…¥çš„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼
// æ—¢å­˜æ©Ÿèƒ½ã‚’ä¸€åˆ‡å¤‰æ›´ã›ãšã€è¿½åŠ ã®ã¿ã§æœ€é©åŒ–
let performanceOptimizer = {
  lastMouseTime: 0,
  lastTouchTime: 0,
  pendingEffects: [],
  effectAnimationId: null,
  MOUSE_THROTTLE_INTERVAL: 16, // PCç”¨: 60fpsç›¸å½“
  TOUCH_THROTTLE_INTERVAL: 8,  // Redmi Pad 2è»½é‡åŒ–: 360Hzâ†’120Hzç›¸å½“ï¼ˆ125fpsï¼‰
  
  // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ãƒã‚§ãƒƒã‚¯ï¼ˆPCç”¨ï¼‰
  shouldProcessMouseEvent() {
    const now = Date.now();
    if (now - this.lastMouseTime < this.MOUSE_THROTTLE_INTERVAL) {
      return false;
    }
    this.lastMouseTime = now;
    return true;
  },
  
  // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ãƒã‚§ãƒƒã‚¯ï¼ˆRedmi Pad 2æœ€é©åŒ–ï¼‰
  shouldProcessTouchEvent() {
    const now = Date.now();
    if (now - this.lastTouchTime < this.TOUCH_THROTTLE_INTERVAL) {
      return false;
    }
    this.lastTouchTime = now;
    return true;
  },
  
  // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå‡¦ç†ã®éºå»¶å®Ÿè¡Œ
  scheduleEffect(effectFunction) {
    this.pendingEffects.push(effectFunction);
    if (!this.effectAnimationId) {
      this.effectAnimationId = requestAnimationFrame(() => {
        // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ãƒãƒƒãƒå‡¦ç†
        for (const effect of this.pendingEffects) {
          if (Math.random() < 0.3) { // 30%ã®ç¢ºç‡ã§å®Ÿè¡Œï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹èª¿æ•´ï¼‰
            effect();
          }
        }
        this.pendingEffects = [];
        this.effectAnimationId = null;
      });
    }
  }
};

socket.onopen = () => {
  console.log("âœ… WebSocketæ¥ç¶šå®Œäº†ï¼ˆé€ä¿¡å´ï¼‰");
  
  // å°‘ã—å¾…ã£ã¦ã‹ã‚‰writer ID ã‚’è¦æ±‚ï¼ˆå—ä¿¡å´ã®æº–å‚™å®Œäº†ã‚’å¾…ã¤ï¼‰
  setTimeout(() => {
    console.log("ğŸ”„ WriterIDè¦æ±‚ã‚’é–‹å§‹");
    requestWriterId();
    
    // åˆæœŸèƒŒæ™¯ç”»åƒã®è¨­å®šã¯WriterIDå‰²ã‚Šå½“ã¦å®Œäº†å¾Œã«å®Ÿè¡Œã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯å‰Šé™¤
    console.log('â³ WriterIDå‰²ã‚Šå½“ã¦å¾…ã¡ - èƒŒæ™¯ç”»åƒé€ä¿¡ã¯WriterIDå–å¾—å¾Œã«å®Ÿè¡Œ');
    
    // åˆæœŸDevè¨­å®šã‚’å—ä¿¡å´ã«é€ä¿¡
    setTimeout(() => {
      console.log('ğŸ“¤ åˆæœŸDevè¨­å®šã‚’å—ä¿¡å´ã«é€ä¿¡');
      sendDevSettings();
    }, 1000); // WriterIDå–å¾—å¾Œã«é€ä¿¡
  }, 500);
};

socket.onmessage = (event) => {
  try {
    let data;
    
    // Blobã®å ´åˆã¯æ–‡å­—åˆ—ã¨ã—ã¦èª­ã¿å–ã‚‹
    if (event.data instanceof Blob) {
      const reader = new FileReader();
      reader.onload = function() {
        try {
          data = JSON.parse(reader.result);
          processMessage(data);
        } catch (error) {
          console.error('âŒ Blobãƒ‡ãƒ¼ã‚¿ã®è§£æã‚¨ãƒ©ãƒ¼:', error);
        }
      };
      reader.readAsText(event.data);
      return;
    } else {
      // æ–‡å­—åˆ—ã®å ´åˆ
      data = JSON.parse(event.data);
      processMessage(data);
    }
  } catch (error) {
    console.error('âŒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
  }
};

// ===========================
// ğŸ“¡ WEBSOCKET MESSAGE HANDLERS - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒãƒƒãƒ—
// ===========================

const MESSAGE_HANDLERS = {
  // ã€Œå¹•ãŒä¸Šã‚‹ã¾ã§ã€ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  'curtain-countdown': function(data) {
    console.log('ğŸ“¡ ã€Œå¹•ãŒä¸Šã‚‹ã¾ã§ã€ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³æŒ‡ç¤ºã‚’å—ä¿¡:', data);
    
    const curtainSeconds = data.countdown || 3;
    const isMyMessage = writerManager.isMyMessage(data.writerId);
    const hasStarted = hasStartedCurtainCountdown();
    
    console.log(`ğŸ” è©³ç´°åˆ¤å®š: writerId=${data.writerId}, myWriterId=${writerManager.getMyWriterId()}, isMyMessage=${isMyMessage}, hasStarted=${hasStarted}`);
    
    if (isMyMessage && hasStarted) {
      console.log('ğŸ“¡ ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ãŸé€ä¿¡å´: æ—¢ã«canvas-background.jsã§ã€Œå¹•ãŒä¸Šã‚‹ã¾ã§ã€è¡¨ç¤ºæ¸ˆã¿');
    } else if (isMyMessage && !hasStarted) {
      console.log('ğŸ“¡ ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ã„ãªã„é€ä¿¡å´: canvas-background.jsã§ã®ã¿è¡¨ç¤ºï¼ˆé‡è¤‡å›é¿ï¼‰');
    } else {
      console.log('ğŸ“¡ å—ä¿¡å´: ã€Œå¹•ãŒä¸Šã‚‹ã¾ã§ã€ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹');
      startReceiverCurtainCountdown(curtainSeconds);
    }
  },
  
  // 5ç§’ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  'five-second-countdown': function(data) {
    console.log('ğŸ“¡ 5ç§’ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³æŒ‡ç¤ºã‚’å—ä¿¡:', data);
    
    const fiveSeconds = data.countdown || 5;
    const isStartButtonPresser = writerManager.isMyMessage(data.writerId) && hasStartedCurtainCountdown();
    
    if (isStartButtonPresser) {
      console.log('ğŸ“¡ ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ãŸé€ä¿¡å´: è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ç„¡è¦–ï¼ˆè¨ˆç®—ãƒ™ãƒ¼ã‚¹ã§æ—¢ã«é–‹å§‹æ¸ˆã¿ï¼‰');
    } else {
      console.log('ğŸ“¡ å—ä¿¡å´ãƒ»ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ã„ãªã„é€ä¿¡å´: çµ±ä¸€ã•ã‚ŒãŸ3ç§’å¾…æ©Ÿå¾Œã«5ç§’ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹');
      const unifiedWaitTime = 3000;
      
      setTimeout(() => {
        console.log('ğŸ“¡ çµ±ä¸€å¾…æ©Ÿçµ‚äº†: 5ç§’ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹');
        startReceiverSyncCountdown(fiveSeconds);
      }, unifiedWaitTime);
    }
  },
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  'global-countdown-start': function(data) {
    console.log('ğŸ“¡ å…¨ä½“ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹æŒ‡ç¤ºã‚’å—ä¿¡:', data);
    
    if (writerManager.isMyMessage(data.writerId)) {
      console.log('ğŸ“¡ è‡ªåˆ†ãŒé€ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãŸã‚ç„¡è¦–');
      return;
    }
    
    console.log('ğŸ“¡ ã€Œå¹•ãŒä¸Šã‚‹ã¾ã§ã€ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’å„ªå…ˆã™ã‚‹ãŸã‚ã€global-countdown-startã‚’ç„¡è¦–');
    
    const curtainClosedElement = domCache.getElementById('curtainClosedDisplay');
    if (curtainClosedElement) {
      curtainClosedElement.style.display = 'none';
      console.log('ğŸ“¡ ã€Œå¹•ãŒé–‰ã˜ã¦ã„ã¾ã™ã€ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
    }
  }
};

// WebSocketãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†é–¢æ•°ï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿æ¸ˆã¿ï¼‰
function processMessage(data) {
  console.log('ğŸ” processMessageå‘¼ã³å‡ºã—:', data.type, data);
  
  // drawã‚¿ã‚¤ãƒ—ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒãƒƒãƒ—ã§å‡¦ç†
  if (data.type === 'draw' && data.action) {
    const handler = MESSAGE_HANDLERS[data.action];
    if (handler) {
      handler(data);
      return;
    }
  }
  
  // é€šå¸¸ã®drawãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚„ãã®ä»–ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯websocket.jsã«è»¢é€
  if (typeof handleWebSocketMessage === 'function') {
    handleWebSocketMessage(data);
  } else {
    console.log('ğŸ” handleWebSocketMessageé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }
  
  // å¾“æ¥ã®å½¢å¼ã‚‚å‡¦ç†ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
  if (data.type === 'global-countdown-start') {
    // ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒãƒƒãƒ—ã‚’ä½¿ç”¨
    MESSAGE_HANDLERS['global-countdown-start'](data);
    
    // è¿½åŠ å‡¦ç†: ã‚¿ã‚¤ãƒŸãƒ³ã‚°ä»˜ãã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
    const countdownTime = data.totalTime;
    const delay = data.delay || 0;
    
    if (countdownTime) {
      setTimeout(() => {
        console.log(`ğŸ“¡ å¾“æ¥å½¢å¼ã§åŒæœŸã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹ï¼ˆ${countdownTime}ç§’ï¼‰`);
        startReceiverSyncCountdown(countdownTime);
      }, delay);
      console.log(`ğŸ“¡ ${delay}mså¾Œã«ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹äºˆå®š`);
    }
  }
}

// ä¸è¦ãªã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡¨ç¤ºæ©Ÿèƒ½ã‚’å‰Šé™¤ - ã‚·ãƒ³ãƒ—ãƒ«ãªUIã«çµ±ä¸€

// ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºã¨æ©Ÿèƒ½åˆ‡ã‚Šæ›¿ãˆã‚·ã‚¹ãƒ†ãƒ 
const DeviceManager = {
  // ãƒ‡ãƒã‚¤ã‚¹ã‚¿ã‚¤ãƒ—ã‚’æ¤œå‡º
  detectDevice() {
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;
    const touchSupport = 'ontouchstart' in window;
    const screenWidth = window.screen.width;
    const screenHeight = window.screen.height;
    const maxTouchPoints = navigator.maxTouchPoints || 0;
    
    // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆåˆ¤å®š
    const isTablet = (
      touchSupport &&
      maxTouchPoints > 1 &&
      (screenWidth >= 768 || screenHeight >= 768) &&
      (screenWidth <= 1024 || screenHeight <= 1024)
    ) || (
      /iPad|Android(?!.*Mobile)|Tablet/i.test(userAgent)
    );
    
    // ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³åˆ¤å®š
    const isMobile = (
      touchSupport &&
      !isTablet &&
      /Android|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)
    );
    
    // PCåˆ¤å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
    const isPC = !isTablet && !isMobile;
    
    return {
      isPC,
      isTablet,
      isMobile,
      touchSupport,
      screenWidth,
      screenHeight,
      maxTouchPoints,
      userAgent: userAgent.substring(0, 100) // ãƒ­ã‚°ç”¨ã«çŸ­ç¸®
    };
  },
  
  // ãƒ‡ãƒã‚¤ã‚¹åˆ¥è¨­å®šã‚’é©ç”¨
  applyDeviceSettings() {
    const device = this.detectDevice();
    console.log('ğŸ” ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºçµæœ:', device);
    
    if (device.isPC) {
      this.applyPCSettings();
    } else if (device.isTablet) {
      this.applyTabletSettings();
    } else if (device.isMobile) {
      this.applyMobileSettings();
    }
    
    return device;
  },
  
  // PCç”¨è¨­å®š
  applyPCSettings() {
    console.log('ğŸ’» PCè¨­å®šã‚’é©ç”¨');
    
    // PCç”¨ã®ç‰¹åˆ¥ãªè¨­å®š
    const canvas = domCache.getElementById('drawCanvas');
    if (canvas) {
      // PCã§ã¯ãƒã‚¦ã‚¹æ“ä½œã‚’æœ€é©åŒ–
      canvas.style.cursor = 'crosshair';
    }
    
    // PCç”¨UIã®èª¿æ•´
    document.body.classList.add('device-pc');
    document.body.classList.remove('device-tablet', 'device-mobile');
    
    // PCå°‚ç”¨æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
    this.enablePCFeatures();
  },
  
  // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨è¨­å®š
  applyTabletSettings() {
    console.log('ğŸ“± ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆè¨­å®šã‚’é©ç”¨');
    
    // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ã®ç‰¹åˆ¥ãªè¨­å®š
    const canvas = domCache.getElementById('drawCanvas');
    if (canvas) {
      // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã¯ã‚¿ãƒƒãƒæ“ä½œã‚’æœ€é©åŒ–
      canvas.style.cursor = 'none'; // ã‚«ãƒ¼ã‚½ãƒ«éè¡¨ç¤º
    }
    
    // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨UIã®èª¿æ•´
    document.body.classList.add('device-tablet');
    document.body.classList.remove('device-pc', 'device-mobile');
    
    // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå°‚ç”¨æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
    this.enableTabletFeatures();
  },
  
  // ãƒ¢ãƒã‚¤ãƒ«ç”¨è¨­å®š
  applyMobileSettings() {
    console.log('ğŸ“± ãƒ¢ãƒã‚¤ãƒ«è¨­å®šã‚’é©ç”¨');
    
    // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ç‰¹åˆ¥ãªè¨­å®š
    const canvas = domCache.getElementById('drawCanvas');
    if (canvas) {
      canvas.style.cursor = 'none';
    }
    
    // ãƒ¢ãƒã‚¤ãƒ«ç”¨UIã®èª¿æ•´
    document.body.classList.add('device-mobile');
    document.body.classList.remove('device-pc', 'device-tablet');
    
    // ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
    this.enableMobileFeatures();
  },
  
  // PCå°‚ç”¨æ©Ÿèƒ½
  enablePCFeatures() {
    // PCç”¨ã®è©³ç´°ãªDevToolsã‚’è¡¨ç¤º
    const devButton = document.getElementById('devButton');
    if (devButton) {
      devButton.style.display = 'block';
    }
    
    // PCç”¨ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’æœ‰åŠ¹åŒ–
    this.enableKeyboardShortcuts();
  },
  
  // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå°‚ç”¨æ©Ÿèƒ½
  enableTabletFeatures() {
    // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ã®å¤§ããªãƒœã‚¿ãƒ³
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => {
      if (!btn.classList.contains('color-btn') && !btn.classList.contains('thickness-btn')) {
        btn.style.minHeight = '50px';
        btn.style.fontSize = '16px';
      }
    });
    
    // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ã®ã‚¿ãƒƒãƒæœ€é©åŒ–
    this.optimizeForTouch();
  },
  
  // ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨æ©Ÿèƒ½
  enableMobileFeatures() {
    // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®è¶…å¤§ããªãƒœã‚¿ãƒ³
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => {
      if (!btn.classList.contains('color-btn') && !btn.classList.contains('thickness-btn')) {
        btn.style.minHeight = '60px';
        btn.style.fontSize = '18px';
      }
    });
    
    // DevToolsã‚’éè¡¨ç¤ºï¼ˆç”»é¢ãŒå°ã•ã„ãŸã‚ï¼‰
    const devButton = document.getElementById('devButton');
    if (devButton) {
      devButton.style.display = 'none';
    }
  },
  
  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆPCå°‚ç”¨ï¼‰
  enableKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
          case 'z':
            e.preventDefault();
            // Undoæ©Ÿèƒ½ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
            console.log('âŒ¨ï¸ Undo shortcut (PC only)');
            break;
          case 's':
            e.preventDefault();
            // Saveæ©Ÿèƒ½
            console.log('âŒ¨ï¸ Save shortcut (PC only)');
            break;
        }
      }
    });
  },
  
  // ã‚¿ãƒƒãƒæœ€é©åŒ–ï¼ˆã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ/ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨ï¼‰
  optimizeForTouch() {
    // ã‚¿ãƒƒãƒé…å»¶ã‚’å‰Šé™¤
    const style = document.createElement('style');
    style.textContent = `
      .device-tablet button, .device-mobile button {
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        touch-action: manipulation;
      }
      
      .device-tablet .pen-controls, .device-mobile .pen-controls {
        gap: 15px;
      }
    `;
    document.head.appendChild(style);
  }
};
socket.onerror = (error) => console.error("âŒ WebSocketã‚¨ãƒ©ãƒ¼ï¼ˆé€ä¿¡å´ï¼‰:", error);
socket.onclose = (event) => {
  console.log("âš ï¸ WebSocketåˆ‡æ–­ï¼ˆé€ä¿¡å´ï¼‰:", event.code, event.reason);
  console.log("ğŸ§¹ åˆ‡æ–­å‰ã®çŠ¶æ…‹:", { myWriterId: writerManager.getMyWriterId(), mySessionId });
  
  // æ¥ç¶šåˆ‡æ–­æ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆ
  mySessionId = null;
  writerManager.setMyWriterId(null);  // WriterIDã‚’ã‚¯ãƒªã‚¢
  myWriterId = null;  // å¾Œæ–¹äº’æ›æ€§
  console.log("ğŸ§¹ WebSocketåˆ‡æ–­ã«ä¼´ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆ");
  
  // Writer IDè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
  const statusDiv = document.getElementById('writerStatus');
  if (statusDiv) {
    statusDiv.childNodes[0].textContent = 'Writer ID: æœªå‰²ã‚Šå½“ã¦';
  }
  document.title = 'é€ä¿¡å´ - æœªæ¥ç¶š';
};

// ãƒãƒ¼ãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”Ÿæˆã¯ special-effects.js ã§ç®¡ç†

// ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãƒ»è¨­å®šãƒ»ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–¢æ•°ã¯å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†

// æç”»ã‚¨ãƒ³ã‚¸ãƒ³ã®åˆæœŸåŒ–ã¯ event-handlers.js ã§ç®¡ç†
// æç”»ãƒ‡ãƒ¼ã‚¿ãƒ»ä¿å­˜ãƒ»å°åˆ·æ©Ÿèƒ½ã¯å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†

// èƒŒæ™¯ç”»åƒã®å¤‰å½¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
let backgroundScale = 1.0; // ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆå¤§ãã•ï¼‰
let backgroundOffsetY = 0; // å‚ç›´ã‚ªãƒ•ã‚»ãƒƒãƒˆ

// ===========================
// ğŸ“Š COUNTDOWN CALCULATION & UTILITIES
// ===========================

// ğŸ“Š ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½
let countdownInterval = null;

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼šç¾åœ¨ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³æ™‚é–“ï¼ˆä»–ã®é–¢æ•°ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼‰
let currentCountdownTime = 0;

// ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³æ™‚é–“ã‚’è¨ˆç®—ã™ã‚‹å…±é€šé–¢æ•°
function calculateCountdownTime() {
  let totalTime;
  let calculation;
  
  console.log(`ğŸ“Š [æ™‚é–“è¨ˆç®—] ç¾åœ¨ã®è¨­å®šå€¤:`);
  console.log(`  - animationStartWaitTime: ${APP_SETTINGS.animationStartWaitTime}ç§’`);
  console.log(`  - rotationWaitTime: ${APP_SETTINGS.rotationWaitTime}ç§’`);
  console.log(`  - window.isDevWhiteBackground: ${window.isDevWhiteBackground}`);

  if (window.isDevWhiteBackground) {
    // èƒŒæ™¯5ã®å ´åˆ: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹å¾…æ©Ÿæ™‚é–“ + å‹•ç”»é•· + å—ä¿¡å´ã®çŸ­ç¸®æ¸ˆã¿å›è»¢å¾Œå¾…æ©Ÿæ™‚é–“
    // signVideo.mp4ã®å‹•ç”»é•·ã‚’ä½¿ç”¨ + å—ä¿¡å´ã§ã¯ rotationWaitTime - 3.0ç§’ ãŒé©ç”¨ã•ã‚Œã‚‹
    const videoDuration = 18.6; // signVideo.mp4ã®å®Ÿéš›ã®é•·ã•
    const receiverRotationWaitTime = Math.max(0, APP_SETTINGS.rotationWaitTime - 3.0); // å—ä¿¡å´ã§ã¯3ç§’çŸ­ç¸®ã•ã‚Œã‚‹ï¼ˆæœ€å°0ç§’ï¼‰
    
    console.log(`ğŸ“Š [èƒŒæ™¯5] è©³ç´°è¨ˆç®—:`);
    console.log(`  - videoDuration: ${videoDuration}ç§’`);
    console.log(`  - rotationWaitTime - 3.0 = ${APP_SETTINGS.rotationWaitTime} - 3.0 = ${APP_SETTINGS.rotationWaitTime - 3.0}ç§’`);
    console.log(`  - Math.max(0, ${APP_SETTINGS.rotationWaitTime - 3.0}) = ${receiverRotationWaitTime}ç§’`);
    console.log(`  - è¨ˆç®—å¼: ${APP_SETTINGS.animationStartWaitTime} + ${videoDuration} + ${receiverRotationWaitTime}`);
    
    totalTime = APP_SETTINGS.animationStartWaitTime + videoDuration + receiverRotationWaitTime;
    calculation = `é–‹å§‹å¾…æ©Ÿ:${APP_SETTINGS.animationStartWaitTime}s + å‹•ç”»é•·:${videoDuration}s + å—ä¿¡å´å›è»¢å¾Œå¾…æ©Ÿ:${receiverRotationWaitTime}s`;
  } else {
    // é€šå¸¸èƒŒæ™¯ã®å ´åˆ: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹å¾…æ©Ÿæ™‚é–“ + å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“(1.5s) + å—ä¿¡å´ã®çŸ­ç¸®æ¸ˆã¿å›è»¢å¾Œå¾…æ©Ÿæ™‚é–“
    const receiverRotationWaitTime = Math.max(0, APP_SETTINGS.rotationWaitTime - 3.0); // å—ä¿¡å´ã§ã¯3ç§’çŸ­ç¸®ã•ã‚Œã‚‹ï¼ˆæœ€å°0ç§’ï¼‰
    
    console.log(`ğŸ“Š [é€šå¸¸èƒŒæ™¯] è©³ç´°è¨ˆç®—:`);
    console.log(`  - rotationWaitTime - 3.0 = ${APP_SETTINGS.rotationWaitTime} - 3.0 = ${APP_SETTINGS.rotationWaitTime - 3.0}ç§’`);
    console.log(`  - Math.max(0, ${APP_SETTINGS.rotationWaitTime - 3.0}) = ${receiverRotationWaitTime}ç§’`);
    console.log(`  - è¨ˆç®—å¼: ${APP_SETTINGS.animationStartWaitTime} + 1.5 + ${receiverRotationWaitTime}`);
    
    totalTime = APP_SETTINGS.animationStartWaitTime + 1.5 + receiverRotationWaitTime;
    calculation = `é–‹å§‹å¾…æ©Ÿ:${APP_SETTINGS.animationStartWaitTime}s + å›è»¢:1.5s + å—ä¿¡å´å›è»¢å¾Œå¾…æ©Ÿ:${receiverRotationWaitTime}s`;
  }
  
  console.log(`ğŸ“Š [è¨ˆç®—çµæœ] totalTime = ${totalTime}ç§’ (${calculation})`);
  return totalTime;
}

// [å‰Šé™¤æ¸ˆã¿] startCountdownTimer - ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„å¤ã„å®Ÿè£…

// [å‰Šé™¤æ¸ˆã¿] startReceiverCountdownTimer ã¨ startSyncedCountdownTimer - ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„å¤ã„å®Ÿè£…

// [å‰Šé™¤æ¸ˆã¿] stopCountdownTimer - ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„å¤ã„å®Ÿè£…

// ===========================
// ğŸ“Š COUNTDOWN STATE MANAGEMENT
// ===========================

// ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã‹ã©ã†ã‹ã‚’åˆ¤å®š
function hasStartedCurtainCountdown() {
  // canvas-background.jsã®é–¢æ•°ãŒå­˜åœ¨ã—ã€å®Ÿéš›ã«ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  // startWaitingAnimationé–¢æ•°ãŒå‘¼ã°ã‚ŒãŸã‹ã©ã†ã‹ã§åˆ¤å®š
  const result = typeof startWaitingAnimation !== 'undefined' && window.hasStartedAnimation === true;
  console.log(`ğŸ” hasStartedCurtainCountdown: startWaitingAnimation=${typeof startWaitingAnimation}, hasStartedAnimation=${window.hasStartedAnimation}, result=${result}`);
  return result;
}

// å—ä¿¡å´ã®ã€Œå¹•ãŒä¸Šã‚‹ã¾ã§ã€ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³çµ‚äº†ã¾ã§ã®é…å»¶ã‚’è¨ˆç®—ï¼ˆcanvas-background.jsã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
function calculateReceiverCurtainDelay() {
  // WebSocketé€šä¿¡é…å»¶: ç´„100ms
  const networkDelay = 100;
  
  // å—ä¿¡å´ã®ã€Œå¹•ãŒä¸Šã‚‹ã¾ã§ã€ã¯æœ€å¤§3ç§’æ®‹ã£ã¦ã„ã‚‹å¯èƒ½æ€§
  const maxReceiverCurtainRemaining = 3000; // 3ç§’
  
  // å®‰å…¨ãƒãƒ¼ã‚¸ãƒ³
  const safetyMargin = 200; // 0.2ç§’
  
  const totalDelay = networkDelay + maxReceiverCurtainRemaining + safetyMargin;
  
  console.log(`ğŸ“Š remotesign.htmlé…å»¶è¨ˆç®—: é€šä¿¡${networkDelay}ms + æœ€å¤§å¹•æ®‹ã‚Š${maxReceiverCurtainRemaining}ms + ãƒãƒ¼ã‚¸ãƒ³${safetyMargin}ms = ${totalDelay}ms`);
  
  return totalDelay;
}

// ã€Œå¹•ãŒä¸Šã‚‹ã¾ã§ã€ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³çµ‚äº†ã‚’å¾…ã£ã¦ã‹ã‚‰5ç§’ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’é–‹å§‹
function waitForCurtainEndThenStartCountdown(fiveSeconds) {
  const curtainCountdown = document.getElementById('curtainCountdown');
  
  // ã€Œå¹•ãŒä¸Šã‚‹ã¾ã§ã€ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®çµ‚äº†ã‚’ç›£è¦–
  const checkInterval = setInterval(() => {
    if (!curtainCountdown || curtainCountdown.style.display === 'none') {
      // ã€Œå¹•ãŒä¸Šã‚‹ã¾ã§ã€ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãŒçµ‚äº†ã—ãŸ
      clearInterval(checkInterval);
      console.log('ğŸ“¡ å—ä¿¡å´: ã€Œå¹•ãŒä¸Šã‚‹ã¾ã§ã€çµ‚äº†ã‚’æ¤œçŸ¥ã€5ç§’ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹');
      startReceiverSyncCountdown(fiveSeconds);
    }
  }, 100); // 100msé–“éš”ã§ãƒã‚§ãƒƒã‚¯
  
  // å®‰å…¨ã®ãŸã‚ã€æœ€å¤§5ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
  setTimeout(() => {
    clearInterval(checkInterval);
    console.log('ğŸ“¡ å—ä¿¡å´: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§5ç§’ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’å¼·åˆ¶é–‹å§‹');
    startReceiverSyncCountdown(fiveSeconds);
  }, 5000);
}

// ===========================
// ğŸ“Š COUNTDOWN IMPLEMENTATIONS
// ===========================

// [å‰Šé™¤æ¸ˆã¿] startReceiverCurtainCountdown_OLD - å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Ÿè£…ï¼ˆæ–°å®Ÿè£…ã§ç½®æ›æ¸ˆã¿ï¼‰

// å—ä¿¡å´ç”¨ã®ã€Œå¹•ãŒä¸Šã‚‹ã¾ã§ã€ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–¢æ•°ï¼ˆçµ±ä¸€å®Ÿè£…ä½¿ç”¨ï¼‰
function startReceiverCurtainCountdown(seconds) {
  console.log(`ğŸ­ å—ä¿¡å´ã€Œå¹•ãŒä¸Šã‚‹ã¾ã§ã€ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹: ${seconds}ç§’`);
  
  const elements = getCountdownElements();
  
  if (!elements.curtainCountdown || !elements.curtainTimer) {
    console.log('âŒ å—ä¿¡å´: curtainCountdownè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return;
  }
  
  // curtainCountdownå…¨ä½“ã‚’è¡¨ç¤º
  elements.curtainCountdown.style.display = 'block';
  
  // æ–°ã—ã„ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨
  return createCountdownNew({
    element: elements.curtainTimer,
    seconds: seconds,
    logPrefix: 'ğŸ­ å—ä¿¡å´',
    showElement: false, // curtainCountdownã‚’æ‰‹å‹•ã§è¡¨ç¤ºåˆ¶å¾¡
    hideOnComplete: false, // æ‰‹å‹•ã§éè¡¨ç¤ºåˆ¶å¾¡
    onComplete: () => {
      elements.curtainCountdown.style.display = 'none';
      console.log('ğŸ­ å—ä¿¡å´: å¹•ãŒä¸Šã‚Šã¾ã—ãŸï¼');
    }
  });
}

// å—ä¿¡å´ç”¨ã®åŒæœŸã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–¢æ•°ï¼ˆæ–°å®Ÿè£…ä½¿ç”¨ï¼‰
function startReceiverSyncCountdown(totalTime) {
  console.log(`â±ï¸ [æ–°å®Ÿè£…] å—ä¿¡å´åŒæœŸã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹: ${totalTime}ç§’`);
  
  const elements = getCountdownElements();
  const curtainClosedElement = domCache.getElementById('curtainClosedDisplay');
  
  if (!elements.syncCountdown) {
    console.log('âŒ å—ä¿¡å´: syncCountdownè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return;
  }
  
  // å¹•ãŒé–‰ã˜ã¦ã„ã¾ã™è¡¨ç¤ºã‚’éè¡¨ç¤º
  if (curtainClosedElement) {
    curtainClosedElement.style.display = 'none';
  }
  
  // æ–°ã—ã„çµ±ä¸€ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’ä½¿ç”¨
  createCountdownNew({
    element: elements.syncCountdown,
    seconds: totalTime,
    onTick: (remaining) => {
      console.log(`â±ï¸ å—ä¿¡å´ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³: ${remaining}`);
    },
    onComplete: () => {
      console.log('â±ï¸ å—ä¿¡å´ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³çµ‚äº†');
      // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³çµ‚äº†å¾Œã«å¹•ãŒé–‰ã˜ã¦ã„ã¾ã™è¡¨ç¤ºã‚’å†è¡¨ç¤º
      if (curtainClosedElement) {
        curtainClosedElement.style.display = 'block';
      }
    },
    logPrefix: 'â±ï¸ [å—ä¿¡å´åŒæœŸ]',
    showElement: true,
    hideOnComplete: true
  });
}

// ğŸ¯ ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒ»åˆæœŸåŒ–å‡¦ç† (ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆ, DOMContentLoaded, ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ) ã¯event-handlers.jsã«ç§»å‹•ã—ã¾ã—ãŸ
</script>
</div>

<!-- é‡è¤‡ã—ãŸã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã‚’å‰Šé™¤ -->

</div>

<!-- è¦–è¦šã‚¨ãƒ•ã‚§ã‚¯ãƒˆæ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="effects.js"></script>

<!-- ç‰¹æ®Šã‚¨ãƒ•ã‚§ã‚¯ãƒˆæ©Ÿèƒ½ï¼ˆãƒãƒ¼ãƒˆãƒ»èŠ±ç«ãƒ»ç´™å¹é›ªï¼‰ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="special-effects.js"></script>

<!-- è¨­å®šãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="settings.js"></script>

<!-- WebSocketãƒ»é€šä¿¡æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="websocket.js"></script>

<!-- èƒŒæ™¯ãƒ»ã‚­ãƒ£ãƒ³ãƒã‚¹ç®¡ç†æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="canvas-background.js"></script>
<!-- é€ä¿¡å´å‹•ç”»æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="video-sender.js"></script>
<!-- éŸ³æ¥½ãƒ»éŸ³å£°æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="audio-music.js"></script>
<!-- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ»è¨ˆç®—æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="utils.js"></script>
<!-- æç”»ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="drawing-lines.js"></script>
<!-- æç”»ã‚¨ãƒ³ã‚¸ãƒ³æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="drawing-engine.js"></script>
<!-- å°åˆ·ãƒ»ä¿å­˜æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="print-save.js"></script>
<!-- é–‹ç™ºãƒ„ãƒ¼ãƒ«æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="dev-tools.js"></script>
<!-- UIåˆ¶å¾¡ãƒ»ãƒ†ãƒ¼ãƒæ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="ui-controls.js"></script>
<!-- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒ»åˆæœŸåŒ–æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="event-handlers.js"></script>

</body>
</html>
