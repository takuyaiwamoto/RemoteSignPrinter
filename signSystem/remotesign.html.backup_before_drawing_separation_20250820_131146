<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self' wss://realtime-sign-server-1.onrender.com ws://localhost:* wss://localhost:*; img-src 'self' data: blob:; media-src 'self';">
  <title>é€ä¿¡å´v3.8-integrated</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="modern">
<button id="themeToggle" onclick="toggleTheme()">ğŸ“ ã‚¯ãƒ©ã‚·ãƒƒã‚¯</button>

<div class="main-container" style="display: flex; justify-content: center; align-items: flex-start; gap: 20px;">
<div class="canvas-container">
<div style="position: relative; display: inline-block; margin: 50px auto 20px auto;">
  <img src="back2.png" alt="èƒŒæ™¯ç”»åƒ" style="transform: scale(1.3); display: block;">
  <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: pink; transform: scale(1.3); transform-origin: center;"></div>
  <canvas id="drawCanvas" width="283" height="420" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scale(1.3); transform-origin: center; cursor: crosshair; background: transparent;"></canvas>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«: Clearã€è‡ªåˆ†ã ã‘å‰Šé™¤ã€é€ä¿¡ -->
<div class="main-controls">
  <button onclick="clearCanvas()">Clear</button>
  <button onclick="clearMyDrawing()" style="background-color: #FF6B6B; color: white;">è‡ªåˆ†ã ã‘æ¶ˆå»</button>
  <button onclick="saveDoubleRotatedImage()" style="background-color: #4CAF50; color: white; font-size: 18px; padding: 12px 24px; font-weight: bold;">æ¸¡ã™</button>
</div>

</div>

<!-- å³ã‚µã‚¤ãƒ‰ãƒãƒ¼: ãƒšãƒ³ã®è‰²ã¨å¤ªã•ã‚’ä¸¦ã¹ã¦é…ç½® -->
<div class="right-sidebar" style="display: flex; gap: 15px; margin-top: 20px;">
  <!-- å·¦åˆ—: è‰² -->
  <div class="pen-colors-vertical" style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
    <h4 style="margin: 0; font-size: 16px; color: #333;">è‰²</h4>
    <button class="color-btn selected" style="background: black; width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ccc;" onclick="setPenColor('black')"></button>
    <button class="color-btn" style="background: red; width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ccc;" onclick="setPenColor('red')"></button>
    <button class="color-btn" style="background: blue; width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ccc;" onclick="setPenColor('blue')"></button>
    <button class="color-btn" style="background: green; width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ccc;" onclick="setPenColor('green')"></button>
    <button class="color-btn" style="background: white; border: 4px solid red; box-sizing: border-box; width: 50px; height: 50px; border-radius: 50%;" onclick="setPenColor('white-red-border')"></button>
  </div>
  
  <!-- å³åˆ—: å¤ªã• -->
  <div class="pen-thickness-vertical" style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
    <h4 style="margin: 0; font-size: 16px; color: #333;">å¤ªã•</h4>
    <button class="thickness-btn" onclick="setPenThickness(10)" title="å¤ªã„ (+30%)" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ccc; background: white; display: flex; align-items: center; justify-content: center;">
      <div style="width: 21px; height: 21px; border-radius: 50%; background: #333;"></div>
    </button>
    <button class="thickness-btn" onclick="setPenThickness(8)" title="æ¨™æº–" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ccc; background: white; display: flex; align-items: center; justify-content: center;">
      <div style="width: 16px; height: 16px; border-radius: 50%; background: #333;"></div>
    </button>
    <button class="thickness-btn selected" onclick="setPenThickness(6)" title="ç´°ã„ (-25%)" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid #333; background: white; display: flex; align-items: center; justify-content: center;">
      <div style="width: 12px; height: 12px; border-radius: 50%; background: #333;"></div>
    </button>
    <button class="thickness-btn" onclick="setPenThickness(4)" title="ã¨ã¦ã‚‚ç´°ã„ (-50%)" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ccc; background: white; display: flex; align-items: center; justify-content: center;">
      <div style="width: 8px; height: 8px; border-radius: 50%; background: #333;"></div>
    </button>
  </div>
</div>
</div>

<!-- èƒŒæ™¯é¸æŠã¯DevToolã«ç§»å‹• -->
<div class="button-group">
  <button onclick="toggleDevTools()" style="background-color: #FFA500; color: white;">ğŸ”§ Dev Tool</button>
</div>

<div id="devTools" style="display: none; border: 2px solid orange; padding: 10px; margin-top: 10px;">
  <h3>é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«</h3>
  
  <div class="button-group">
    <label>ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºèª¿æ•´:</label>
    <input type="range" id="canvasScale" min="0.1" max="3.0" step="0.05" value="0.7" oninput="updateCanvasScale(this.value)">
    <span id="canvasScaleValue">0.7x</span>
  </div>
  
  <div class="button-group">
    <label>ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹å¾…æ©Ÿæ™‚é–“ï¼ˆç§’ï¼‰:</label>
    <input type="range" id="animationStartWait" min="0.1" max="10" step="0.1" value="3.3" oninput="updateAnimationStartWait(this.value)">
    <span id="animationStartWaitValue">3.3ç§’</span>
  </div>
  
  <div class="button-group">
    <label>å›è»¢å¾Œå¾…æ©Ÿæ™‚é–“ï¼ˆç§’ï¼‰:</label>
    <input type="range" id="rotationWait" min="1" max="10" step="0.5" value="7.5" oninput="updateRotationWait(this.value)">
    <span id="rotationWaitValue">7.5ç§’</span>
  </div>
  
  <div class="button-group">
    <button onclick="sendDevSettings()">è¨­å®šã‚’å—ä¿¡å´ã«é€ä¿¡</button>
  </div>
  
  <div class="button-group">
    <label>èƒŒæ™¯é¸æŠ:</label>
    <button onclick="setBackground('./back3.png')">èƒŒæ™¯1</button>
    <button onclick="setBackground('./back2.png')">èƒŒæ™¯2</button>
    <button onclick="setBackground('./back4.png')">èƒŒæ™¯3</button>
    <button onclick="setBackground('./back6.png')">èƒŒæ™¯4</button>
    <button onclick="setBackground(null)">ç™½</button>
    <button onclick="setSpecialBackgroundToggle()" style="background: linear-gradient(45deg, #ff1493, #00ffff); color: white;">ğŸ¬ å‹•ç”»èƒŒæ™¯</button>
  </div>
  
  <hr style="margin: 15px 0;">
  
  <div class="button-group">
    <label>ãƒ†ã‚¹ãƒˆæ¼”å‡º:</label>
    <button onclick="createFireworks()" style="background: linear-gradient(45deg, #ff4500, #ffd700); color: white;">ğŸ† èŠ±ç«ãƒ†ã‚¹ãƒˆ</button>
    <button onclick="createConfetti()" style="background: linear-gradient(45deg, #ff69b4, #00fa9a); color: white;">ğŸŠ ç´™å¹é›ªãƒ†ã‚¹ãƒˆ</button>
  </div>
  
  <div class="button-group">
    <label>ãƒ“ãƒ‡ã‚ªã‚µã‚¤ã‚º:</label>
    <button id="size100Btn" class="selected" onclick="setVideoSize(100)">100%</button>
    <button id="size90Btn" onclick="setVideoSize(90)">90%</button>
    <button id="size80Btn" onclick="setVideoSize(80)">80%</button>
  </div>
  
  <div class="button-group">
    <button onclick="playVideo()" style="background-color: #FF6B6B; color: white;">ğŸ“¹ ãƒ“ãƒ‡ã‚ªå†ç”Ÿ</button>
  </div>
  
  <div class="button-group">
    <label>ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ:</label>
    <input type="checkbox" id="starEffect" checked onchange="toggleStarEffect()">
    <label for="starEffect">æ˜Ÿ</label>
    <input type="checkbox" id="fairyDustEffect" onchange="toggleFairyDustEffect()" checked>
    <label for="fairyDustEffect">å¦–ç²¾ã®ç²‰</label>
    <input type="checkbox" id="heartEffect" onchange="toggleHeartEffect()">
    <label for="heartEffect">ğŸ’– ãƒãƒ¼ãƒˆ</label>
    <input type="checkbox" id="penSoundEffect" onchange="togglePenSound()">
    <label for="penSoundEffect">ğŸµ ãƒšãƒ³éŸ³</label>
  </div>
  
  <div class="button-group">
    <label>é€ä¿¡å¾Œæ¼”å‡º:</label>
    <input type="checkbox" id="fireworksEffect" checked>
    <label for="fireworksEffect">ğŸ† èŠ±ç«</label>
    <input type="checkbox" id="confettiEffect" checked>
    <label for="confettiEffect">ğŸŠ ç´™å¹é›ª</label>
    <input type="checkbox" id="backgroundDebug" onchange="toggleBackgroundDebug()">
    <label for="backgroundDebug">ğŸ” èƒŒæ™¯ãƒ‡ãƒãƒƒã‚°</label>
  </div>
  
  <div class="button-group">
    <label>ç”¨ç´™ã‚µã‚¤ã‚º:</label>
    <button id="a4Btn" class="selected" onclick="setPaperSize('A4')">A4</button>
    <button id="lBtn" onclick="setPaperSize('L')">Låˆ¤</button>
    <button id="posterBtn" onclick="setPaperSize('poster')">ãƒã‚¹ãƒˆã‚«ãƒ¼ãƒ‰</button>
  </div>
  
  <div class="button-group">
    <label>å°åˆ·ãƒ¢ãƒ¼ãƒ‰:</label>
    <button id="drawOnlyBtn" class="selected" onclick="setPrintMode('drawOnly')">æç”»ãƒ¢ãƒ¼ãƒ‰</button>
    <button id="fullModeBtn" onclick="setPrintMode('fullMode')">ãƒ•ãƒ«ãƒ¢ãƒ¼ãƒ‰</button>
  </div>
  
  <hr style="margin: 15px 0;">
  
  <div class="button-group">
    <label>SwitchBot:</label>
    <input type="checkbox" id="switchBotEffect">
    <label for="switchBotEffect">ğŸ¤– ãƒãƒ–ãƒ«</label>
  </div>
  
  <div class="button-group">
    <button onclick="testSwitchBot()" style="background-color: #FF6B35; color: white;">ğŸ¤– Botãƒ†ã‚¹ãƒˆ</button>
  </div>
  
  <div class="button-group">
    <label>åº§æ¨™ãƒ†ã‚¹ãƒˆ:</label>
    <button onclick="testDrawRightBottom()" style="background-color: #FF1493; color: white;">ãƒ†ã‚¹ãƒˆå³ä¸‹</button>
  </div>
</div>

<div id="countdown"></div>

<script>
const canvas = document.getElementById("drawCanvas");

const ctx = canvas.getContext("2d");
let drawing = false;
let socket = new WebSocket("wss://realtime-sign-server-1.onrender.com");
let myWriterId = null; // è‡ªåˆ†ã®writer ID
let otherWritersData = {}; // ä»–ã®åŸ·ç­†è€…ã®ãƒ‡ãƒ¼ã‚¿

// æç”»çŠ¶æ…‹ç®¡ç†ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let isPaintDrawing = false;
let lastPaintPos = null;

// èƒŒæ™¯ç”»åƒã®ç¯„å›²ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰
let mySessionId = null; // ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºæœ‰ID
let backgroundImage = null;
let currentPaperSize = "A4"; // ç¾åœ¨ã®ç”¨ç´™ã‚µã‚¤ã‚º
let currentPrintMode = "drawOnly"; // ç¾åœ¨ã®å°åˆ·ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šæç”»ãƒ¢ãƒ¼ãƒ‰ï¼‰
let currentVideoSize = 100; // ç¾åœ¨ã®ãƒ“ãƒ‡ã‚ªã‚µã‚¤ã‚ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ100%ï¼‰
let canvasScale = 0.7; // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¹ã‚±ãƒ¼ãƒ«
let animationStartWaitTime = 3.3; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹å¾…æ©Ÿæ™‚é–“
let rotationWaitTime = 7.5; // å›è»¢å¾Œå¾…æ©Ÿæ™‚é–“
let currentPenThickness = 6; // ç¾åœ¨ã®ãƒšãƒ³ã®å¤ªã•ï¼ˆç´°ã„ï¼‰
let currentPenColor = 'black'; // ç¾åœ¨ã®ãƒšãƒ³ã®è‰²
let hasSentData = false; // é€ä¿¡æ¸ˆã¿ãƒ•ãƒ©ã‚°
// WriterIDåˆ¥ã®æç”»çŠ¶æ…‹ç®¡ç†ï¼ˆæ›¸ãæ‰‹å´ç”¨ï¼‰
const writerDrawingStates = {};

// ç¾åœ¨ã®æ›¸ãæ‰‹ç”¨ã®ãƒ¬ã‚¬ã‚·ãƒ¼å¤‰æ•°ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ä¿æŒï¼‰
let lastPosition = null; // å‰å›ã®ä½ç½®ã‚’è¨˜éŒ²
let currentPath = []; // ç¾åœ¨ã®ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã®ãƒã‚¤ãƒ³ãƒˆé…åˆ—
// [å‰Šé™¤] smoothingFactor - æœªä½¿ç”¨å¤‰æ•°ã‚’å‰Šé™¤

// ãƒ™ã‚¸ã‚§æ›²ç·šè£œé–“ç”¨ã®ç‚¹å±¥æ­´
let pointHistory = []; // æœ€æ–°3ç‚¹ã‚’ä¿æŒã—ã¦ãƒ™ã‚¸ã‚§æ›²ç·šã‚’æç”»
const MAX_POINT_HISTORY = 3; // ä¿æŒã™ã‚‹ç‚¹ã®æœ€å¤§æ•°
let starEffectEnabled = true; // æ˜Ÿã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®æœ‰åŠ¹/ç„¡åŠ¹ï¼ˆæ¨™æº–ã§ONï¼‰
let fairyDustEffectEnabled = true; // å¦–ç²¾ã®ç²‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®æœ‰åŠ¹/ç„¡åŠ¹ï¼ˆæ¨™æº–ã§ONï¼‰
let heartEffectEnabled = false; // ãƒãƒ¼ãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®æœ‰åŠ¹/ç„¡åŠ¹ï¼ˆæ¨™æº–ã§OFFï¼‰
let penSoundEnabled = false; // ãƒšãƒ³éŸ³ã®æœ‰åŠ¹/ç„¡åŠ¹ï¼ˆæ¨™æº–ã§OFFï¼‰
let specialBackgroundState = 'ready'; // 'ready', 'door_shown', 'door_opened'
let specialBackgroundToggle = false; // ç‰¹æ®ŠèƒŒæ™¯ã®ç”»åƒã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ãƒ•ãƒ©ã‚°

// ğŸ¬ é€ä¿¡å´å‹•ç”»èƒŒæ™¯é–¢é€£å¤‰æ•°
let senderVideoElement = null;
let isSenderVideoActive = false;

// ğŸµ ãƒšãƒ³éŸ³åˆ¶å¾¡
let drawingAudio = null; // æç”»ä¸­ã®éŸ³æ¥½ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
let isDrawingActive = false; // æç”»ä¸­ãƒ•ãƒ©ã‚°
let drawingInactiveTimer = null; // æç”»åœæ­¢ã‚¿ã‚¤ãƒãƒ¼
const DRAWING_PAUSE_DELAY = 500; // æç”»åœæ­¢ã‹ã‚‰ä¸€æ™‚åœæ­¢ã¾ã§ã®é…å»¶ï¼ˆãƒŸãƒªç§’ï¼‰

// ğŸ” èƒŒæ™¯ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºåˆ¶å¾¡
let backgroundDebugEnabled = false;
let lastBackgroundSrc = null;

// èƒŒæ™¯åˆ¥ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºè¨­å®šï¼ˆ1.02å€ã‚µã‚¤ã‚º = 0.6*1.7ï¼‰
const backgroundSizes = {
  'back3': { width: 859, height: 607 },    // èƒŒæ™¯1 - çµ±ä¸€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯” (859/607 â‰ˆ 1.415)
  'back2': { width: 859, height: 607 },    // èƒŒæ™¯2 - çµ±ä¸€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã«å¤‰æ›´
  'back4': { width: 859, height: 607 },    // èƒŒæ™¯3 - çµ±ä¸€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”
  'back5': { width: 859, height: 607 },    // èƒŒæ™¯5 - çµ±ä¸€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”
  'back6': { width: 859, height: 607 },    // èƒŒæ™¯4 - çµ±ä¸€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”
  'white': { width: 859, height: 607 }     // ç™½èƒŒæ™¯ - çµ±ä¸€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”
};

// ğŸš€ éä¾µå…¥çš„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼
// æ—¢å­˜æ©Ÿèƒ½ã‚’ä¸€åˆ‡å¤‰æ›´ã›ãšã€è¿½åŠ ã®ã¿ã§æœ€é©åŒ–
let performanceOptimizer = {
  lastMouseTime: 0,
  lastTouchTime: 0,
  pendingEffects: [],
  effectAnimationId: null,
  MOUSE_THROTTLE_INTERVAL: 16, // PCç”¨: 60fpsç›¸å½“
  TOUCH_THROTTLE_INTERVAL: 8,  // Redmi Pad 2è»½é‡åŒ–: 360Hzâ†’120Hzç›¸å½“ï¼ˆ125fpsï¼‰
  
  // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ãƒã‚§ãƒƒã‚¯ï¼ˆPCç”¨ï¼‰
  shouldProcessMouseEvent() {
    const now = Date.now();
    if (now - this.lastMouseTime < this.MOUSE_THROTTLE_INTERVAL) {
      return false;
    }
    this.lastMouseTime = now;
    return true;
  },
  
  // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ãƒã‚§ãƒƒã‚¯ï¼ˆRedmi Pad 2æœ€é©åŒ–ï¼‰
  shouldProcessTouchEvent() {
    const now = Date.now();
    if (now - this.lastTouchTime < this.TOUCH_THROTTLE_INTERVAL) {
      return false;
    }
    this.lastTouchTime = now;
    return true;
  },
  
  // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå‡¦ç†ã®éºå»¶å®Ÿè¡Œ
  scheduleEffect(effectFunction) {
    this.pendingEffects.push(effectFunction);
    if (!this.effectAnimationId) {
      this.effectAnimationId = requestAnimationFrame(() => {
        // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ãƒãƒƒãƒå‡¦ç†
        for (const effect of this.pendingEffects) {
          if (Math.random() < 0.3) { // 30%ã®ç¢ºç‡ã§å®Ÿè¡Œï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹èª¿æ•´ï¼‰
            effect();
          }
        }
        this.pendingEffects = [];
        this.effectAnimationId = null;
      });
    }
  }
};

socket.onopen = () => {
  console.log("âœ… WebSocketæ¥ç¶šå®Œäº†ï¼ˆé€ä¿¡å´ï¼‰");
  
  // å°‘ã—å¾…ã£ã¦ã‹ã‚‰writer ID ã‚’è¦æ±‚ï¼ˆå—ä¿¡å´ã®æº–å‚™å®Œäº†ã‚’å¾…ã¤ï¼‰
  setTimeout(() => {
    console.log("ğŸ”„ WriterIDè¦æ±‚ã‚’é–‹å§‹");
    requestWriterId();
    
    // åˆæœŸèƒŒæ™¯ç”»åƒã®è¨­å®šã¯WriterIDå‰²ã‚Šå½“ã¦å®Œäº†å¾Œã«å®Ÿè¡Œã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯å‰Šé™¤
    console.log('â³ WriterIDå‰²ã‚Šå½“ã¦å¾…ã¡ - èƒŒæ™¯ç”»åƒé€ä¿¡ã¯WriterIDå–å¾—å¾Œã«å®Ÿè¡Œ');
  }, 500);
};

socket.onmessage = (event) => {
  try {
    let data;
    
    // Blobã®å ´åˆã¯æ–‡å­—åˆ—ã¨ã—ã¦èª­ã¿å–ã‚‹
    if (event.data instanceof Blob) {
      const reader = new FileReader();
      reader.onload = function() {
        try {
          data = JSON.parse(reader.result);
          processMessage(data);
        } catch (error) {
          console.error('âŒ Blobãƒ‡ãƒ¼ã‚¿ã®è§£æã‚¨ãƒ©ãƒ¼:', error);
        }
      };
      reader.readAsText(event.data);
      return;
    } else {
      // æ–‡å­—åˆ—ã®å ´åˆ
      data = JSON.parse(event.data);
      processMessage(data);
    }
  } catch (error) {
    console.error('âŒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
  }
};

// ä¸è¦ãªã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡¨ç¤ºæ©Ÿèƒ½ã‚’å‰Šé™¤ - ã‚·ãƒ³ãƒ—ãƒ«ãªUIã«çµ±ä¸€

// ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºã¨æ©Ÿèƒ½åˆ‡ã‚Šæ›¿ãˆã‚·ã‚¹ãƒ†ãƒ 
const DeviceManager = {
  // ãƒ‡ãƒã‚¤ã‚¹ã‚¿ã‚¤ãƒ—ã‚’æ¤œå‡º
  detectDevice() {
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;
    const touchSupport = 'ontouchstart' in window;
    const screenWidth = window.screen.width;
    const screenHeight = window.screen.height;
    const maxTouchPoints = navigator.maxTouchPoints || 0;
    
    // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆåˆ¤å®š
    const isTablet = (
      touchSupport &&
      maxTouchPoints > 1 &&
      (screenWidth >= 768 || screenHeight >= 768) &&
      (screenWidth <= 1024 || screenHeight <= 1024)
    ) || (
      /iPad|Android(?!.*Mobile)|Tablet/i.test(userAgent)
    );
    
    // ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³åˆ¤å®š
    const isMobile = (
      touchSupport &&
      !isTablet &&
      /Android|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)
    );
    
    // PCåˆ¤å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
    const isPC = !isTablet && !isMobile;
    
    return {
      isPC,
      isTablet,
      isMobile,
      touchSupport,
      screenWidth,
      screenHeight,
      maxTouchPoints,
      userAgent: userAgent.substring(0, 100) // ãƒ­ã‚°ç”¨ã«çŸ­ç¸®
    };
  },
  
  // ãƒ‡ãƒã‚¤ã‚¹åˆ¥è¨­å®šã‚’é©ç”¨
  applyDeviceSettings() {
    const device = this.detectDevice();
    console.log('ğŸ” ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºçµæœ:', device);
    
    if (device.isPC) {
      this.applyPCSettings();
    } else if (device.isTablet) {
      this.applyTabletSettings();
    } else if (device.isMobile) {
      this.applyMobileSettings();
    }
    
    return device;
  },
  
  // PCç”¨è¨­å®š
  applyPCSettings() {
    console.log('ğŸ’» PCè¨­å®šã‚’é©ç”¨');
    
    // PCç”¨ã®ç‰¹åˆ¥ãªè¨­å®š
    const canvas = document.getElementById('drawCanvas');
    if (canvas) {
      // PCã§ã¯ãƒã‚¦ã‚¹æ“ä½œã‚’æœ€é©åŒ–
      canvas.style.cursor = 'crosshair';
    }
    
    // PCç”¨UIã®èª¿æ•´
    document.body.classList.add('device-pc');
    document.body.classList.remove('device-tablet', 'device-mobile');
    
    // PCå°‚ç”¨æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
    this.enablePCFeatures();
  },
  
  // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨è¨­å®š
  applyTabletSettings() {
    console.log('ğŸ“± ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆè¨­å®šã‚’é©ç”¨');
    
    // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ã®ç‰¹åˆ¥ãªè¨­å®š
    const canvas = document.getElementById('drawCanvas');
    if (canvas) {
      // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã¯ã‚¿ãƒƒãƒæ“ä½œã‚’æœ€é©åŒ–
      canvas.style.cursor = 'none'; // ã‚«ãƒ¼ã‚½ãƒ«éè¡¨ç¤º
    }
    
    // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨UIã®èª¿æ•´
    document.body.classList.add('device-tablet');
    document.body.classList.remove('device-pc', 'device-mobile');
    
    // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå°‚ç”¨æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
    this.enableTabletFeatures();
  },
  
  // ãƒ¢ãƒã‚¤ãƒ«ç”¨è¨­å®š
  applyMobileSettings() {
    console.log('ğŸ“± ãƒ¢ãƒã‚¤ãƒ«è¨­å®šã‚’é©ç”¨');
    
    // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ç‰¹åˆ¥ãªè¨­å®š
    const canvas = document.getElementById('drawCanvas');
    if (canvas) {
      canvas.style.cursor = 'none';
    }
    
    // ãƒ¢ãƒã‚¤ãƒ«ç”¨UIã®èª¿æ•´
    document.body.classList.add('device-mobile');
    document.body.classList.remove('device-pc', 'device-tablet');
    
    // ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
    this.enableMobileFeatures();
  },
  
  // PCå°‚ç”¨æ©Ÿèƒ½
  enablePCFeatures() {
    // PCç”¨ã®è©³ç´°ãªDevToolsã‚’è¡¨ç¤º
    const devButton = document.getElementById('devButton');
    if (devButton) {
      devButton.style.display = 'block';
    }
    
    // PCç”¨ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’æœ‰åŠ¹åŒ–
    this.enableKeyboardShortcuts();
  },
  
  // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå°‚ç”¨æ©Ÿèƒ½
  enableTabletFeatures() {
    // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ã®å¤§ããªãƒœã‚¿ãƒ³
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => {
      if (!btn.classList.contains('color-btn') && !btn.classList.contains('thickness-btn')) {
        btn.style.minHeight = '50px';
        btn.style.fontSize = '16px';
      }
    });
    
    // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ã®ã‚¿ãƒƒãƒæœ€é©åŒ–
    this.optimizeForTouch();
  },
  
  // ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨æ©Ÿèƒ½
  enableMobileFeatures() {
    // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®è¶…å¤§ããªãƒœã‚¿ãƒ³
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => {
      if (!btn.classList.contains('color-btn') && !btn.classList.contains('thickness-btn')) {
        btn.style.minHeight = '60px';
        btn.style.fontSize = '18px';
      }
    });
    
    // DevToolsã‚’éè¡¨ç¤ºï¼ˆç”»é¢ãŒå°ã•ã„ãŸã‚ï¼‰
    const devButton = document.getElementById('devButton');
    if (devButton) {
      devButton.style.display = 'none';
    }
  },
  
  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆPCå°‚ç”¨ï¼‰
  enableKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
          case 'z':
            e.preventDefault();
            // Undoæ©Ÿèƒ½ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
            console.log('âŒ¨ï¸ Undo shortcut (PC only)');
            break;
          case 's':
            e.preventDefault();
            // Saveæ©Ÿèƒ½
            console.log('âŒ¨ï¸ Save shortcut (PC only)');
            break;
        }
      }
    });
  },
  
  // ã‚¿ãƒƒãƒæœ€é©åŒ–ï¼ˆã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ/ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨ï¼‰
  optimizeForTouch() {
    // ã‚¿ãƒƒãƒé…å»¶ã‚’å‰Šé™¤
    const style = document.createElement('style');
    style.textContent = `
      .device-tablet button, .device-mobile button {
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        touch-action: manipulation;
      }
      
      .device-tablet .pen-controls, .device-mobile .pen-controls {
        gap: 15px;
      }
    `;
    document.head.appendChild(style);
  }
};
socket.onerror = (error) => console.error("âŒ WebSocketã‚¨ãƒ©ãƒ¼ï¼ˆé€ä¿¡å´ï¼‰:", error);
socket.onclose = (event) => {
  console.log("âš ï¸ WebSocketåˆ‡æ–­ï¼ˆé€ä¿¡å´ï¼‰:", event.code, event.reason);
  console.log("ğŸ§¹ åˆ‡æ–­å‰ã®çŠ¶æ…‹:", { myWriterId, mySessionId });
  
  // æ¥ç¶šåˆ‡æ–­æ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆ
  mySessionId = null;
  myWriterId = null;
  console.log("ğŸ§¹ WebSocketåˆ‡æ–­ã«ä¼´ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆ");
  
  // Writer IDè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
  const statusDiv = document.getElementById('writerStatus');
  if (statusDiv) {
    statusDiv.childNodes[0].textContent = 'Writer ID: æœªå‰²ã‚Šå½“ã¦';
  }
  document.title = 'é€ä¿¡å´ - æœªæ¥ç¶š';
};

// ãƒãƒ¼ãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”Ÿæˆé–¢æ•°

let senderLKeyCount = 0;
let senderLKeyTimer = null;

document.addEventListener('keydown', function(event) {
  if (event.key.toLowerCase() === 'l') {
    senderLKeyCount++;
    // é€ä¿¡å´lã‚­ãƒ¼æŠ¼ä¸‹
    
    if (senderLKeyTimer) {
      clearTimeout(senderLKeyTimer);
    }
    
    if (senderLKeyCount >= 10) {
      createSpecialHeart();
      senderLKeyCount = 0;
    } else {
      createHeart();
    }
    
    senderLKeyTimer = setTimeout(() => {
      senderLKeyCount = 0;
    }, 3000);
  }
});

setTimeout(() => {
  // ãƒ†ã‚¹ãƒˆ: è‡ªå‹•ãƒãƒ¼ãƒˆè¡¨ç¤º
  createHeart();
}, 5000);

// ğŸ”¸ ç”¨ç´™ã‚µã‚¤ã‚ºè¨­å®šé–¢æ•°

// ğŸ–¨ï¸ å°åˆ·ãƒ¢ãƒ¼ãƒ‰è¨­å®šé–¢æ•°

// ğŸ”¸ ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºå¤‰æ›´é–¢æ•°ã‚’è¿½åŠ 

function startCountdown() {
  const countdownEl = document.getElementById("countdown");
  
  // ğŸ”¸ ç”¨ç´™ã‚µã‚¤ã‚ºã«å¿œã˜ã¦ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³æ™‚é–“ã‚’èª¿æ•´
  let totalSeconds;
  if (currentPaperSize === "poster") {
    totalSeconds = 8; // ãƒã‚¹ã‚¿ãƒ¼ï¼š3ç§’çŸ­ç¸®ï¼ˆ11ç§’â†’8ç§’ï¼‰
  } else if (currentPaperSize === "L") {
    totalSeconds = 9; // Låˆ¤ï¼š2ç§’çŸ­ç¸®ï¼ˆ11ç§’â†’9ç§’ï¼‰
  } else {
    totalSeconds = 11; // A4ï¼šå¾“æ¥é€šã‚Š11ç§’
  }
  
  let seconds = totalSeconds;
  countdownEl.textContent = `ãŠæ¸¡ã—ã¾ã§ï¼š${seconds}ç§’`;
  
  const timer = setInterval(() => {
    seconds--;
    if (seconds >= 0) {
      countdownEl.textContent = `ãŠæ¸¡ã—ã¾ã§ï¼š${seconds}ç§’`;
    } else {
      clearInterval(timer);
      countdownEl.textContent = "";
      // âœ… ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³çµ‚äº†å¾Œã€ç­†è·¡ã®ã¿å‰Šé™¤ï¼ˆèƒŒæ™¯ç¶­æŒï¼‰
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (backgroundImage) {
        drawBackgroundImage(ctx, backgroundImage, canvas);
      }
      
      // æç”»ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¯ãƒªã‚¢
      drawingCommands = [];
      
      // âœ… èƒŒæ™¯ã®åŒæœŸé€ä¿¡
      const bgSrc = backgroundImage ? backgroundImage.src : "white";
      socket.send(JSON.stringify({ type: "clear" }));
      socket.send(JSON.stringify({ type: "background", src: bgSrc, writerId: myWriterId }));
    }
  }, 1000);
}

// ãƒšãƒ³ã®å¤ªã•è¨­å®šé–¢æ•°

// ãƒšãƒ³ã®è‰²è¨­å®šé–¢æ•°

// 16é€²æ•°ã‚«ãƒ©ãƒ¼ã‚’RGBã«å¤‰æ›
// æ˜Ÿã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ON/OFFåˆ‡ã‚Šæ›¿ãˆ

// ğŸµ ãƒšãƒ³éŸ³åˆ¶å¾¡é–¢æ•°ï¼ˆé€ä¿¡å´ã§ã¯ç„¡åŠ¹åŒ–ï¼‰
// æç”»ç”¨ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
// createDrawingHeart, createSenderStar, createFairyDust, createStar

// ç¢ºå®Ÿã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã€DOMãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã‹ã‚‰å®Ÿè¡Œ
document.addEventListener('DOMContentLoaded', function() {
  const canvasElement = document.getElementById('drawCanvas');
  
  if (canvasElement) {
    
    // æ¨™æº–çš„ãªãƒšã‚¤ãƒ³ãƒˆãƒ„ãƒ¼ãƒ«æ–¹å¼ã®æç”»ã‚·ã‚¹ãƒ†ãƒ 
    // isPaintDrawingã€lastPaintPosã€getBackgroundAreaã€isWithinBackgroundAreaã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§å®šç¾©æ¸ˆã¿
    
    // å…±é€šé–¢æ•°: ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã‚’å–å¾—
    function getCanvasCoordinates(event, element) {
      const rect = element.getBoundingClientRect();
      const scaleX = element.width / rect.width;
      const scaleY = element.height / rect.height;
      const x = (event.clientX - rect.left) * scaleX;
      const y = (event.clientY - rect.top) * scaleY;
      return { x, y };
    }
    
    // å…±é€šé–¢æ•°: ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã‚’å–å¾—
    function getTouchCanvasCoordinates(event, element) {
      const touch = event.touches[0];
      const rect = element.getBoundingClientRect();
      const scaleX = element.width / rect.width;
      const scaleY = element.height / rect.height;
      const x = (touch.clientX - rect.left) * scaleX;
      const y = (touch.clientY - rect.top) * scaleY;
      return { x, y };
    }
    
    // å…±é€šé–¢æ•°: æç”»è¨­å®šã‚’åˆæœŸåŒ–
    function setupDrawingContext() {
      ctx.strokeStyle = currentPenColor || 'black';
      ctx.lineWidth = currentPenThickness || 8;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
    }
    
    // å…±é€šé–¢æ•°: æç”»é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
    function createStartMessage(x, y) {
      return {
        type: "start",
        x: x,
        y: y,
        thickness: currentPenThickness,
        color: currentPenColor,
        writerId: myWriterId,
        timestamp: Date.now()
      };
    }
    
    // å…±é€šé–¢æ•°: æç”»ç¶™ç¶šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
    function createDrawMessage(x, y) {
      return {
        type: "draw",
        x: x,
        y: y,
        thickness: currentPenThickness,
        color: currentPenColor,
        writerId: myWriterId,
        timestamp: Date.now(),
        starEffect: starEffectEnabled,
        fairyDustEffect: fairyDustEffectEnabled,
        canvasSize: {
          width: canvas.width,
          height: canvas.height
        }
      };
    }
    
    // å…±é€šé–¢æ•°: çµ±åˆæç”»é–‹å§‹å‡¦ç†
    function handleDrawingStart(x, y) {
      // èƒŒæ™¯ç”»åƒã®ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
      if (!isWithinBackgroundArea(x, y)) {
        console.log('ğŸ–±ï¸ èƒŒæ™¯ç”»åƒç¯„å›²å¤–ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
        return false;
      }
      
      // å…±é€šãƒ•ãƒ©ã‚°è¨­å®š
      drawing = true;
      isPaintDrawing = true;
      lastPaintPos = { x, y };
      lastPosition = { x, y };
      
      // ãƒ™ã‚¸ã‚§æ›²ç·šç”¨ã®ç‚¹å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ
      pointHistory = [{ x, y }];
      currentPath = [{ x, y }];
      
      // WriterIDåˆ¥æç”»çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      resetWriterDrawingState('self');
      const selfState = getWriterDrawingState('self');
      selfState.lastPosition = { x, y };
      selfState.currentPath = [{ x, y }];
      selfState.isDrawing = true;
      
      // CanvasçŠ¶æ…‹ã‚’å®Œå…¨ã«åˆæœŸåŒ–
      // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆæœŸåŒ–ã¨æç”»è¨­å®šã‚’çµ±åˆ
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.globalCompositeOperation = 'source-over';
      ctx.shadowBlur = 0;
      ctx.shadowColor = 'transparent';
      ctx.globalAlpha = 1.0;
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      
      setupDrawingContext();
      
      // æç”»é–‹å§‹ï¼ˆæœ€é©åŒ–ï¼š1å›ã®beginPath()ã§å‡¦ç†ï¼‰
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(x + 0.1, y + 0.1);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y);
      
      // æç”»ã‚³ãƒãƒ³ãƒ‰ã‚’è¨˜éŒ²
      const startCmd = {
        type: "start",
        x: x,
        y: y,
        thickness: currentPenThickness,
        color: currentPenColor === 'black' ? '#000' : currentPenColor
      };
      drawingCommands.push(startCmd);
      
      // Writer IDãƒã‚§ãƒƒã‚¯
      if (!myWriterId) {
        console.warn("âš ï¸ Writer IDæœªè¨­å®šã®ãŸã‚æç”»ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¾ã›ã‚“");
        return true; // æç”»ã¯é–‹å§‹ã—ãŸãŒWebSocketé€ä¿¡ã¯ã—ãªã„
      }
      
      // WebSocketé€ä¿¡
      const startMsg = createStartMessage(x, y);
      startMsg.starEffect = starEffectEnabled;
      startMsg.fairyDustEffect = fairyDustEffectEnabled;
      startMsg.heartEffect = heartEffectEnabled;
      startMsg.canvasSize = { width: canvas.width, height: canvas.height };
      
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify(startMsg));
      }
      
      // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”Ÿæˆ
      const rect = canvas.getBoundingClientRect();
      const pageX = rect.left + x;
      const pageY = rect.top + y;
      
      if (starEffectEnabled) {
        createSenderStar(pageX, pageY);
      }
      if (fairyDustEffectEnabled) {
        createFairyDust(pageX, pageY);
      }
      
      return true;
    }
    
    // å…±é€šé–¢æ•°: çµ±åˆæç”»ç¶™ç¶šå‡¦ç†
    function handleDrawingMove(x, y) {
      if (!drawing || !isPaintDrawing) return;
      
      // èƒŒæ™¯ç”»åƒã®ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
      if (!isWithinBackgroundArea(x, y)) {
        console.log('ğŸ–±ï¸ èƒŒæ™¯ç”»åƒç¯„å›²å¤– - æç”»ä¸­æ–­');
        drawing = false;
        isPaintDrawing = false;
        lastPaintPos = null;
        return;
      }
      
      // ç·šã‚’æç”»
      ctx.lineTo(x, y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y);
      
      // ãƒ‘ã‚¹æ›´æ–°
      currentPath.push({ x, y });
      lastPosition = { x, y };
      
      // ç‚¹å±¥æ­´æ›´æ–°ï¼ˆãƒ™ã‚¸ã‚§æ›²ç·šç”¨ï¼‰
      pointHistory.push({ x, y });
      if (pointHistory.length > MAX_POINT_HISTORY) {
        pointHistory.shift();
      }
      
      // æç”»ã‚³ãƒãƒ³ãƒ‰è¨˜éŒ²
      const actualColor = currentPenColor === 'white-red-border' ? '#ffffff' : 
                         (currentPenColor === 'black' ? '#000' : 
                         (currentPenColor === 'white' ? '#fff' : 
                         (currentPenColor === 'green' ? '#008000' : 
                         (currentPenColor === 'pink' ? '#ff69b4' : currentPenColor))));
      const drawCmd = {
        type: "draw",
        x: x,
        y: y,
        thickness: currentPenThickness,
        color: actualColor
      };
      drawingCommands.push(drawCmd);
      
      // WebSocketé€ä¿¡
      if (myWriterId) {
        const drawMsg = createDrawMessage(x, y);
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify(drawMsg));
        }
      }
      
      // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”Ÿæˆ
      const rect = canvas.getBoundingClientRect();
      const pageX = rect.left + x;
      const pageY = rect.top + y;
      
      if (starEffectEnabled && Math.random() < 0.5) {
        createSenderStar(pageX, pageY);
      }
      if (fairyDustEffectEnabled && Math.random() < 0.3) {
        createFairyDust(pageX, pageY);
      }
      
      lastPaintPos = { x, y };
    }
    
    // å…±é€šé–¢æ•°: çµ±åˆæç”»çµ‚äº†å‡¦ç†
    function handleDrawingEnd() {
      drawing = false;
      isPaintDrawing = false;
      
      // ãƒ™ã‚¸ã‚§æ›²ç·šç”¨ã®ç‚¹å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
      pointHistory = [];
      
      // WriterIDåˆ¥æç”»çŠ¶æ…‹ã‚’æ›´æ–°
      const selfState = getWriterDrawingState('self');
      if (selfState) {
        selfState.isDrawing = false;
      }
      
      // white-red-border ã®ç‰¹åˆ¥å‡¦ç†
      if (currentPenColor === 'white-red-border' && currentPath.length > 1) {
        drawWhiteRedBorderEffect();
      }
      
      // ãƒ‘ã‚¹ã‚’ã‚¯ãƒªã‚¢
      currentPath = [];
      lastPaintPos = null;
      lastPosition = null;
    }
    
    // å…±é€šé–¢æ•°: white-red-border ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    function drawWhiteRedBorderEffect() {
      ctx.save();
      
      // æç”»ãƒ¬ã‚¤ãƒ¤ãƒ¼å®šç¾©ï¼ˆå¤–å´â†’å†…å´ã®é †ï¼‰
      const layers = [
        { thickness: currentPenThickness + 10, alpha: 0.2, color: '#ffccdd' },
        { thickness: currentPenThickness + 8, alpha: 0.5, color: '#ffaacc' },
        { thickness: currentPenThickness + 6, alpha: 0.8, color: '#ff88bb' },
        { thickness: Math.max(1, currentPenThickness - 3), alpha: 0.9, color: '#ffffff' }
      ];
      
      // å…±é€šè¨­å®š
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      
      // å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’åŠ¹ç‡çš„ã«æç”»
      layers.forEach(layer => {
        ctx.beginPath();
        ctx.moveTo(currentPath[0].x, currentPath[0].y);
        ctx.lineWidth = layer.thickness;
        ctx.globalAlpha = layer.alpha;
        ctx.strokeStyle = layer.color;
        ctx.shadowColor = layer.color;
        
        for (let i = 1; i < currentPath.length; i++) {
          ctx.lineTo(currentPath[i].x, currentPath[i].y);
        }
        ctx.stroke();
      });
      
      ctx.restore();
    }
    
    // PointerEventsã‚’ä½¿ç”¨ï¼ˆã‚ˆã‚Šç¢ºå®Ÿãªã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ï¼‰
    if ('PointerEvent' in window) {
      
      canvasElement.addEventListener('pointerdown', (e) => {
        const { x, y } = getCanvasCoordinates(e, canvasElement);
        handleDrawingStart(x, y);
      });
      
      canvasElement.addEventListener('pointermove', (e) => {
        const { x, y } = getCanvasCoordinates(e, canvasElement);
        handleDrawingMove(x, y);
      });
      
      canvasElement.addEventListener('pointerup', (e) => {
        handleDrawingEnd();
      });
      
    } else {
      console.log('ğŸ–±ï¸ å¾“æ¥ã®ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½¿ç”¨');
      
      // å¾“æ¥ã®ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
      canvasElement.addEventListener('mousedown', (e) => {
        console.log('ğŸ–±ï¸ mousedown - æç”»é–‹å§‹');
        const { x, y } = getCanvasCoordinates(e, canvasElement);
        handleDrawingStart(x, y);
        e.preventDefault();
      });
      
      canvasElement.addEventListener('mousemove', (e) => {
        const { x, y } = getCanvasCoordinates(e, canvasElement);
        handleDrawingMove(x, y);
      });
      
      canvasElement.addEventListener('mouseup', (e) => {
        console.log('ğŸ–±ï¸ mouseup - æç”»çµ‚äº†');
        handleDrawingEnd();
      });
    }
    
    // çµ±åˆã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
    canvasElement.addEventListener("touchstart", (e) => {
      e.preventDefault();
      console.log('ğŸ“± touchstart - çµ±åˆæç”»é–‹å§‹');
      const { x, y } = getTouchCanvasCoordinates(e, canvasElement);
      handleDrawingStart(x, y);
    });
    
    canvasElement.addEventListener("touchmove", (e) => {
      e.preventDefault();
      const { x, y } = getTouchCanvasCoordinates(e, canvasElement);
      handleDrawingMove(x, y);
    });
    
    canvasElement.addEventListener("touchend", (e) => {
      e.preventDefault();
      console.log('ğŸ“± touchend - çµ±åˆæç”»çµ‚äº†');
      handleDrawingEnd();
    });
    
    // mouseleaveã§æç”»ã‚’çµ‚äº†ï¼ˆä¸€èˆ¬çš„ãªãƒšã‚¤ãƒ³ãƒˆãƒ„ãƒ¼ãƒ«ã®å‹•ä½œï¼‰
    canvasElement.addEventListener("mouseleave", (e) => {
      console.log('ğŸ–±ï¸ mouseleave - æç”»çµ‚äº†');
      handleDrawingEnd();
    });
    
    // å³ã‚¯ãƒªãƒƒã‚¯ã§æç”»ã‚’ä¸­æ–­
    canvasElement.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      console.log('ğŸ–±ï¸ å³ã‚¯ãƒªãƒƒã‚¯ - æç”»ä¸­æ–­');
      handleDrawingEnd();
    });
  }
});



// [é‡è¤‡å‰Šé™¤] å¤ã„mousemove/touchã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤ (çµ±åˆç‰ˆã‚’ä½¿ç”¨)
// [é‡è¤‡å‰Šé™¤] å¤ã„touchmoveã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤ (çµ±åˆç‰ˆã‚’ä½¿ç”¨)

// ğŸ”¸ UIåˆ¶å¾¡é–¢æ•°ç¾¤ (setVideoSize, playVideo) ã¯ui-controls.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// ğŸ”§ Dev Toolsé–¢æ•°ç¾¤ (toggleDevTools, updateCanvasScale, updateAnimationStartWait, updateRotationWait, sendDevSettings) ã¯dev-tools.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// æç”»ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹é…åˆ—
let drawingCommands = [];

function saveRotatedImage() {
  
  try {
    // æœ€çµ‚çš„ãªç”»åƒç”¨ã®canvasã‚’ä½œæˆ
    const finalCanvas = document.createElement('canvas');
    const finalCtx = finalCanvas.getContext('2d');
    finalCanvas.width = canvas.width;
    finalCanvas.height = canvas.height;
    
    // 1. èƒŒæ™¯ã‚’å…ˆã«æç”»ï¼ˆå›è»¢ã•ã›ãªã„ï¼‰
    if (backgroundImage) {
      finalCtx.drawImage(backgroundImage, 0, 0, finalCanvas.width, finalCanvas.height);
    } else {
      // ç™½èƒŒæ™¯ã§å¡—ã‚Šã¤ã¶ã—
      finalCtx.fillStyle = '#ffffff';
      finalCtx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
    }
    
    // 2. ãƒšã‚¤ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’180åº¦å›è»¢ã•ã›ã¦æç”»
    if (drawingCommands.length > 0) {
      
      // 180åº¦å›è»¢å¤‰æ›ã‚’é©ç”¨
      finalCtx.save();
      finalCtx.translate(finalCanvas.width, finalCanvas.height);
      finalCtx.rotate(Math.PI);
      
      // æç”»ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œï¼ˆåº§æ¨™ã¯å…ƒã®ã¾ã¾ã€ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒå›è»¢ã—ã¦ã„ã‚‹ï¼‰
      drawingCommands.forEach(cmd => {
        if (cmd.type === 'start') {
          finalCtx.beginPath();
          finalCtx.moveTo(cmd.x, cmd.y);
        } else if (cmd.type === 'draw') {
          finalCtx.lineWidth = cmd.thickness || 8;
          finalCtx.strokeStyle = cmd.color || 'black';
          finalCtx.lineTo(cmd.x, cmd.y);
          finalCtx.stroke();
        }
      });
      
      finalCtx.restore();
    } else {
    }
    
    // è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    const imageDataUrl = finalCanvas.toDataURL('image/png');
    const link = document.createElement('a');
    const now = new Date();
    const fileName = `rotated_${now.getFullYear()}${(now.getMonth() + 1)
      .toString().padStart(2, "0")}${now.getDate().toString().padStart(2, "0")}_${now
      .getHours().toString().padStart(2, "0")}${now.getMinutes().toString().padStart(2, "0")}${now
      .getSeconds().toString().padStart(2, "0")}.png`;
    
    link.download = fileName;
    link.href = imageDataUrl;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    
  } catch (error) {
    console.error('âŒ 180åº¦å›è»¢ç”»åƒä¿å­˜ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.message, error);
    alert('ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

// ç¾åœ¨ã®çŠ¶æ…‹ã‹ã‚‰æ›´ã«180åº¦å›è»¢ã•ã›ã¦ä¿å­˜ã™ã‚‹é–¢æ•°
function saveDoubleRotatedImage() {
  // éŸ³æ¥½åˆ¶å¾¡ã¯é€ä¿¡å´ã§ã¯ç„¡åŠ¹åŒ–ï¼ˆå—ä¿¡å´ã®ã¿ã§éŸ³æ¥½å†ç”Ÿï¼‰
  
  console.log(`ğŸ”„ğŸ”„ğŸ”„ é€ä¿¡ãƒœã‚¿ãƒ³æŠ¼ä¸‹: globalSendé€ä¿¡é–‹å§‹â†’${animationStartWaitTime}ç§’å¾Œã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ ğŸ”„ğŸ”„ğŸ”„`);
  
  // ğŸ”¸ ã¾ãšå—ä¿¡å´ã«å°åˆ·æŒ‡ç¤ºã‚’é€ä¿¡ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã£ã¦ã„ã‚‹çŠ¶æ…‹ã§ï¼‰
  console.log('ğŸ“¤ğŸ“¤ğŸ“¤ å—ä¿¡å´ã«globalSendæŒ‡ç¤ºã‚’é€ä¿¡ä¸­... ğŸ“¤ğŸ“¤ğŸ“¤');
  socket.send(JSON.stringify({
    type: "globalSend",
    writerId: myWriterId,
    timestamp: Date.now(),
    animationStartWaitTime: animationStartWaitTime,
    rotationWaitTime: rotationWaitTime
  }));
  console.log('âœ…âœ…âœ… å—ä¿¡å´ã¸ã®globalSendæŒ‡ç¤ºé€ä¿¡å®Œäº† âœ…âœ…âœ…');
  
  // ğŸ”¸ å°‘ã—å¾…ã£ã¦ã‹ã‚‰é€ä¿¡å´ã®å°åˆ·å‡¦ç†ã®ã¿å®Ÿè¡Œ
  setTimeout(() => {
    actualPrintProcess();
  }, 500); // å—ä¿¡å´ã®å°åˆ·å‡¦ç†ãŒé–‹å§‹ã•ã‚Œã‚‹ã¾ã§500mså¾…æ©Ÿ
  
  // ğŸ”„ é€ä¿¡ç›´å¾Œã«æ–°ã—ã„æç”»ã‚’å¯èƒ½ã«ã™ã‚‹ãŸã‚ã€hasSentDataãƒ•ãƒ©ã‚°ã‚’å³åº§ã«ãƒªã‚»ãƒƒãƒˆ
  // é€ä¿¡æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã€ã™ãã«æ–°ã—ã„æç”»ã‚’å¯èƒ½ã«ã™ã‚‹
  hasSentData = false;
  console.log('ğŸ”“ é€ä¿¡ç›´å¾Œ: hasSentDataã‚’ãƒªã‚»ãƒƒãƒˆ - æ–°ã—ã„æç”»ã¨ä»–writerãƒ‡ãƒ¼ã‚¿å—ä¿¡ã‚’å†é–‹');
  
  // ğŸ”„ å—ä¿¡å´ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«é€ä¿¡è€…å´ã®ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ã¨è‡ªå‹•Clearå‡¦ç†ã‚’å®Ÿè¡Œ
  const totalAnimationTime = (animationStartWaitTime + 1 + rotationWaitTime + 2) * 1000; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹å¾…æ©Ÿ + å›è»¢1ç§’ + å›è»¢å¾Œå¾…æ©Ÿ + ã‚¹ãƒ©ã‚¤ãƒ‰2ç§’
  console.log(`ğŸ”„ é€ä¿¡å®Œäº† â†’ ${totalAnimationTime/1000}ç§’å¾Œï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œï¼‰ã«é€ä¿¡è€…ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ + è‡ªå‹•Clearå‡¦ç†ã‚’å®Ÿè¡Œ`);
  setTimeout(() => {
    // ğŸ”¸ é€ä¿¡è€…å´ã®ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œï¼‰
    otherWritersData = {};
    drawingCommands = []; // ğŸ”¥ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«è‡ªåˆ†ã®æç”»ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¯ãƒªã‚¢
    console.log('ğŸ§¹ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œ: å…¨æç”»ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢');
    console.log('ğŸ§¹ otherWritersDataé…å»¶ã‚¯ãƒªã‚¢:', Object.keys(otherWritersData).length);
    console.log('ğŸ§¹ drawingCommandsé…å»¶ã‚¯ãƒªã‚¢:', drawingCommands.length);
    
    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’å†æç”»ï¼ˆç©ºã®çŠ¶æ…‹ï¼‰- é…å»¶å®Ÿè¡Œ
    if (window.saveDoubleRotatedRedrawTimeout) {
      clearTimeout(window.saveDoubleRotatedRedrawTimeout);
    }
    
    window.saveDoubleRotatedRedrawTimeout = setTimeout(() => {
      redrawCanvasWithOthers();
      window.saveDoubleRotatedRedrawTimeout = null;
    }, 10);
    
    // å…¨æ›¸ãæ‰‹åŒæœŸã®ãŸã‚ã®ã‚¯ãƒªã‚¢å‘½ä»¤ã‚’é€ä¿¡
    socket.send(JSON.stringify({ 
      type: "globalClear",
      writerId: myWriterId,
      timestamp: Date.now()
    }));
    console.log('ğŸ“¤ è‡ªå‹•Clear: å…¨æ›¸ãæ‰‹ã«ã‚¯ãƒªã‚¢æŒ‡ç¤ºã‚’é€ä¿¡');
    console.log('âœ… è‡ªå‹•Clearå‡¦ç†å®Œäº†ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œï¼‰');
  }, totalAnimationTime); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«è‡ªå‹•Clearå®Ÿè¡Œ
  
  // ğŸ”¸ é€ä¿¡ãƒœã‚¿ãƒ³ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
  const sendButton = event.target;
  sendButton.style.transform = 'scale(0.95)';
  sendButton.style.backgroundColor = '#ff1493';
  sendButton.style.color = '#fff';
  sendButton.textContent = 'é€ä¿¡ä¸­...';
  sendButton.disabled = true;
  
  // ğŸ”¸ æ‰“ã¡ä¸Šã’èŠ±ç«æ¼”å‡ºã‚’è¿½åŠ ï¼ˆå—ä¿¡å´ã¨åŒæœŸï¼‰
  // å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œ1ç§’ã§å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã‚¿ã‚¤ãƒŸãƒ³ã‚°èª¿æ•´
  const fireworksCheckbox = document.getElementById('fireworksEffect');
  if (fireworksCheckbox.checked) {
    const fireworksDelay = animationStartWaitTime * 1000 + 2500; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹å¾…æ©Ÿæ™‚é–“ + å›è»¢æ™‚é–“(1.5ç§’) + 1ç§’
    setTimeout(() => {
      createFireworks();
    }, fireworksDelay);
  } else {
  }
  
  // ğŸ”¸ ç´™å¹é›ªæ¼”å‡ºã‚’è¿½åŠ ï¼ˆå—ä¿¡å´ã¨åŒæœŸï¼‰
  const confettiCheckbox = document.getElementById('confettiEffect');
  if (confettiCheckbox.checked) {
    const confettiDelay = animationStartWaitTime * 1000 + 2500 + (rotationWaitTime * 1000) - 1500; // èŠ±ç«ã¨åŒã˜ã‚¿ã‚¤ãƒŸãƒ³ã‚° + å›è»¢å¾Œå¾…æ©Ÿæ™‚é–“ - 1.5ç§’å‰
    setTimeout(() => {
      createConfetti();
    }, confettiDelay);
  } else {
  }
  
  // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
  setTimeout(() => {
    sendButton.style.transform = 'scale(1)';
    sendButton.style.backgroundColor = '';
    sendButton.style.color = '';
    sendButton.textContent = 'é€ä¿¡';
    sendButton.disabled = false;
  }, 2000);
  
  // ğŸ”¸ å°åˆ·å‡¦ç†ã¯æ—¢ã«ä¸Šã§å®Ÿè¡Œæ¸ˆã¿
  
  // ğŸ”¸ å°åˆ·å‡¦ç†é–‹å§‹ã®è¨­å®šæ™‚é–“å¾Œã«å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
  
  // è¨­å®šæ™‚é–“å¾Œã«WebSocketçµŒç”±ã§å—ä¿¡å´ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ã‚’é€šçŸ¥
  setTimeout(() => {
    if (socket && socket.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify({
        type: "startRotationAnimation",
        waitTime: rotationWaitTime, // å›è»¢å¾Œå¾…æ©Ÿæ™‚é–“ã‚’è¨­å®šå€¤ã‹ã‚‰å–å¾—
        fireworksEnabled: document.getElementById('fireworksEffect').checked,
        confettiEnabled: document.getElementById('confettiEffect').checked
      }));
    }
  }, animationStartWaitTime * 1000); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹å¾…æ©Ÿæ™‚é–“ï¼ˆç§’ã‚’ãƒŸãƒªç§’ã«å¤‰æ›ï¼‰
  
  // ğŸ”¸ é€ä¿¡ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã‹ã‚‰10ç§’å¾Œã«ã‚¯ãƒªã‚¢ã‚’å®Ÿè¡Œï¼ˆå°åˆ·ãŒå³åº§ã«é–‹å§‹ã•ã‚Œã‚‹ãŸã‚ï¼‰
  setTimeout(() => {
    
    // ğŸ”’ é€ä¿¡æ¸ˆã¿ãƒ•ãƒ©ã‚°ã¯ç¶­æŒï¼ˆæ‰‹å‹•ã§Clearãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¾ã§ä»–ã®writerãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ãªã„ï¼‰
    // hasSentData = false; // ã“ã®è¡Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
    
    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // èƒŒæ™¯ç”»åƒãŒã‚ã‚Œã°å†æç”»ï¼ˆå›è»¢ãªã—ï¼‰
    if (backgroundImage) {
      drawBackgroundImage(ctx, backgroundImage, canvas);
    }
    
    // å…¨ã¦ã®æç”»ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã‚¯ãƒªã‚¢
    drawingCommands = [];
    otherWritersData = {};
    
    // å—ä¿¡å´ã«ã‚‚ã‚¯ãƒªã‚¢æŒ‡ç¤ºã‚’é€ä¿¡
    if (socket && socket.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify({ type: "clear" }));
    }
    
  }, 10000); // é€ä¿¡ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã‹ã‚‰10ç§’å¾Œã«ã‚¯ãƒªã‚¢
}

// å®Ÿéš›ã®å°åˆ·å‡¦ç†ã‚’è¡Œã†é–¢æ•°
function actualPrintProcess() {
  try {
    // æ–°ã—ã„canvasã‚’ä½œæˆï¼ˆtaintedã«ãªã‚‰ãªã„ã‚ˆã†ã«ï¼‰
    const cleanCanvas = document.createElement('canvas');
    const cleanCtx = cleanCanvas.getContext('2d');
    cleanCanvas.width = canvas.width;
    cleanCanvas.height = canvas.height;
    
    // ç™½èƒŒæ™¯ã§å¡—ã‚Šã¤ã¶ã—ï¼ˆèƒŒæ™¯ç”»åƒã¯ä½¿ã‚ãªã„ï¼‰
    cleanCtx.fillStyle = '#ffffff';
    cleanCtx.fillRect(0, 0, cleanCanvas.width, cleanCanvas.height);
    
    // ä¿å­˜ã•ã‚ŒãŸæç”»ã‚³ãƒãƒ³ãƒ‰ã‚’å†å®Ÿè¡Œï¼ˆ360åº¦å›è»¢ = å…ƒã®å‘ãï¼‰
    if (drawingCommands.length > 0) {
      
      // æç”»ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œï¼ˆå›è»¢ãªã— = å…ƒã®å‘ãï¼‰
      drawingCommands.forEach(cmd => {
        if (cmd.type === 'start') {
          cleanCtx.beginPath();
          cleanCtx.moveTo(cmd.x, cmd.y);
        } else if (cmd.type === 'draw') {
          cleanCtx.lineWidth = cmd.thickness || 8;
          cleanCtx.strokeStyle = cmd.color || 'black';
          cleanCtx.lineTo(cmd.x, cmd.y);
          cleanCtx.stroke();
        }
      });
      
    } else {
      // æç”»ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
    }
    
    // è‡ªå‹•å°åˆ·å‡¦ç†
    const imageDataUrl = cleanCanvas.toDataURL('image/png');
    
    // WebSocketçµŒç”±ã§å—ä¿¡å´ã«å°åˆ·æŒ‡ç¤ºã‚’é€ä¿¡
    if (socket && socket.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify({
        type: "printRotatedImage",
        imageData: imageDataUrl,
        printType: 'double_rotated',
        paperSize: currentPaperSize,
        printMode: currentPrintMode,
        switchBotEnabled: document.getElementById('switchBotEffect').checked
      }));
    } else {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      const link = document.createElement('a');
      const now = new Date();
      const fileName = `double_rotated_${now.getFullYear()}${(now.getMonth() + 1)
        .toString().padStart(2, "0")}${now.getDate().toString().padStart(2, "0")}_${now
        .getHours().toString().padStart(2, "0")}${now.getMinutes().toString().padStart(2, "0")}${now
        .getSeconds().toString().padStart(2, "0")}.png`;
      
      link.download = fileName;
      link.href = imageDataUrl;
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
    }
    
    
  } catch (error) {
    console.error('âŒ æ›´ã«180åº¦å›è»¢ç”»åƒä¿å­˜ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.message, error);
    alert('æ›´ã«180åº¦å›è»¢ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

// ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ»ãƒ†ãƒ¼ãƒé–¢æ•°ç¾¤ (testSwitchBot, toggleTheme) ã¯ui-controls.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// èƒŒæ™¯ç”»åƒã®å¤‰å½¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
let backgroundScale = 1.0; // ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆå¤§ãã•ï¼‰
let backgroundOffsetY = 0; // å‚ç›´ã‚ªãƒ•ã‚»ãƒƒãƒˆ

// ğŸ¯ ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒ»åˆæœŸåŒ–å‡¦ç† (ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆ, DOMContentLoaded, ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ) ã¯event-handlers.jsã«ç§»å‹•ã—ã¾ã—ãŸ
</script>
</div>

<div class="color-panel">
  <h3>ãƒšãƒ³ã®è‰²</h3>
  <button class="color-btn selected" style="background: black;" onclick="setPenColor('black')"></button>
  <button class="color-btn" style="background: red;" onclick="setPenColor('red')"></button>
  <button class="color-btn" style="background: blue;" onclick="setPenColor('blue')"></button>
  <button class="color-btn" style="background: green;" onclick="setPenColor('green')"></button>
  <button class="color-btn" style="background: white; border: 4px solid red; box-sizing: border-box;" onclick="setPenColor('white-red-border')"></button>
</div>

<div class="thickness-panel">
  <h3>ãƒšãƒ³ã®å¤ªã•</h3>
  <button class="thickness-btn" onclick="setPenThickness(10)" title="å¤ªã„ (+30%)">
    <div style="width: 21px; height: 21px; border-radius: 50%; background: #333; flex-shrink: 0;"></div>
  </button>
  <button class="thickness-btn selected" onclick="setPenThickness(8)" title="æ¨™æº–">
    <div style="width: 16px; height: 16px; border-radius: 50%; background: #333; flex-shrink: 0;"></div>
  </button>
  <button class="thickness-btn" onclick="setPenThickness(6)" title="ç´°ã„ (-25%)">
    <div style="width: 12px; height: 12px; border-radius: 50%; background: #333; flex-shrink: 0;"></div>
  </button>
  <button class="thickness-btn" onclick="setPenThickness(4)" title="ã¨ã¦ã‚‚ç´°ã„ (-50%)">
    <div style="width: 8px; height: 8px; border-radius: 50%; background: #333; flex-shrink: 0;"></div>
  </button>
</div>

<!-- ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ã®é‡è¤‡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å‰Šé™¤ - ã‚·ãƒ³ãƒ—ãƒ«UI -->

</div>

<!-- è¦–è¦šã‚¨ãƒ•ã‚§ã‚¯ãƒˆæ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="effects.js"></script>

<!-- ç‰¹æ®Šã‚¨ãƒ•ã‚§ã‚¯ãƒˆæ©Ÿèƒ½ï¼ˆãƒãƒ¼ãƒˆãƒ»èŠ±ç«ãƒ»ç´™å¹é›ªï¼‰ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="special-effects.js"></script>

<!-- è¨­å®šãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="settings.js"></script>

<!-- WebSocketãƒ»é€šä¿¡æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="websocket.js"></script>

<!-- èƒŒæ™¯ãƒ»ã‚­ãƒ£ãƒ³ãƒã‚¹ç®¡ç†æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="canvas-background.js"></script>
<!-- é€ä¿¡å´å‹•ç”»æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="video-sender.js"></script>
<!-- éŸ³æ¥½ãƒ»éŸ³å£°æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="audio-music.js"></script>
<!-- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ»è¨ˆç®—æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="utils.js"></script>
<!-- æç”»ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="drawing-lines.js"></script>
<!-- é–‹ç™ºãƒ„ãƒ¼ãƒ«æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="dev-tools.js"></script>
<!-- UIåˆ¶å¾¡ãƒ»ãƒ†ãƒ¼ãƒæ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="ui-controls.js"></script>
<!-- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒ»åˆæœŸåŒ–æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="event-handlers.js"></script>

</body>
</html>
