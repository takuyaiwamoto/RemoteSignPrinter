<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self' wss://realtime-sign-server-1.onrender.com ws://localhost:* wss://localhost:*; img-src 'self' data: blob:; media-src 'self';">
  <title>é€ä¿¡å´2.9-fixed</title>
  <style>
    /* ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ã§ã®ã‚ºãƒ¼ãƒ é˜²æ­¢ */
    * {
      touch-action: manipulation; /* ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ ç„¡åŠ¹ */
    }
    
    html {
      -ms-touch-action: manipulation;
      touch-action: manipulation;
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
    }
    
    body {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    canvas {
      touch-action: none !important; /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã§ã®ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ å®Œå…¨ç„¡åŠ¹ */
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      /* ãƒšãƒ³å…¥åŠ›å°‚ç”¨ã®è¿½åŠ å¯¾ç­– */
      pointer-events: auto;
      -ms-touch-action: none;
      -webkit-user-drag: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    /* ã‚¯ãƒ©ã‚·ãƒƒã‚¯ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ */
    body.classic .main-container {
      display: flex;
      gap: 10px;
    }
    body.classic .canvas-container {
      flex: 1;
    }
    body.classic .color-panel {
      display: none; /* æ–°ã—ã„ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ç½®ãæ›ãˆã®ãŸã‚éè¡¨ç¤º */
    }
    body.classic .color-panel h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
    }
    body.classic .thickness-panel {
      display: none; /* æ–°ã—ã„ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ç½®ãæ›ãˆã®ãŸã‚éè¡¨ç¤º */
    }
    body.classic .thickness-panel h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
    }
    body.classic canvas {
      border: 1px solid black;
      display: block;
      margin-bottom: 10px;
      max-width: 100%;
      width: 283px; /* èƒŒæ™¯ç”»åƒã¨åŒã˜ã‚µã‚¤ã‚ºã«å›ºå®š */
      height: 420px;
      aspect-ratio: 283 / 420; /* èƒŒæ™¯ç”»åƒã®æ¯”ç‡ã«ä¿®æ­£ */
    }
    body.classic button {
      margin-right: 5px;
      margin-bottom: 5px;
    }
    body.classic .button-group {
      margin-bottom: 10px;
    }
    body.classic .button-group label {
      font-weight: bold;
      margin-right: 10px;
    }
    
    /* ãƒ¢ãƒ€ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
    body.modern {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    
    body.modern .main-container {
      position: relative;
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(10px);
      display: flex;
      gap: 10px;
    }
    
    body.modern .canvas-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    body.modern .main-controls {
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 80px 0 15px 0; /* ä¸Šãƒãƒ¼ã‚¸ãƒ³ã‚’å¤§å¹…ã«å¢—åŠ  */
      position: relative;
      z-index: 1000; /* èƒŒæ™¯ç”»åƒã‚ˆã‚Šå‰é¢ã« */
    }
    
    body.modern .pen-controls {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 30px;
      margin: 15px 0;
    }
    
    body.modern .pen-colors {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    body.modern .pen-thickness {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    body.modern .background-controls {
      width: 100%;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0;
    }
    
    body.modern .color-panel {
      display: none; /* æ–°ã—ã„ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ç½®ãæ›ãˆã®ãŸã‚éè¡¨ç¤º */
    }
    
    body.modern .color-panel h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      color: #2d3748;
      text-align: center;
    }
    
    body.modern .thickness-panel {
      display: none; /* æ–°ã—ã„ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ç½®ãæ›ãˆã®ãŸã‚éè¡¨ç¤º */
    }
    
    body.modern .thickness-panel h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      color: #2d3748;
      text-align: center;
    }
    
    body.modern canvas {
      border: none;
      border-radius: 15px;
      display: block;
      margin: 0 auto 20px auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      background: white;
      max-width: 100%;
      width: 100%; /* ã‚ˆã‚Šå¤§ããè¡¨ç¤º */
      height: auto;
      aspect-ratio: 859 / 607; /* å…ƒã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’å›ºå®š */
    }
    
    body.modern button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 10px 20px;
      margin: 5px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    body.modern button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }
    
    body.modern button:active {
      transform: translateY(0);
    }
    
    body.modern .button-group {
      background: rgba(255, 255, 255, 0.7);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    body.modern .button-group label {
      font-weight: 700;
      margin-right: 15px;
      color: #2d3748;
      font-size: 16px;
    }
    
    body.modern h1 {
      text-align: center;
      color: #2d3748;
      font-size: 2.5rem;
      margin-bottom: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 800;
    }
    body.modern #countdown {
      font-size: 32px;
      background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-top: 20px;
      text-align: center;
      font-weight: 800;
    }
    
    body.classic #countdown {
      font-size: 24px;
      color: red;
      margin-top: 10px;
    }
    
    body.modern .selected {
      background: linear-gradient(135deg, #48bb78, #38a169) !important;
      color: white;
      box-shadow: 0 6px 20px rgba(72, 187, 120, 0.5) !important;
    }
    
    body.classic .selected {
      background-color: #4CAF50;
      color: white;
    }
    
    /* ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
    #themeToggle {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 12px 20px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      transition: all 0.3s ease;
    }
    
    #themeToggle:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    /* ãƒ¢ãƒ€ãƒ³ãªé–‹ç™ºãƒ„ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
    body.modern #devToolsPanel {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 20px;
      padding: 25px;
      margin-top: 20px;
      border: 2px solid rgba(102, 126, 234, 0.2);
      backdrop-filter: blur(10px);
    }
    
    body.modern #devToolsPanel h3 {
      color: #2d3748;
      margin-bottom: 20px;
      font-size: 1.5rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    body.modern input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      accent-color: #667eea;
    }
    body.modern .color-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, 0.8);
      margin: 0;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    body.modern .color-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }
    
    body.modern .color-btn.selected {
      border: 4px solid #ffffff;
      box-shadow: 0 0 0 3px #2d3748, 0 0 20px 5px rgba(45, 55, 72, 0.6), 0 8px 30px rgba(0, 0, 0, 0.4);
      transform: scale(1.15);
      background: attr(style) !important;
    }
    
    /* å„è‰²ãƒœã‚¿ãƒ³ã®é¸æŠæ™‚ã®èƒŒæ™¯è‰²ã‚’å€‹åˆ¥ã«æŒ‡å®š */
    body.modern .color-btn.selected[style*="background: black"] {
      background: black !important;
    }
    
    body.modern .color-btn.selected[style*="background: red"] {
      background: red !important;
    }
    
    body.modern .color-btn.selected[style*="background: blue"] {
      background: blue !important;
    }
    
    body.modern .color-btn.selected[style*="background: green"] {
      background: green !important;
    }
    
    /* ãƒšãƒ³ã®å¤ªã•ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    body.modern .thickness-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, 0.8);
      margin: 0;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    body.modern .thickness-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }
    
    body.modern .thickness-btn.selected {
      border: 4px solid #ffffff;
      box-shadow: 0 0 0 3px #2d3748, 0 0 20px 5px rgba(45, 55, 72, 0.6), 0 8px 30px rgba(0, 0, 0, 0.4);
      transform: scale(1.15);
      background: rgba(255, 255, 255, 1);
    }
    
    body.classic .color-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid #ccc;
      margin: 0;
      cursor: pointer;
    }
    
    body.classic .color-btn.selected {
      border: 3px solid #ffffff;
      box-shadow: 0 0 0 2px #333, 0 0 15px 3px rgba(51, 51, 51, 0.7), 0 4px 20px rgba(0,0,0,0.6);
      transform: scale(1.1);
    }
    
    /* ã‚¯ãƒ©ã‚·ãƒƒã‚¯ - å„è‰²ãƒœã‚¿ãƒ³ã®é¸æŠæ™‚ã®èƒŒæ™¯è‰²ã‚’å€‹åˆ¥ã«æŒ‡å®š */
    body.classic .color-btn.selected[style*="background: black"] {
      background: black !important;
    }
    
    body.classic .color-btn.selected[style*="background: red"] {
      background: red !important;
    }
    
    body.classic .color-btn.selected[style*="background: blue"] {
      background: blue !important;
    }
    
    body.classic .color-btn.selected[style*="background: green"] {
      background: green !important;
    }
    
    /* ã‚¯ãƒ©ã‚·ãƒƒã‚¯ - ãƒšãƒ³ã®å¤ªã•ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    body.classic .thickness-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid #ccc;
      margin: 0;
      cursor: pointer;
      background: #f9f9f9;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    body.classic .thickness-btn.selected {
      border: 3px solid #ffffff;
      box-shadow: 0 0 0 2px #333, 0 0 15px 3px rgba(51, 51, 51, 0.7), 0 4px 20px rgba(0,0,0,0.6);
      transform: scale(1.1);
      background: #ffffff;
    }
    .thickness-btn {
      min-width: 60px;
      padding: 5px 10px;
    }
    .thickness-btn.selected {
      background-color: #2196F3;
      color: white;
    }
    .star {
      position: absolute;
      width: 16px;
      height: 16px;
      background: gold;
      pointer-events: none;
      animation: starTwinkle 1s ease-out forwards;
      z-index: 10;
      clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
    }
    
    /* æ›¸ãæ‰‹å´æ˜Ÿã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”¨CSS */
    .sender-star {
      position: fixed;
      width: 16px;
      height: 16px;
      background: gold;
      pointer-events: none;
      animation: senderStarTwinkle 1s ease-out forwards;
      z-index: 10000;
      clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
    }
    
    @keyframes starTwinkle {
      0% {
        opacity: 1;
        transform: scale(0) rotate(0deg) translateX(0px) translateY(0px);
        filter: blur(0px);
      }
      30% {
        opacity: 1;
        transform: scale(1.2) rotate(180deg) translateX(10px) translateY(-10px);
        filter: blur(0px);
      }
      60% {
        opacity: 0.7;
        transform: scale(1.0) rotate(270deg) translateX(20px) translateY(-20px);
        filter: blur(1px);
      }
      85% {
        opacity: 0.3;
        transform: scale(0.6) rotate(330deg) translateX(25px) translateY(-25px);
        filter: blur(2px);
      }
      100% {
        opacity: 0;
        transform: scale(0.2) rotate(360deg) translateX(30px) translateY(-30px);
        filter: blur(3px);
      }
    }
    
    @keyframes senderStarTwinkle {
      0% {
        opacity: 1;
        transform: scale(0) rotate(0deg) translateX(0px) translateY(0px);
        filter: blur(0px);
      }
      30% {
        opacity: 1;
        transform: scale(1.2) rotate(180deg) translateX(10px) translateY(-10px);
        filter: blur(0px);
      }
      60% {
        opacity: 0.7;
        transform: scale(1.0) rotate(270deg) translateX(20px) translateY(-20px);
        filter: blur(1px);
      }
      85% {
        opacity: 0.3;
        transform: scale(0.6) rotate(330deg) translateX(25px) translateY(-25px);
        filter: blur(2px);
      }
      100% {
        opacity: 0;
        transform: scale(0.2) rotate(360deg) translateX(30px) translateY(-30px);
        filter: blur(3px);
      }
    }
    .fairy-dust {
      position: absolute;
      width: 3px;
      height: 3px;
      background: #fff;
      border-radius: 50%;
      pointer-events: none;
      animation: fairyDustTwinkle 3s ease-in-out forwards;
      z-index: 9;
      box-shadow: 0 0 8px #fff, 0 0 16px #fff, 0 0 24px #fff;
    }
    @keyframes fairyDustTwinkle {
      0% {
        opacity: 0;
        transform: scale(0) translateX(0px) translateY(0px);
        filter: blur(2px);
      }
      15% {
        opacity: 0.7;
        transform: scale(0.5) translateX(3px) translateY(-3px);
        filter: blur(1px);
      }
      30% {
        opacity: 1;
        transform: scale(1) translateX(8px) translateY(-8px);
        filter: blur(0px);
      }
      60% {
        opacity: 0.9;
        transform: scale(0.9) translateX(15px) translateY(-15px);
        filter: blur(0.5px);
      }
      80% {
        opacity: 0.5;
        transform: scale(0.6) translateX(20px) translateY(-20px);
        filter: blur(1.5px);
      }
      100% {
        opacity: 0;
        transform: scale(0.2) translateX(25px) translateY(-25px);
        filter: blur(3px);
      }
    }
    .heart {
      position: fixed;
      width: 25px;
      height: 25px;
      background: #ff69b4;
      right: 50px;
      bottom: 20px;
      pointer-events: none;
      z-index: 10000;
      transform: rotate(45deg);
    }
    .heart::before,
    .heart::after {
      content: '';
      width: 25px;
      height: 25px;
      position: absolute;
      background: #ff69b4;
      border-radius: 50%;
    }
    .heart::before {
      top: -12.5px;
      left: 0;
    }
    .heart::after {
      top: 0;
      left: -12.5px;
    }
    
    /* æç”»ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”¨ã®å°ã•ãªãƒãƒ¼ãƒˆ */
    .drawing-heart {
      position: fixed;
      width: 12px;
      height: 12px;
      background: var(--heart-color, #ff1493);
      pointer-events: none;
      z-index: 10000;
      transform: rotate(45deg);
      animation: heartFloat 1.5s ease-out forwards;
      box-shadow: 0 0 8px var(--heart-color, #ff1493), 0 0 16px var(--heart-color, #ff1493);
    }
    .drawing-heart::before,
    .drawing-heart::after {
      content: '';
      width: 12px;
      height: 12px;
      position: absolute;
      background: var(--heart-color, #ff1493);
      border-radius: 50%;
    }
    .drawing-heart::before {
      top: -6px;
      left: 0;
    }
    .drawing-heart::after {
      top: 0;
      left: -6px;
    }
    
    @keyframes heartFloat {
      0% {
        opacity: 1;
        transform: rotate(45deg) scale(0.3) translateY(0px);
      }
      50% {
        opacity: 0.8;
        transform: rotate(45deg) scale(1) translateY(-20px);
      }
      100% {
        opacity: 0;
        transform: rotate(45deg) scale(0.5) translateY(-50px);
      }
    }
    
    /* ç‰¹åˆ¥æ¼”å‡ºç”¨ã®å¤§ããªãƒãƒ¼ãƒˆ */
    .special-heart {
      position: fixed;
      width: 120px;
      height: 120px;
      background: #ff1493;
      pointer-events: none;
      z-index: 99999;
      transform: rotate(45deg);
      box-shadow: 0 0 20px #ff1493, 0 0 40px #ff1493, 0 0 60px #ff1493;
    }
    .special-heart::before,
    .special-heart::after {
      content: '';
      width: 120px;
      height: 120px;
      position: absolute;
      background: #ff1493;
      border-radius: 50%;
      box-shadow: 0 0 20px #ff1493;
    }
    .special-heart::before {
      top: -60px;
      left: 0;
    }
    .special-heart::after {
      top: 0;
      left: -60px;
    }
    
    /* PCç”»é¢ã§ã®æ–°ã—ã„ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    body.classic .canvas-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }
    
    body.classic .main-controls {
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
    }
    
    body.classic .pen-controls {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin: 10px 0;
    }
    
    body.classic .pen-colors {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    body.classic .pen-thickness {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    body.classic .background-controls {
      width: 100%;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    
    /* ç¸¦å‘ãã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    @media screen and (orientation: portrait) and (max-width: 1024px) {
      body {
        margin: 0;
        padding: 0;
        overflow-x: hidden;
      }
      
      .main-container {
        display: flex;
        flex-direction: column;
        padding: 10px;
        height: 100vh;
        box-sizing: border-box;
      }
      
      .canvas-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        margin-bottom: 10px;
      }
      
      #drawCanvas {
        width: 100% !important; /* ãƒ”ãƒ³ã‚¯ã‚¨ãƒªã‚¢ã¨åŒã˜ã‚µã‚¤ã‚ºã«å›ºå®š */
        height: 100% !important;
        transform: scale(1.3) !important; /* ãƒ”ãƒ³ã‚¯ã‚¨ãƒªã‚¢ã¨åŒã˜ã‚¹ã‚±ãƒ¼ãƒ« */
        transform-origin: center !important;
        margin: 0 auto;
      }
      
      /* ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
      .button-group {
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin-bottom: 10px;
      }
      
      /* é€ä¿¡ãƒ»ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã¯å¤§ãã */
      .canvas-container > .button-group:first-of-type button {
        font-size: 16px;
        padding: 15px 25px;
        min-width: 120px;
      }
      
      /* è‰²ã¨ãƒšãƒ³ã®ãƒ‘ãƒãƒ«ã‚’æ¨ªä¸¦ã³ã« */
      .color-panel, .thickness-panel {
        display: none !important; /* æ—¢å­˜ã®ãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤º */
      }
      
      /* è‰²ãƒ»ãƒšãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Œå…¨ã«éè¡¨ç¤º */
      .color-thickness-section {
        display: none !important; /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã‚‚éè¡¨ç¤º */
      }
      
      .color-row, .thickness-row {
        display: flex;
        justify-content: space-around;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      
      .color-row label, .thickness-row label {
        width: 100%;
        text-align: center;
        font-weight: bold;
        margin-bottom: 5px;
      }
      
      /* Dev Toolsãƒœã‚¿ãƒ³ã‚’å³ä¸‹ã«å›ºå®š */
      .button-group:has(button[onclick*="toggleDevTools"]) {
        position: fixed;
        bottom: 10px;
        right: 10px;
        margin: 0;
        z-index: 1000;
      }
      
      /* èƒŒæ™¯é¸æŠãƒœã‚¿ãƒ³ã‚’å°ã•ã */
      .button-group:has(button[onclick*="setBackground"]) {
        font-size: 12px;
      }
      
      /* ğŸ“± ç¸¦å‘ãã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’æ¨ªåˆ—ã«å¤‰æ›´ */
      .right-sidebar {
        flex-direction: column !important;
        gap: 50px !important; /* è‰²ã¨å¤ªã•ã®é–“ã«50pxã®é–“éš” */
        justify-content: center !important;
        align-items: center !important;
        width: 100% !important;
        margin-top: 30px !important; /* clearãƒœã‚¿ãƒ³ã‹ã‚‰ä¸‹ã«30px */
      }
      
      .pen-colors-vertical, .pen-thickness-vertical {
        flex-direction: row !important; /* ç¸¦åˆ—ã‹ã‚‰æ¨ªåˆ—ã«å¤‰æ›´ */
        gap: 15px !important;
        align-items: center !important;
      }
      
      .pen-colors-vertical h4, .pen-thickness-vertical h4 {
        margin: 0 15px 0 0 !important;
      }
      
      .button-group:has(button[onclick*="setBackground"]) button {
        padding: 8px 12px;
        font-size: 12px;
      }
      
      /* Writer IDã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¸Šéƒ¨ã«å›ºå®š */
      #writerStatus {
        position: fixed;
        top: 5px;
        right: 5px;
        z-index: 1001;
        font-size: 12px;
        padding: 5px 10px;
      }
      
      /* ãƒ†ãƒ¼ãƒãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã‚’å·¦ä¸Šã« */
      #themeToggle {
        position: fixed;
        top: 5px;
        left: 5px;
        z-index: 1001;
        padding: 5px 10px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body class="modern">
<button id="themeToggle" onclick="toggleTheme()">ğŸ“ ã‚¯ãƒ©ã‚·ãƒƒã‚¯</button>

<div class="main-container" style="display: flex; justify-content: center; align-items: flex-start; gap: 20px;">
<div class="canvas-container">
<div style="position: relative; display: inline-block; margin: 50px auto 20px auto;">
  <img src="back2.png" alt="èƒŒæ™¯ç”»åƒ" style="transform: scale(1.3); display: block;">
  <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: pink; transform: scale(1.3); transform-origin: center;"></div>
  <canvas id="drawCanvas" width="283" height="420" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scale(1.3); transform-origin: center; cursor: crosshair; background: transparent;"></canvas>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«: Clearã€è‡ªåˆ†ã ã‘å‰Šé™¤ã€é€ä¿¡ -->
<div class="main-controls">
  <button onclick="clearCanvas()">Clear</button>
  <button onclick="clearMyDrawing()" style="background-color: #FF6B6B; color: white;">è‡ªåˆ†ã ã‘æ¶ˆå»</button>
  <button onclick="saveDoubleRotatedImage()" style="background-color: #4CAF50; color: white; font-size: 18px; padding: 12px 24px; font-weight: bold;">æ¸¡ã™</button>
</div>

</div>

<!-- å³ã‚µã‚¤ãƒ‰ãƒãƒ¼: ãƒšãƒ³ã®è‰²ã¨å¤ªã•ã‚’ä¸¦ã¹ã¦é…ç½® -->
<div class="right-sidebar" style="display: flex; gap: 15px; margin-top: 20px;">
  <!-- å·¦åˆ—: è‰² -->
  <div class="pen-colors-vertical" style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
    <h4 style="margin: 0; font-size: 16px; color: #333;">è‰²</h4>
    <button class="color-btn selected" style="background: black; width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ccc;" onclick="setPenColor('black')"></button>
    <button class="color-btn" style="background: red; width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ccc;" onclick="setPenColor('red')"></button>
    <button class="color-btn" style="background: blue; width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ccc;" onclick="setPenColor('blue')"></button>
    <button class="color-btn" style="background: green; width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ccc;" onclick="setPenColor('green')"></button>
    <button class="color-btn" style="background: white; border: 4px solid red; box-sizing: border-box; width: 50px; height: 50px; border-radius: 50%;" onclick="setPenColor('white-red-border')"></button>
  </div>
  
  <!-- å³åˆ—: å¤ªã• -->
  <div class="pen-thickness-vertical" style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
    <h4 style="margin: 0; font-size: 16px; color: #333;">å¤ªã•</h4>
    <button class="thickness-btn" onclick="setPenThickness(10)" title="å¤ªã„ (+30%)" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ccc; background: white; display: flex; align-items: center; justify-content: center;">
      <div style="width: 21px; height: 21px; border-radius: 50%; background: #333;"></div>
    </button>
    <button class="thickness-btn" onclick="setPenThickness(8)" title="æ¨™æº–" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ccc; background: white; display: flex; align-items: center; justify-content: center;">
      <div style="width: 16px; height: 16px; border-radius: 50%; background: #333;"></div>
    </button>
    <button class="thickness-btn selected" onclick="setPenThickness(6)" title="ç´°ã„ (-25%)" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid #333; background: white; display: flex; align-items: center; justify-content: center;">
      <div style="width: 12px; height: 12px; border-radius: 50%; background: #333;"></div>
    </button>
    <button class="thickness-btn" onclick="setPenThickness(4)" title="ã¨ã¦ã‚‚ç´°ã„ (-50%)" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ccc; background: white; display: flex; align-items: center; justify-content: center;">
      <div style="width: 8px; height: 8px; border-radius: 50%; background: #333;"></div>
    </button>
  </div>
</div>
</div>

<!-- èƒŒæ™¯é¸æŠã¯DevToolã«ç§»å‹• -->




<div class="button-group">
  <button onclick="toggleDevTools()" style="background-color: #FFA500; color: white;">ğŸ”§ Dev Tool</button>
</div>

<div id="devTools" style="display: none; border: 2px solid orange; padding: 10px; margin-top: 10px;">
  <h3>é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«</h3>
  
  <div class="button-group">
    <label>ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºèª¿æ•´:</label>
    <input type="range" id="canvasScale" min="0.1" max="3.0" step="0.05" value="0.7" oninput="updateCanvasScale(this.value)">
    <span id="canvasScaleValue">0.7x</span>
  </div>
  
  <div class="button-group">
    <label>ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹å¾…æ©Ÿæ™‚é–“ï¼ˆç§’ï¼‰:</label>
    <input type="range" id="animationStartWait" min="0.1" max="10" step="0.1" value="3.3" oninput="updateAnimationStartWait(this.value)">
    <span id="animationStartWaitValue">3.3ç§’</span>
  </div>
  
  <div class="button-group">
    <label>å›è»¢å¾Œå¾…æ©Ÿæ™‚é–“ï¼ˆç§’ï¼‰:</label>
    <input type="range" id="rotationWait" min="1" max="10" step="0.5" value="7.5" oninput="updateRotationWait(this.value)">
    <span id="rotationWaitValue">7.5ç§’</span>
  </div>
  
  <div class="button-group">
    <button onclick="sendDevSettings()">è¨­å®šã‚’å—ä¿¡å´ã«é€ä¿¡</button>
  </div>
  
  <div class="button-group">
    <label>èƒŒæ™¯é¸æŠ:</label>
    <button onclick="setBackground('./back3.png')">èƒŒæ™¯1</button>
    <button onclick="setBackground('./back2.png')">èƒŒæ™¯2</button>
    <button onclick="setBackground('./back4.png')">èƒŒæ™¯3</button>
    <button onclick="setBackground('./back6.png')">èƒŒæ™¯4</button>
    <button onclick="setBackground(null)">ç™½</button>
    <button onclick="setSpecialBackgroundToggle()" style="background: linear-gradient(45deg, #ff1493, #00ffff); color: white;">ğŸ¬ å‹•ç”»èƒŒæ™¯</button>
  </div>
  
  <hr style="margin: 15px 0;">
  
  <div class="button-group">
    <label>ãƒ†ã‚¹ãƒˆæ¼”å‡º:</label>
    <button onclick="createFireworks()" style="background: linear-gradient(45deg, #ff4500, #ffd700); color: white;">ğŸ† èŠ±ç«ãƒ†ã‚¹ãƒˆ</button>
    <button onclick="createConfetti()" style="background: linear-gradient(45deg, #ff69b4, #00fa9a); color: white;">ğŸŠ ç´™å¹é›ªãƒ†ã‚¹ãƒˆ</button>
  </div>
  
  <div class="button-group">
    <label>ãƒ“ãƒ‡ã‚ªã‚µã‚¤ã‚º:</label>
    <button id="size100Btn" class="selected" onclick="setVideoSize(100)">100%</button>
    <button id="size90Btn" onclick="setVideoSize(90)">90%</button>
    <button id="size80Btn" onclick="setVideoSize(80)">80%</button>
  </div>
  
  <div class="button-group">
    <button onclick="playVideo()" style="background-color: #FF6B6B; color: white;">ğŸ“¹ ãƒ“ãƒ‡ã‚ªå†ç”Ÿ</button>
  </div>
  
  <div class="button-group">
    <label>ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ:</label>
    <input type="checkbox" id="starEffect" checked onchange="toggleStarEffect()">
    <label for="starEffect">æ˜Ÿ</label>
    <input type="checkbox" id="fairyDustEffect" onchange="toggleFairyDustEffect()" checked>
    <label for="fairyDustEffect">å¦–ç²¾ã®ç²‰</label>
    <input type="checkbox" id="heartEffect" onchange="toggleHeartEffect()">
    <label for="heartEffect">ğŸ’– ãƒãƒ¼ãƒˆ</label>
    <input type="checkbox" id="penSoundEffect" onchange="togglePenSound()">
    <label for="penSoundEffect">ğŸµ ãƒšãƒ³éŸ³</label>
  </div>
  
  <div class="button-group">
    <label>é€ä¿¡å¾Œæ¼”å‡º:</label>
    <input type="checkbox" id="fireworksEffect" checked>
    <label for="fireworksEffect">ğŸ† èŠ±ç«</label>
    <input type="checkbox" id="confettiEffect" checked>
    <label for="confettiEffect">ğŸŠ ç´™å¹é›ª</label>
    <input type="checkbox" id="backgroundDebug" onchange="toggleBackgroundDebug()">
    <label for="backgroundDebug">ğŸ” èƒŒæ™¯ãƒ‡ãƒãƒƒã‚°</label>
  </div>
  
  <div class="button-group">
    <label>ç”¨ç´™ã‚µã‚¤ã‚º:</label>
    <button id="a4Btn" class="selected" onclick="setPaperSize('A4')">A4</button>
    <button id="lBtn" onclick="setPaperSize('L')">Låˆ¤</button>
    <button id="posterBtn" onclick="setPaperSize('poster')">ãƒã‚¹ãƒˆã‚«ãƒ¼ãƒ‰</button>
  </div>
  
  <div class="button-group">
    <label>å°åˆ·ãƒ¢ãƒ¼ãƒ‰:</label>
    <button id="drawOnlyBtn" class="selected" onclick="setPrintMode('drawOnly')">æç”»ãƒ¢ãƒ¼ãƒ‰</button>
    <button id="fullModeBtn" onclick="setPrintMode('fullMode')">ãƒ•ãƒ«ãƒ¢ãƒ¼ãƒ‰</button>
  </div>
  
  <hr style="margin: 15px 0;">
  
  <div class="button-group">
    <label>SwitchBot:</label>
    <input type="checkbox" id="switchBotEffect">
    <label for="switchBotEffect">ğŸ¤– ãƒãƒ–ãƒ«</label>
  </div>
  
  <div class="button-group">
    <button onclick="testSwitchBot()" style="background-color: #FF6B35; color: white;">ğŸ¤– Botãƒ†ã‚¹ãƒˆ</button>
  </div>
  
  <div class="button-group">
    <label>åº§æ¨™ãƒ†ã‚¹ãƒˆ:</label>
    <button onclick="testDrawRightBottom()" style="background-color: #FF1493; color: white;">ãƒ†ã‚¹ãƒˆå³ä¸‹</button>
  </div>
</div>

<div id="countdown"></div>

<script>
const canvas = document.getElementById("drawCanvas");
// console.log('ğŸ¯ canvasè¦ç´ å–å¾—çµæœ:', canvas);
// console.log('ğŸ¯ canvasè¦ç´ ã®ID:', canvas ? canvas.id : 'canvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„');

const ctx = canvas.getContext("2d");
// console.log('ğŸ¯ 2Dã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå–å¾—çµæœ:', ctx);
let drawing = false;
let socket = new WebSocket("wss://realtime-sign-server-1.onrender.com");
let myWriterId = null; // è‡ªåˆ†ã®writer ID
let otherWritersData = {}; // ä»–ã®åŸ·ç­†è€…ã®ãƒ‡ãƒ¼ã‚¿

// æç”»çŠ¶æ…‹ç®¡ç†ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let isPaintDrawing = false;
let lastPaintPos = null;

// èƒŒæ™¯ç”»åƒã®ç¯„å›²ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰
// getBackgroundAreaé–¢æ•°ã¯canvas-background.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// isWithinBackgroundAreaé–¢æ•°ã¯canvas-background.jsã«ç§»å‹•ã—ã¾ã—ãŸ

let mySessionId = null; // ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºæœ‰ID
let backgroundImage = null;
let currentPaperSize = "A4"; // ç¾åœ¨ã®ç”¨ç´™ã‚µã‚¤ã‚º
let currentPrintMode = "drawOnly"; // ç¾åœ¨ã®å°åˆ·ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šæç”»ãƒ¢ãƒ¼ãƒ‰ï¼‰
let currentVideoSize = 100; // ç¾åœ¨ã®ãƒ“ãƒ‡ã‚ªã‚µã‚¤ã‚ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ100%ï¼‰
let canvasScale = 0.7; // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¹ã‚±ãƒ¼ãƒ«
let animationStartWaitTime = 3.3; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹å¾…æ©Ÿæ™‚é–“
let rotationWaitTime = 7.5; // å›è»¢å¾Œå¾…æ©Ÿæ™‚é–“
let currentPenThickness = 6; // ç¾åœ¨ã®ãƒšãƒ³ã®å¤ªã•ï¼ˆç´°ã„ï¼‰
let currentPenColor = 'black'; // ç¾åœ¨ã®ãƒšãƒ³ã®è‰²
let hasSentData = false; // é€ä¿¡æ¸ˆã¿ãƒ•ãƒ©ã‚°
// WriterIDåˆ¥ã®æç”»çŠ¶æ…‹ç®¡ç†ï¼ˆæ›¸ãæ‰‹å´ç”¨ï¼‰
const writerDrawingStates = {};

// ç¾åœ¨ã®æ›¸ãæ‰‹ç”¨ã®ãƒ¬ã‚¬ã‚·ãƒ¼å¤‰æ•°ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ä¿æŒï¼‰
let lastPosition = null; // å‰å›ã®ä½ç½®ã‚’è¨˜éŒ²
// secondLastPositionå¤‰æ•°ã‚’å‰Šé™¤ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ï¼‰
let currentPath = []; // ç¾åœ¨ã®ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã®ãƒã‚¤ãƒ³ãƒˆé…åˆ—
let smoothingFactor = 0.3; // æ›²ç·šã®æ»‘ã‚‰ã‹ã•ï¼ˆ0-1ã®ç¯„å›²ï¼‰

// ãƒ™ã‚¸ã‚§æ›²ç·šè£œé–“ç”¨ã®ç‚¹å±¥æ­´
let pointHistory = []; // æœ€æ–°3ç‚¹ã‚’ä¿æŒã—ã¦ãƒ™ã‚¸ã‚§æ›²ç·šã‚’æç”»
const MAX_POINT_HISTORY = 3; // ä¿æŒã™ã‚‹ç‚¹ã®æœ€å¤§æ•°
let starEffectEnabled = true; // æ˜Ÿã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®æœ‰åŠ¹/ç„¡åŠ¹ï¼ˆæ¨™æº–ã§ONï¼‰
let fairyDustEffectEnabled = true; // å¦–ç²¾ã®ç²‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®æœ‰åŠ¹/ç„¡åŠ¹ï¼ˆæ¨™æº–ã§ONï¼‰
let heartEffectEnabled = false; // ãƒãƒ¼ãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®æœ‰åŠ¹/ç„¡åŠ¹ï¼ˆæ¨™æº–ã§OFFï¼‰
let penSoundEnabled = false; // ãƒšãƒ³éŸ³ã®æœ‰åŠ¹/ç„¡åŠ¹ï¼ˆæ¨™æº–ã§OFFï¼‰
let specialBackgroundState = 'ready'; // 'ready', 'door_shown', 'door_opened'
let specialBackgroundToggle = false; // ç‰¹æ®ŠèƒŒæ™¯ã®ç”»åƒã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ãƒ•ãƒ©ã‚°

// ğŸ¬ é€ä¿¡å´å‹•ç”»èƒŒæ™¯é–¢é€£å¤‰æ•°
let senderVideoElement = null;
let isSenderVideoActive = false;

// ğŸµ ãƒšãƒ³éŸ³åˆ¶å¾¡
let drawingAudio = null; // æç”»ä¸­ã®éŸ³æ¥½ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
let isDrawingActive = false; // æç”»ä¸­ãƒ•ãƒ©ã‚°
let drawingInactiveTimer = null; // æç”»åœæ­¢ã‚¿ã‚¤ãƒãƒ¼
const DRAWING_PAUSE_DELAY = 500; // æç”»åœæ­¢ã‹ã‚‰ä¸€æ™‚åœæ­¢ã¾ã§ã®é…å»¶ï¼ˆãƒŸãƒªç§’ï¼‰

// ğŸ” èƒŒæ™¯ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºåˆ¶å¾¡
let backgroundDebugEnabled = false;
let lastBackgroundSrc = null;

// èƒŒæ™¯åˆ¥ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºè¨­å®šï¼ˆ1.02å€ã‚µã‚¤ã‚º = 0.6*1.7ï¼‰
const backgroundSizes = {
  'back3': { width: 859, height: 607 },    // èƒŒæ™¯1 - çµ±ä¸€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯” (859/607 â‰ˆ 1.415)
  'back2': { width: 859, height: 607 },    // èƒŒæ™¯2 - çµ±ä¸€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã«å¤‰æ›´
  'back4': { width: 859, height: 607 },    // èƒŒæ™¯3 - çµ±ä¸€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”
  'back5': { width: 859, height: 607 },    // èƒŒæ™¯5 - çµ±ä¸€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”
  'back6': { width: 859, height: 607 },    // èƒŒæ™¯4 - çµ±ä¸€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”
  'white': { width: 859, height: 607 }     // ç™½èƒŒæ™¯ - çµ±ä¸€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”
};

// ğŸš€ éä¾µå…¥çš„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼
// æ—¢å­˜æ©Ÿèƒ½ã‚’ä¸€åˆ‡å¤‰æ›´ã›ãšã€è¿½åŠ ã®ã¿ã§æœ€é©åŒ–
let performanceOptimizer = {
  lastMouseTime: 0,
  lastTouchTime: 0,
  pendingEffects: [],
  effectAnimationId: null,
  MOUSE_THROTTLE_INTERVAL: 16, // PCç”¨: 60fpsç›¸å½“
  TOUCH_THROTTLE_INTERVAL: 8,  // Redmi Pad 2è»½é‡åŒ–: 360Hzâ†’120Hzç›¸å½“ï¼ˆ125fpsï¼‰
  
  // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ãƒã‚§ãƒƒã‚¯ï¼ˆPCç”¨ï¼‰
  shouldProcessMouseEvent() {
    const now = Date.now();
    if (now - this.lastMouseTime < this.MOUSE_THROTTLE_INTERVAL) {
      return false;
    }
    this.lastMouseTime = now;
    return true;
  },
  
  // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ãƒã‚§ãƒƒã‚¯ï¼ˆRedmi Pad 2æœ€é©åŒ–ï¼‰
  shouldProcessTouchEvent() {
    const now = Date.now();
    if (now - this.lastTouchTime < this.TOUCH_THROTTLE_INTERVAL) {
      return false;
    }
    this.lastTouchTime = now;
    return true;
  },
  
  // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå‡¦ç†ã®éºå»¶å®Ÿè¡Œ
  scheduleEffect(effectFunction) {
    this.pendingEffects.push(effectFunction);
    if (!this.effectAnimationId) {
      this.effectAnimationId = requestAnimationFrame(() => {
        // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ãƒãƒƒãƒå‡¦ç†
        for (const effect of this.pendingEffects) {
          if (Math.random() < 0.3) { // 30%ã®ç¢ºç‡ã§å®Ÿè¡Œï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹èª¿æ•´ï¼‰
            effect();
          }
        }
        this.pendingEffects = [];
        this.effectAnimationId = null;
      });
    }
  }
};

socket.onopen = () => {
  console.log("âœ… WebSocketæ¥ç¶šå®Œäº†ï¼ˆé€ä¿¡å´ï¼‰");
  
  // å°‘ã—å¾…ã£ã¦ã‹ã‚‰writer ID ã‚’è¦æ±‚ï¼ˆå—ä¿¡å´ã®æº–å‚™å®Œäº†ã‚’å¾…ã¤ï¼‰
  setTimeout(() => {
    console.log("ğŸ”„ WriterIDè¦æ±‚ã‚’é–‹å§‹");
    requestWriterId();
    
    // åˆæœŸèƒŒæ™¯ç”»åƒã®è¨­å®šã¯WriterIDå‰²ã‚Šå½“ã¦å®Œäº†å¾Œã«å®Ÿè¡Œã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯å‰Šé™¤
    console.log('â³ WriterIDå‰²ã‚Šå½“ã¦å¾…ã¡ - èƒŒæ™¯ç”»åƒé€ä¿¡ã¯WriterIDå–å¾—å¾Œã«å®Ÿè¡Œ');
  }, 500);
};

socket.onmessage = (event) => {
  try {
    let data;
    
    // Blobã®å ´åˆã¯æ–‡å­—åˆ—ã¨ã—ã¦èª­ã¿å–ã‚‹
    if (event.data instanceof Blob) {
      const reader = new FileReader();
      reader.onload = function() {
        try {
          data = JSON.parse(reader.result);
          processMessage(data);
        } catch (error) {
          console.error('âŒ Blobãƒ‡ãƒ¼ã‚¿ã®è§£æã‚¨ãƒ©ãƒ¼:', error);
        }
      };
      reader.readAsText(event.data);
      return;
    } else {
      // æ–‡å­—åˆ—ã®å ´åˆ
      data = JSON.parse(event.data);
      processMessage(data);
    }
  } catch (error) {
    console.error('âŒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
  }
};


// drawBackgroundImageé–¢æ•°ã¯canvas-background.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// ä¸è¦ãªã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡¨ç¤ºæ©Ÿèƒ½ã‚’å‰Šé™¤ - ã‚·ãƒ³ãƒ—ãƒ«ãªUIã«çµ±ä¸€

// ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºã¨æ©Ÿèƒ½åˆ‡ã‚Šæ›¿ãˆã‚·ã‚¹ãƒ†ãƒ 
const DeviceManager = {
  // ãƒ‡ãƒã‚¤ã‚¹ã‚¿ã‚¤ãƒ—ã‚’æ¤œå‡º
  detectDevice() {
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;
    const touchSupport = 'ontouchstart' in window;
    const screenWidth = window.screen.width;
    const screenHeight = window.screen.height;
    const maxTouchPoints = navigator.maxTouchPoints || 0;
    
    // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆåˆ¤å®š
    const isTablet = (
      touchSupport &&
      maxTouchPoints > 1 &&
      (screenWidth >= 768 || screenHeight >= 768) &&
      (screenWidth <= 1024 || screenHeight <= 1024)
    ) || (
      /iPad|Android(?!.*Mobile)|Tablet/i.test(userAgent)
    );
    
    // ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³åˆ¤å®š
    const isMobile = (
      touchSupport &&
      !isTablet &&
      /Android|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)
    );
    
    // PCåˆ¤å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
    const isPC = !isTablet && !isMobile;
    
    return {
      isPC,
      isTablet,
      isMobile,
      touchSupport,
      screenWidth,
      screenHeight,
      maxTouchPoints,
      userAgent: userAgent.substring(0, 100) // ãƒ­ã‚°ç”¨ã«çŸ­ç¸®
    };
  },
  
  // ãƒ‡ãƒã‚¤ã‚¹åˆ¥è¨­å®šã‚’é©ç”¨
  applyDeviceSettings() {
    const device = this.detectDevice();
    console.log('ğŸ” ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºçµæœ:', device);
    
    if (device.isPC) {
      this.applyPCSettings();
    } else if (device.isTablet) {
      this.applyTabletSettings();
    } else if (device.isMobile) {
      this.applyMobileSettings();
    }
    
    return device;
  },
  
  // PCç”¨è¨­å®š
  applyPCSettings() {
    console.log('ğŸ’» PCè¨­å®šã‚’é©ç”¨');
    
    // PCç”¨ã®ç‰¹åˆ¥ãªè¨­å®š
    const canvas = document.getElementById('drawCanvas');
    if (canvas) {
      // PCã§ã¯ãƒã‚¦ã‚¹æ“ä½œã‚’æœ€é©åŒ–
      canvas.style.cursor = 'crosshair';
    }
    
    // PCç”¨UIã®èª¿æ•´
    document.body.classList.add('device-pc');
    document.body.classList.remove('device-tablet', 'device-mobile');
    
    // PCå°‚ç”¨æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
    this.enablePCFeatures();
  },
  
  // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨è¨­å®š
  applyTabletSettings() {
    console.log('ğŸ“± ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆè¨­å®šã‚’é©ç”¨');
    
    // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ã®ç‰¹åˆ¥ãªè¨­å®š
    const canvas = document.getElementById('drawCanvas');
    if (canvas) {
      // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã¯ã‚¿ãƒƒãƒæ“ä½œã‚’æœ€é©åŒ–
      canvas.style.cursor = 'none'; // ã‚«ãƒ¼ã‚½ãƒ«éè¡¨ç¤º
    }
    
    // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨UIã®èª¿æ•´
    document.body.classList.add('device-tablet');
    document.body.classList.remove('device-pc', 'device-mobile');
    
    // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå°‚ç”¨æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
    this.enableTabletFeatures();
  },
  
  // ãƒ¢ãƒã‚¤ãƒ«ç”¨è¨­å®š
  applyMobileSettings() {
    console.log('ğŸ“± ãƒ¢ãƒã‚¤ãƒ«è¨­å®šã‚’é©ç”¨');
    
    // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ç‰¹åˆ¥ãªè¨­å®š
    const canvas = document.getElementById('drawCanvas');
    if (canvas) {
      canvas.style.cursor = 'none';
    }
    
    // ãƒ¢ãƒã‚¤ãƒ«ç”¨UIã®èª¿æ•´
    document.body.classList.add('device-mobile');
    document.body.classList.remove('device-pc', 'device-tablet');
    
    // ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
    this.enableMobileFeatures();
  },
  
  // PCå°‚ç”¨æ©Ÿèƒ½
  enablePCFeatures() {
    // PCç”¨ã®è©³ç´°ãªDevToolsã‚’è¡¨ç¤º
    const devButton = document.getElementById('devButton');
    if (devButton) {
      devButton.style.display = 'block';
    }
    
    // PCç”¨ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’æœ‰åŠ¹åŒ–
    this.enableKeyboardShortcuts();
  },
  
  // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå°‚ç”¨æ©Ÿèƒ½
  enableTabletFeatures() {
    // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ã®å¤§ããªãƒœã‚¿ãƒ³
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => {
      if (!btn.classList.contains('color-btn') && !btn.classList.contains('thickness-btn')) {
        btn.style.minHeight = '50px';
        btn.style.fontSize = '16px';
      }
    });
    
    // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ã®ã‚¿ãƒƒãƒæœ€é©åŒ–
    this.optimizeForTouch();
  },
  
  // ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨æ©Ÿèƒ½
  enableMobileFeatures() {
    // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®è¶…å¤§ããªãƒœã‚¿ãƒ³
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => {
      if (!btn.classList.contains('color-btn') && !btn.classList.contains('thickness-btn')) {
        btn.style.minHeight = '60px';
        btn.style.fontSize = '18px';
      }
    });
    
    // DevToolsã‚’éè¡¨ç¤ºï¼ˆç”»é¢ãŒå°ã•ã„ãŸã‚ï¼‰
    const devButton = document.getElementById('devButton');
    if (devButton) {
      devButton.style.display = 'none';
    }
  },
  
  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆPCå°‚ç”¨ï¼‰
  enableKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
          case 'z':
            e.preventDefault();
            // Undoæ©Ÿèƒ½ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
            console.log('âŒ¨ï¸ Undo shortcut (PC only)');
            break;
          case 's':
            e.preventDefault();
            // Saveæ©Ÿèƒ½
            console.log('âŒ¨ï¸ Save shortcut (PC only)');
            break;
        }
      }
    });
  },
  
  // ã‚¿ãƒƒãƒæœ€é©åŒ–ï¼ˆã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ/ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨ï¼‰
  optimizeForTouch() {
    // ã‚¿ãƒƒãƒé…å»¶ã‚’å‰Šé™¤
    const style = document.createElement('style');
    style.textContent = `
      .device-tablet button, .device-mobile button {
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        touch-action: manipulation;
      }
      
      .device-tablet .pen-controls, .device-mobile .pen-controls {
        gap: 15px;
      }
    `;
    document.head.appendChild(style);
  }
};

// generateSessionIdé–¢æ•°ã¯websocket.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// requestWriterIdé–¢æ•°ã¯websocket.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// createWriterStatusDivé–¢æ•°ã¯websocket.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// handleOtherWriterDrawingé–¢æ•°ã¯websocket.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// senderWriterPathStateså¤‰æ•°ã¯websocket.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// drawWriterCommandsé–¢æ•°ã¯websocket.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// redrawCanvasWithOthersé–¢æ•°ã¨isRedrawingå¤‰æ•°ã¯websocket.jsã«ç§»å‹•ã—ã¾ã—ãŸ

socket.onerror = (error) => console.error("âŒ WebSocketã‚¨ãƒ©ãƒ¼ï¼ˆé€ä¿¡å´ï¼‰:", error);
socket.onclose = (event) => {
  console.log("âš ï¸ WebSocketåˆ‡æ–­ï¼ˆé€ä¿¡å´ï¼‰:", event.code, event.reason);
  console.log("ğŸ§¹ åˆ‡æ–­å‰ã®çŠ¶æ…‹:", { myWriterId, mySessionId });
  
  // æ¥ç¶šåˆ‡æ–­æ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆ
  mySessionId = null;
  myWriterId = null;
  console.log("ğŸ§¹ WebSocketåˆ‡æ–­ã«ä¼´ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆ");
  
  // Writer IDè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
  const statusDiv = document.getElementById('writerStatus');
  if (statusDiv) {
    statusDiv.childNodes[0].textContent = 'Writer ID: æœªå‰²ã‚Šå½“ã¦';
  }
  document.title = 'é€ä¿¡å´ - æœªæ¥ç¶š';
};

// ãƒãƒ¼ãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”Ÿæˆé–¢æ•°
// createHearté–¢æ•°ã¯special-effects.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// createSpecialHearté–¢æ•°ã¯special-effects.jsã«ç§»å‹•ã—ã¾ã—ãŸ


// é€ä¿¡å´ã§ã‚‚lã‚­ãƒ¼ã§ãƒãƒ¼ãƒˆã‚’è¡¨ç¤ºï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
let senderLKeyCount = 0;
let senderLKeyTimer = null;

document.addEventListener('keydown', function(event) {
  if (event.key.toLowerCase() === 'l') {
    senderLKeyCount++;
    // é€ä¿¡å´lã‚­ãƒ¼æŠ¼ä¸‹
    
    if (senderLKeyTimer) {
      clearTimeout(senderLKeyTimer);
    }
    
    if (senderLKeyCount >= 10) {
      // console.log('ğŸ‰ é€ä¿¡å´ã§l10å›é”æˆ - ç‰¹åˆ¥æ¼”å‡ºãƒ†ã‚¹ãƒˆ');
      createSpecialHeart();
      senderLKeyCount = 0;
    } else {
      createHeart();
    }
    
    senderLKeyTimer = setTimeout(() => {
      senderLKeyCount = 0;
      // console.log('â° é€ä¿¡å´lã‚­ãƒ¼ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆ');
    }, 3000);
  }
});

// ãƒ†ã‚¹ãƒˆç”¨ï¼š5ç§’å¾Œã«è‡ªå‹•ã§ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º
setTimeout(() => {
  // ãƒ†ã‚¹ãƒˆ: è‡ªå‹•ãƒãƒ¼ãƒˆè¡¨ç¤º
  createHeart();
}, 5000);

// ğŸ”¸ ç”¨ç´™ã‚µã‚¤ã‚ºè¨­å®šé–¢æ•°
// setPaperSizeé–¢æ•°ã¯settings.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// ğŸ–¨ï¸ å°åˆ·ãƒ¢ãƒ¼ãƒ‰è¨­å®šé–¢æ•°
// setPrintModeé–¢æ•°ã¯settings.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// ğŸ”¸ ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºå¤‰æ›´é–¢æ•°ã‚’è¿½åŠ 
// setCanvasToPortraitSizeé–¢æ•°ã¯canvas-background.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// resetCanvasToNormalSizeé–¢æ•°ã¯canvas-background.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// setBackgroundé–¢æ•°ã¯canvas-background.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// setSpecialBackgroundé–¢æ•°ï¼ˆ1ã¤ç›®ï¼‰ã¯canvas-background.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// setCanvasSizeé–¢æ•°ã¯canvas-background.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// setSpecialBackgroundé–¢æ•°ï¼ˆ2ã¤ç›®ï¼‰ã¯canvas-background.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// setSpecialBackgroundToggleé–¢æ•°ã¯canvas-background.jsã«ç§»å‹•ã—ã¾ã—ãŸ

function startCountdown() {
  const countdownEl = document.getElementById("countdown");
  
  // ğŸ”¸ ç”¨ç´™ã‚µã‚¤ã‚ºã«å¿œã˜ã¦ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³æ™‚é–“ã‚’èª¿æ•´
  let totalSeconds;
  if (currentPaperSize === "poster") {
    totalSeconds = 8; // ãƒã‚¹ã‚¿ãƒ¼ï¼š3ç§’çŸ­ç¸®ï¼ˆ11ç§’â†’8ç§’ï¼‰
  } else if (currentPaperSize === "L") {
    totalSeconds = 9; // Låˆ¤ï¼š2ç§’çŸ­ç¸®ï¼ˆ11ç§’â†’9ç§’ï¼‰
  } else {
    totalSeconds = 11; // A4ï¼šå¾“æ¥é€šã‚Š11ç§’
  }
  
  let seconds = totalSeconds;
  countdownEl.textContent = `ãŠæ¸¡ã—ã¾ã§ï¼š${seconds}ç§’`;
  
  const timer = setInterval(() => {
    seconds--;
    if (seconds >= 0) {
      countdownEl.textContent = `ãŠæ¸¡ã—ã¾ã§ï¼š${seconds}ç§’`;
    } else {
      clearInterval(timer);
      countdownEl.textContent = "";
      // âœ… ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³çµ‚äº†å¾Œã€ç­†è·¡ã®ã¿å‰Šé™¤ï¼ˆèƒŒæ™¯ç¶­æŒï¼‰
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (backgroundImage) {
        drawBackgroundImage(ctx, backgroundImage, canvas);
      }
      
      // æç”»ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¯ãƒªã‚¢
      drawingCommands = [];
      // console.log('ğŸ§¹ ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³çµ‚äº†: æç”»ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¯ãƒªã‚¢');
      
      // âœ… èƒŒæ™¯ã®åŒæœŸé€ä¿¡
      const bgSrc = backgroundImage ? backgroundImage.src : "white";
      socket.send(JSON.stringify({ type: "clear" }));
      socket.send(JSON.stringify({ type: "background", src: bgSrc, writerId: myWriterId }));
    }
  }, 1000);
}

// clearCanvasé–¢æ•°ã¯canvas-background.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// clearMyDrawingé–¢æ•°ã¯canvas-background.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// ãƒšãƒ³ã®å¤ªã•è¨­å®šé–¢æ•°
// setPenThicknessé–¢æ•°ã¯settings.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// ãƒšãƒ³ã®è‰²è¨­å®šé–¢æ•°
// setPenColoré–¢æ•°ã¯settings.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// 16é€²æ•°ã‚«ãƒ©ãƒ¼ã‚’RGBã«å¤‰æ›
// ğŸ§® ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ»è¨ˆç®—é–¢æ•°ç¾¤ (hexToRgb, rgbToHex, easeInOutSine, interpolateColor) ã¯utils.jsã«ç§»å‹•ã—ã¾ã—ãŸ


// æ˜Ÿã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ON/OFFåˆ‡ã‚Šæ›¿ãˆ
// ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãƒˆã‚°ãƒ«é–¢æ•°ã¯effects.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// ğŸµ ãƒšãƒ³éŸ³åˆ¶å¾¡é–¢æ•°ï¼ˆé€ä¿¡å´ã§ã¯ç„¡åŠ¹åŒ–ï¼‰
// togglePenSoundé–¢æ•°ã¯settings.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// ğŸ” toggleBackgroundDebugé–¢æ•°ã¯canvas-background.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// ğŸ” addBackgroundDebugVisualsé–¢æ•°ã¯canvas-background.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// ğŸµ éŸ³æ¥½ãƒ»éŸ³å£°é–¢æ•°ç¾¤ (initDrawingAudio, startDrawingMusic, pauseDrawingMusic, stopDrawingMusic, handleDrawingActivity) ã¯audio-music.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// æç”»ç”¨ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
// æç”»ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–¢æ•°ç¾¤ã¯effects.jsã«ç§»å‹•ã—ã¾ã—ãŸ
// createDrawingHeart, createSenderStar, createFairyDust, createStar

// ç‰¹æ®Šã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–¢æ•°ç¾¤ã¯special-effects.jsã«ç§»å‹•ã—ã¾ã—ãŸ
// addSenderFireworkAnimations, createFireworks, createExplosion, createConfetti// ğŸ¨ WriterIDåˆ¥æç”»çŠ¶æ…‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function getWriterDrawingState(writerId) {
  if (!writerId) writerId = 'self'; // è‡ªåˆ†ã®æç”»ã®å ´åˆ
  
  if (!writerDrawingStates[writerId]) {
    writerDrawingStates[writerId] = {
      lastPosition: null,
      currentPath: [],
      isDrawing: false
    };
  }
  return writerDrawingStates[writerId];
}

function resetWriterDrawingState(writerId) {
  if (!writerId) writerId = 'self';
  writerDrawingStates[writerId] = {
    lastPosition: null,
    currentPath: [],
    isDrawing: false
  };
}

// ğŸ¨ WriterIDåˆ¥é€£ç¶šæç”»é–¢æ•°
function drawContinuousLineForWriter(x, y, writerId = 'self') {
  const writerState = getWriterDrawingState(writerId);
  
  if (!writerState.lastPosition) {
    // æç”»é–‹å§‹ç‚¹ - ä»–WriterIDã¨ã®çŠ¶æ…‹æ··åœ¨ã‚’å®Œå…¨ã«é˜²æ­¢
    ctx.beginPath(); // é‡è¦ï¼šä»–ã®Writerã®æœªå®Œäº†ãƒ‘ã‚¹ã‚’ã‚¯ãƒªã‚¢
    ctx.moveTo(x, y);
    writerState.lastPosition = { x, y };
    writerState.currentPath = [{ x, y }];
    return;
  }
  
  // è·é›¢ãŒè¿‘ã™ãã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šï¼‰
  const lastPos = writerState.lastPosition;
  const distance = Math.sqrt(Math.pow(x - lastPos.x, 2) + Math.pow(y - lastPos.y, 2));
  if (distance < 1) {
    return; // 1ãƒ”ã‚¯ã‚»ãƒ«ä»¥ä¸‹ã®ç§»å‹•ã¯ç„¡è¦–
  }
  
  // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°: quadratic curve ã§æ»‘ã‚‰ã‹ãªæ›²ç·šã‚’æç”»
  if (writerState.currentPath && writerState.currentPath.length >= 2) {
    const prev2 = writerState.currentPath[writerState.currentPath.length - 2];
    const prev1 = writerState.currentPath[writerState.currentPath.length - 1];
    
    // ä¸­ç‚¹ã‚’åˆ¶å¾¡ç‚¹ã¨ã—ã¦ä½¿ç”¨
    const midX = (prev1.x + x) / 2;
    const midY = (prev1.y + y) / 2;
    
    ctx.quadraticCurveTo(prev1.x, prev1.y, midX, midY);
    ctx.stroke();
  } else {
    // æœ€åˆã®æ•°ç‚¹ã¯ç›´ç·š
    ctx.lineTo(x, y);
    ctx.stroke();
  }
  
  // ç¾åœ¨ã®ç‚¹ã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
  writerState.currentPath.push({ x, y });
  
  // ãƒ‘ã‚¹ã®é•·ã•ã‚’åˆ¶é™ï¼ˆãƒ¡ãƒ¢ãƒªåŠ¹ç‡åŒ–ï¼‰
  if (writerState.currentPath.length > 3) {
    writerState.currentPath.shift();
  }
  
  writerState.lastPosition = { x, y };
}

// ğŸ¨ é€£ç¶šçš„ãªæç”»é–¢æ•°ï¼ˆä¸€èˆ¬çš„ãªãƒšã‚¤ãƒ³ãƒˆãƒ„ãƒ¼ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰- ãƒ¬ã‚¬ã‚·ãƒ¼äº’æ›ç”¨
function drawContinuousLine(x, y) {
  // æ–°ã—ã„WriterIDåˆ¥æç”»ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨
  drawContinuousLineForWriter(x, y, 'self');
  // ãƒ¬ã‚¬ã‚·ãƒ¼å¤‰æ•°ã‚‚æ›´æ–°ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
  lastPosition = { x, y };
}

// interpolatePointsé–¢æ•°ã‚’å‰Šé™¤ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ï¼‰

// console.log('ğŸ¯ mousedownã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’canvasã«è¿½åŠ ä¸­...');
// console.log('ğŸ¯ canvasè¦ç´ ã®çŠ¶æ…‹:', canvas);
// console.log('ğŸ¯ canvasè¦ç´ ã®ã‚¿ã‚°å:', canvas ? canvas.tagName : 'null');

// ç¢ºå®Ÿã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã€DOMãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã‹ã‚‰å®Ÿè¡Œ
document.addEventListener('DOMContentLoaded', function() {
  // console.log('ğŸ¯ DOMContentLoaded - ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†åº¦è¿½åŠ ');
  const canvasElement = document.getElementById('drawCanvas');
  // console.log('ğŸ¯ å†å–å¾—ã—ãŸcanvasè¦ç´ :', canvasElement);
  
  if (canvasElement) {
    // ã™ã¹ã¦ã®ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆ
    canvasElement.addEventListener("mousedown", (e) => {
      // console.log('ğŸ–±ï¸ DOMContentLoadedå¾Œã®mousedownã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ');
      // console.log('ğŸ–±ï¸ ãƒã‚¦ã‚¹åº§æ¨™:', e.offsetX, e.offsetY);
      // console.log('ğŸ–±ï¸ ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ:', e.target);
    });
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒ†ã‚¹ãƒˆã‚’æ‹¡å¼µ
    let isMousePressed = false;
    let lastPos = null;
    
    // mousemoveã‚¤ãƒ™ãƒ³ãƒˆã§ãƒã‚¦ã‚¹ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’åˆ¤å®šã™ã‚‹æ–¹å¼
    canvasElement.addEventListener('mousemove', (e) => {
      const x = e.offsetX;
      const y = e.offsetY;
      const isCurrentlyPressed = e.buttons === 1; // å·¦ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¦ã„ã‚‹
      
      // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šbuttonså€¤ã‚’è©³ã—ãè¡¨ç¤º
      // if (e.buttons !== 0) {
      //   console.log(`ğŸ–±ï¸ mousemoveï¼ˆãƒœã‚¿ãƒ³æŠ¼ä¸‹ä¸­ï¼‰ - åº§æ¨™: ${x}, ${y}, buttons: ${e.buttons}`);
      // }
      
      // ãƒã‚¦ã‚¹ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸç¬é–“ï¼ˆæç”»é–‹å§‹ï¼‰
      if (isCurrentlyPressed && !isMousePressed) {
        // console.log('ğŸ–±ï¸ ãƒã‚¦ã‚¹ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ¤œå‡º - æç”»é–‹å§‹');
        isMousePressed = true;
        drawing = true;
        lastPos = { x, y };
        
        // æç”»è¨­å®šã‚’åˆæœŸåŒ–
        ctx.strokeStyle = currentPenColor || 'black';
        ctx.lineWidth = currentPenThickness || 8;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.shadowBlur = 0;
        ctx.shadowColor = 'transparent';
        ctx.globalAlpha = 1.0;
        
        ctx.beginPath();
        ctx.moveTo(x, y);
        
        // æç”»é–‹å§‹æ™‚ã«ç‚¹ã‚’æç”»
        ctx.lineTo(x + 1, y + 1);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y);
        
        // console.log('ğŸ–±ï¸ æç”»é–‹å§‹ç‚¹è¨­å®š:', x, y);
      }
      // ãƒã‚¦ã‚¹ãƒœã‚¿ãƒ³ãŒé›¢ã•ã‚ŒãŸç¬é–“ï¼ˆæç”»çµ‚äº†ï¼‰
      else if (!isCurrentlyPressed && isMousePressed) {
        // console.log('ğŸ–±ï¸ ãƒã‚¦ã‚¹ãƒœã‚¿ãƒ³é›¢è„±æ¤œå‡º - æç”»çµ‚äº†');
        isMousePressed = false;
        drawing = false;
        lastPos = null;
      }
      // ãƒã‚¦ã‚¹ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¦ã„ã‚‹é–“ï¼ˆæç”»ç¶™ç¶šï¼‰
      else if (isCurrentlyPressed && isMousePressed && drawing) {
        // console.log('ğŸ–±ï¸ æç”»ç¶™ç¶šä¸­:', x, y);
        
        if (lastPos) {
          // å‰ã®ç‚¹ã‹ã‚‰ç¾åœ¨ã®ç‚¹ã¾ã§ç·šã‚’æç”»
          ctx.beginPath();
          ctx.moveTo(lastPos.x, lastPos.y);
          ctx.lineTo(x, y);
          ctx.stroke();
        }
        
        lastPos = { x, y };
      }
    });
    
    // æ¨™æº–çš„ãªãƒšã‚¤ãƒ³ãƒˆãƒ„ãƒ¼ãƒ«æ–¹å¼ã®æç”»ã‚·ã‚¹ãƒ†ãƒ 
    // isPaintDrawingã€lastPaintPosã€getBackgroundAreaã€isWithinBackgroundAreaã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§å®šç¾©æ¸ˆã¿
    
    // ä»¥ä¸‹ã®é–¢æ•°ã¯å‰Šé™¤ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã§å®šç¾©æ¸ˆã¿ï¼‰
    /* function getBackgroundArea() {
      if (!backgroundImage) {
        // èƒŒæ™¯ç”»åƒãŒãªã„å ´åˆã¯å…¨ç¯„å›²ã‚’è¨±å¯
        // console.log('ğŸ–¼ï¸ èƒŒæ™¯ç”»åƒãªã— - å…¨ç¯„å›²ã‚’è¨±å¯'); // è»½é‡åŒ–
        return {
          x: 0,
          y: 0,
          width: canvas.width,
          height: canvas.height
        };
      }
      
      // drawBackgroundImageé–¢æ•°ã¨åŒã˜è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ2å€æ‹¡å¤§ã‚’å«ã‚€ï¼‰
      const canvasRatio = canvas.width / canvas.height;
      const imageRatio = backgroundImage.width / backgroundImage.height;
      
      let baseWidth, baseHeight;
      
      // åŸºæœ¬ã‚µã‚¤ã‚ºã‚’è¨ˆç®—ï¼ˆcontainæ–¹å¼ï¼‰
      if (imageRatio > canvasRatio) {
        // ç”»åƒã®æ–¹ãŒæ¨ªé•·
        baseWidth = canvas.width;
        baseHeight = canvas.width / imageRatio;
      } else {
        // ç”»åƒã®æ–¹ãŒç¸¦é•·
        baseHeight = canvas.height;
        baseWidth = canvas.height * imageRatio;
      }
      
      // èƒŒæ™¯ç”»åƒã¨æç”»ã‚¨ãƒªã‚¢ã‚’åŒã˜ã‚µã‚¤ã‚ºã«
      const scale = 1.0;
      const drawWidth = baseWidth * scale;
      const drawHeight = baseHeight * scale;
      
      // ä¸­å¤®ã«é…ç½®ã™ã‚‹ãŸã‚ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ
      const offsetX = (canvas.width - drawWidth) / 2;
      const offsetY = (canvas.height - drawHeight) / 2;
      
      console.log('ğŸ–¼ï¸ èƒŒæ™¯ç”»åƒç¯„å›²è¨ˆç®—:', {
        canvasSize: { width: canvas.width, height: canvas.height },
        imageSize: { width: backgroundImage.width, height: backgroundImage.height },
        baseSize: { width: baseWidth, height: baseHeight },
        scale: scale,
        drawArea: { x: offsetX, y: offsetY, width: drawWidth, height: drawHeight }
      });
      
      return {
        x: offsetX,
        y: offsetY,
        width: drawWidth,
        height: drawHeight
      };
    }
    
    // åº§æ¨™ãŒèƒŒæ™¯ç”»åƒã®ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
    function isWithinBackgroundArea(x, y) {
      // èƒŒæ™¯ç”»åƒç¯„å›²ãƒã‚§ãƒƒã‚¯ã‚’å†æœ‰åŠ¹åŒ–ã—ã¦è©³ç´°ãƒ­ã‚°å‡ºåŠ›
      const bgArea = getBackgroundArea();
      
      const withinX = x >= bgArea.x && x <= bgArea.x + bgArea.width;
      const withinY = y >= bgArea.y && y <= bgArea.y + bgArea.height;
      const isWithin = withinX && withinY;
      
      console.log('ğŸ–¼ï¸ èƒŒæ™¯ç”»åƒç¯„å›²ãƒã‚§ãƒƒã‚¯è©³ç´°:', {
        clickX: x,
        clickY: y,
        bgX: bgArea.x,
        bgY: bgArea.y,
        bgWidth: bgArea.width,
        bgHeight: bgArea.height,
        withinX: withinX,
        withinY: withinY,
        çµæœ: isWithin ? 'âœ… ç¯„å›²å†…' : 'âŒ ç¯„å›²å¤–'
      });
      
      return isWithin;
    } */
      
      /* ã‚ªãƒªã‚¸ãƒŠãƒ«ã®ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå‚è€ƒç”¨ï¼‰
      const bgArea = getBackgroundArea();
      
      console.log('ğŸ–¼ï¸ èƒŒæ™¯ç”»åƒç¯„å›²ãƒã‚§ãƒƒã‚¯:', {
        clickX: x,
        clickY: y,
        bgX: bgArea.x,
        bgY: bgArea.y,
        bgWidth: bgArea.width,
        bgHeight: bgArea.height,
        withinX: x >= bgArea.x && x <= bgArea.x + bgArea.width,
        withinY: y >= bgArea.y && y <= bgArea.y + bgArea.height
      });
      
      return x >= bgArea.x && 
             x <= bgArea.x + bgArea.width && 
             y >= bgArea.y && 
             y <= bgArea.y + bgArea.height;
      */
    
    // PointerEventsã‚’ä½¿ç”¨ï¼ˆã‚ˆã‚Šç¢ºå®Ÿãªã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ï¼‰
    if ('PointerEvent' in window) {
      // console.log('ğŸ–±ï¸ PointerEventsã‚’ä½¿ç”¨');
      
      canvasElement.addEventListener('pointerdown', (e) => {
        // console.log('ğŸ–±ï¸ pointerdown - æç”»é–‹å§‹');
        
        // æ­£ç¢ºãªåº§æ¨™ã‚’å–å¾—ï¼ˆcanvaså†…ã®ç›¸å¯¾åº§æ¨™ï¼‰
        const rect = canvasElement.getBoundingClientRect();
        const scaleX = canvasElement.width / rect.width;
        const scaleY = canvasElement.height / rect.height;
        const x = (e.clientX - rect.left) * scaleX;
        const y = (e.clientY - rect.top) * scaleY;
        
        // console.log('ğŸ–±ï¸ åº§æ¨™è©³ç´°:', {
        //   clientX: e.clientX,
        //   clientY: e.clientY,
        //   rectLeft: rect.left,
        //   rectTop: rect.top,
        //   scaleX: scaleX,
        //   scaleY: scaleY,
        //   finalX: x,
        //   finalY: y
        // });
        
        // èƒŒæ™¯ç”»åƒã®ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
        if (!isWithinBackgroundArea(x, y)) {
          console.log('ğŸ–±ï¸ èƒŒæ™¯ç”»åƒç¯„å›²å¤–ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
          return;
        }
        
        isPaintDrawing = true;
        lastPaintPos = { x, y };
        
        // æç”»è¨­å®š
        ctx.strokeStyle = currentPenColor || 'black';
        ctx.lineWidth = currentPenThickness || 8;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        // æç”»é–‹å§‹ç‚¹
        ctx.beginPath();
        ctx.moveTo(x, y);
        
        // é–‹å§‹ç‚¹ã«å°ã•ãªç‚¹ã‚’æç”»
        ctx.lineTo(x + 0.1, y + 0.1);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y);
        
        // è‡ªåˆ†ã®æç”»ã‚³ãƒãƒ³ãƒ‰ã¨ã—ã¦ä¿å­˜
        const startCmd = {
          type: "start",
          x: x,
          y: y,
          thickness: currentPenThickness,
          color: currentPenColor === 'black' ? '#000' : currentPenColor
        };
        drawingCommands.push(startCmd);
        // console.log(`ğŸ“‹ DEBUG: startä¿å­˜ - é…åˆ—æ•°=${drawingCommands.length}ä»¶`); // è»½é‡åŒ–

        // WebSocketã§å—ä¿¡å´ã«æç”»é–‹å§‹ã‚’é€ä¿¡
        const startMsg = {
          type: "start",
          x: x,
          y: y,
          thickness: currentPenThickness,
          color: currentPenColor,
          writerId: myWriterId,
          timestamp: Date.now()
        };
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify(startMsg));
          const isValidCoord = x >= 0 && x <= canvas.width && y >= 0 && y <= canvas.height;
          console.log("ğŸ“¤ PCæç”»é–‹å§‹ãƒ‡ãƒ¼ã‚¿é€ä¿¡:", {
            type: startMsg.type,
            writerId: startMsg.writerId,
            x: Math.round(x),
            y: Math.round(y),
            canvasSize: `${canvas.width}x${canvas.height}`,
            åº§æ¨™å¦¥å½“æ€§: isValidCoord
          });
        }
      });
      
      canvasElement.addEventListener('pointermove', (e) => {
        if (!isPaintDrawing || !lastPaintPos) return;
        
        // æ­£ç¢ºãªåº§æ¨™ã‚’å–å¾—
        const rect = canvasElement.getBoundingClientRect();
        const scaleX = canvasElement.width / rect.width;
        const scaleY = canvasElement.height / rect.height;
        const x = (e.clientX - rect.left) * scaleX;
        const y = (e.clientY - rect.top) * scaleY;
        
        // console.log('ğŸ–±ï¸ pointermove - æç”»ä¸­:', x, y); // è»½é‡åŒ–
        
        // èƒŒæ™¯ç”»åƒã®ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
        if (!isWithinBackgroundArea(x, y)) {
          console.log('ğŸ–±ï¸ èƒŒæ™¯ç”»åƒç¯„å›²å¤– - æç”»ä¸­æ–­');
          isPaintDrawing = false;
          lastPaintPos = null;
          return;
        }
        
        // ç·šã‚’æç”»
        ctx.lineTo(x, y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y);
        
        // è‡ªåˆ†ã®æç”»ã‚³ãƒãƒ³ãƒ‰ã¨ã—ã¦ä¿å­˜
        const actualColor = currentPenColor === 'white-red-border' ? '#ffffff' : 
                           (currentPenColor === 'black' ? '#000' : 
                           (currentPenColor === 'white' ? '#fff' : 
                           (currentPenColor === 'green' ? '#008000' : 
                           (currentPenColor === 'pink' ? '#ff69b4' : currentPenColor))));
        const drawCmd = {
          type: "draw",
          x: x,
          y: y,
          thickness: currentPenThickness,
          color: actualColor
        };
        drawingCommands.push(drawCmd);
        // console.log(`ğŸ“‹ DEBUG: drawä¿å­˜ - é…åˆ—æ•°=${drawingCommands.length}ä»¶`); // è»½é‡åŒ–
        
        // WebSocketã§å—ä¿¡å´ã«æç”»ç¶™ç¶šãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
        const drawMsg = {
          type: "draw",
          x: x,
          y: y,
          thickness: currentPenThickness,
          color: currentPenColor,
          writerId: myWriterId,
          timestamp: Date.now(),
          starEffect: starEffectEnabled,
          fairyDustEffect: fairyDustEffectEnabled,
          canvasSize: {
            width: canvas.width,
            height: canvas.height
          }
        };
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify(drawMsg));
          // é »åº¦ã‚’æ¸›ã‚‰ã—ã¦ãƒ­ã‚°å‡ºåŠ›ï¼ˆ10å›ã«1å›ï¼‰
          if (Math.random() < 0.1) {
            console.log("ğŸ“¤ PCæç”»ç¶™ç¶šãƒ‡ãƒ¼ã‚¿é€ä¿¡:", {
              writerId: drawMsg.writerId,
              x: Math.round(x),
              y: Math.round(y)
            });
          }
        }
        
        // æ›¸ãæ‰‹å´ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼šã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã‚’ãƒšãƒ¼ã‚¸åº§æ¨™ã«å¤‰æ›
        const pageX = rect.left + x;
        const pageY = rect.top + y;
        // æ˜Ÿã‚¨ãƒ•ã‚§ã‚¯ãƒˆãŒæœ‰åŠ¹ãªå ´åˆã¯æ˜Ÿã‚’ç”Ÿæˆï¼ˆ50%ã®é »åº¦ï¼‰
        if (starEffectEnabled && Math.random() < 0.5) {
          createSenderStar(pageX, pageY);
        }

        // å¦–ç²¾ã®ç²‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãŒæœ‰åŠ¹ãªå ´åˆã¯å¦–ç²¾ã®ç²‰ã‚’ç”Ÿæˆï¼ˆ15å›ã«1å›ã®é »åº¦ï¼‰
        if (fairyDustEffectEnabled && Math.random() < 0.067) {
          createFairyDust(pageX, pageY);
        }
        
        // ãƒãƒ¼ãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆãŒæœ‰åŠ¹ãªå ´åˆã¯ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆï¼ˆ20å›ã«1å›ã®é »åº¦ï¼‰
        if (heartEffectEnabled && Math.random() < 0.05) {
          createDrawingHeart(pageX, pageY);
        }
        
        lastPaintPos = { x, y };
      });
      
      canvasElement.addEventListener('pointerup', (e) => {
        // console.log('ğŸ–±ï¸ pointerup - æç”»çµ‚äº†'); // è»½é‡åŒ–
        isPaintDrawing = false;
        lastPaintPos = null;
      });
      
    } else {
      console.log('ğŸ–±ï¸ å¾“æ¥ã®ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½¿ç”¨');
      
      // å¾“æ¥ã®ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
      canvasElement.addEventListener('mousedown', (e) => {
        console.log('ğŸ–±ï¸ mousedown - æç”»é–‹å§‹');
        
        // æ­£ç¢ºãªåº§æ¨™ã‚’å–å¾—
        const rect = canvasElement.getBoundingClientRect();
        const scaleX = canvasElement.width / rect.width;
        const scaleY = canvasElement.height / rect.height;
        const x = (e.clientX - rect.left) * scaleX;
        const y = (e.clientY - rect.top) * scaleY;
        
        // èƒŒæ™¯ç”»åƒã®ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
        if (!isWithinBackgroundArea(x, y)) {
          console.log('ğŸ–±ï¸ èƒŒæ™¯ç”»åƒç¯„å›²å¤–ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
          return;
        }
        
        isPaintDrawing = true;
        lastPaintPos = { x, y };
        
        // æç”»è¨­å®š
        ctx.strokeStyle = currentPenColor || 'black';
        ctx.lineWidth = currentPenThickness || 8;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        // æç”»é–‹å§‹ç‚¹
        ctx.beginPath();
        ctx.moveTo(x, y);
        
        // WebSocketã§å—ä¿¡å´ã«æç”»é–‹å§‹ã‚’é€ä¿¡
        const startMsg = {
          type: "start",
          x: x,
          y: y,
          thickness: currentPenThickness,
          color: currentPenColor,
          writerId: myWriterId,
          timestamp: Date.now()
        };
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify(startMsg));
          console.log("ğŸ“¤ PCæç”»é–‹å§‹ãƒ‡ãƒ¼ã‚¿é€ä¿¡(mouse):", startMsg);
        }
        
        e.preventDefault();
      });
      
      canvasElement.addEventListener('mousemove', (e) => {
        if (!isPaintDrawing || !lastPaintPos) return;
        
        // æ­£ç¢ºãªåº§æ¨™ã‚’å–å¾—
        const rect = canvasElement.getBoundingClientRect();
        const scaleX = canvasElement.width / rect.width;
        const scaleY = canvasElement.height / rect.height;
        const x = (e.clientX - rect.left) * scaleX;
        const y = (e.clientY - rect.top) * scaleY;
        
        // console.log('ğŸ–±ï¸ mousemove - æç”»ä¸­:', x, y); // è»½é‡åŒ–
        
        // èƒŒæ™¯ç”»åƒã®ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
        if (!isWithinBackgroundArea(x, y)) {
          console.log('ğŸ–±ï¸ èƒŒæ™¯ç”»åƒç¯„å›²å¤– - æç”»ä¸­æ–­');
          isPaintDrawing = false;
          lastPaintPos = null;
          return;
        }
        
        // ç·šã‚’æç”»
        ctx.lineTo(x, y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y);
        
        // WebSocketã§å—ä¿¡å´ã«æç”»ç¶™ç¶šãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
        const drawMsg = {
          type: "draw",
          x: x,
          y: y,
          thickness: currentPenThickness,
          color: currentPenColor,
          writerId: myWriterId,
          timestamp: Date.now(),
          starEffect: starEffectEnabled,
          fairyDustEffect: fairyDustEffectEnabled,
          canvasSize: {
            width: canvas.width,
            height: canvas.height
          }
        };
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify(drawMsg));
          console.log("ğŸ“¤ PCæç”»ç¶™ç¶šãƒ‡ãƒ¼ã‚¿é€ä¿¡(mouse):", x, y);
        }
        
        lastPaintPos = { x, y };
      });
      
      canvasElement.addEventListener('mouseup', (e) => {
        console.log('ğŸ–±ï¸ mouseup - æç”»çµ‚äº†');
        isPaintDrawing = false;
        lastPaintPos = null;
      });
    }
    
    // mouseleaveã§æç”»ã‚’çµ‚äº†ï¼ˆä¸€èˆ¬çš„ãªãƒšã‚¤ãƒ³ãƒˆãƒ„ãƒ¼ãƒ«ã®å‹•ä½œï¼‰
    canvasElement.addEventListener("mouseleave", (e) => {
      console.log('ğŸ–±ï¸ mouseleave - æç”»çµ‚äº†');
      if (isPaintDrawing) {
        isPaintDrawing = false;
        lastPaintPos = null;
      }
    });
    
    // å³ã‚¯ãƒªãƒƒã‚¯ã§æç”»ã‚’ä¸­æ–­
    canvasElement.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      console.log('ğŸ–±ï¸ å³ã‚¯ãƒªãƒƒã‚¯ - æç”»ä¸­æ–­');
      if (isPaintDrawing) {
        isPaintDrawing = false;
        lastPaintPos = null;
      }
    });
    
    
    // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚‚ãƒ†ã‚¹ãƒˆï¼ˆPCã§ã‚‚ç™ºç”Ÿã™ã‚‹å ´åˆãŒã‚ã‚‹ï¼‰
    canvasElement.addEventListener("touchstart", (e) => {
      console.log('ğŸ“± touchstartã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ');
      e.preventDefault();
    });
  }
});

canvas.addEventListener("mousedown", (e) => {
  console.log('ğŸ–±ï¸ mousedownã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ');
  console.log('ğŸ¯ canvasè¦ç´ :', canvas);
  console.log('ğŸ¯ ctx:', ctx);
  console.log('ğŸ¯ drawingå¤‰æ•°:', drawing);
  // å¸¸ã«æ–°ã—ã„æç”»ã‚’å¯èƒ½ã«ã™ã‚‹ï¼ˆhasSentDataãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤ï¼‰
  
  drawing = true;
  const x = e.offsetX;
  const y = e.offsetY;
  
  // ãƒ™ã‚¸ã‚§æ›²ç·šç”¨ã®ç‚¹å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ
  pointHistory = [{ x, y }];
  
  console.log(`ğŸ–±ï¸ ãƒã‚¦ã‚¹é–‹å§‹åº§æ¨™: offsetX=${x}, offsetY=${y}`);
  
  // æç”»è¨­å®šã‚’åˆæœŸåŒ–ï¼ˆå‰ã®æç”»è¨­å®šã‚’ã‚¯ãƒªã‚¢ï¼‰
  ctx.shadowBlur = 0;
  ctx.shadowColor = 'transparent';
  ctx.globalAlpha = 1.0;
  
  // WriterIDåˆ¥æç”»çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
  resetWriterDrawingState('self');
  const selfState = getWriterDrawingState('self');
  selfState.lastPosition = { x, y };
  selfState.currentPath = [{ x, y }];
  selfState.isDrawing = true;
  
  // éŸ³æ¥½åˆ¶å¾¡ã¯é€ä¿¡å´ã§ã¯ç„¡åŠ¹åŒ–ï¼ˆå—ä¿¡å´ã®ã¿ã§éŸ³æ¥½å†ç”Ÿï¼‰
  
  // CanvasçŠ¶æ…‹ã‚’å®Œå…¨ã«åˆæœŸåŒ–ï¼ˆä»–WriterIDã¨ã®çŠ¶æ…‹æ··åœ¨ã‚’é˜²æ­¢ï¼‰
  ctx.beginPath(); // é‡è¦ï¼šä»–ã®Writerã®æœªå®Œäº†ãƒ‘ã‚¹ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢
  ctx.setTransform(1, 0, 0, 1, 0, 0); // å¤‰æ›è¡Œåˆ—ã‚’ãƒªã‚»ãƒƒãƒˆ
  ctx.globalCompositeOperation = 'source-over'; // åˆæˆãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
  ctx.moveTo(x, y);
  
  // ç·šã®å“è³ªã‚’å‘ä¸Šã•ã›ã‚‹è¨­å®š
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'high';
  
  // ãƒ¬ã‚¬ã‚·ãƒ¼å¤‰æ•°ã‚‚æ›´æ–°ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
  lastPosition = { x, y }; // åˆæœŸä½ç½®ã‚’è¨˜éŒ²
  currentPath = [{ x, y }]; // æ–°ã—ã„ãƒ‘ã‚¹ã‚’é–‹å§‹
  
  // æç”»ã‚³ãƒãƒ³ãƒ‰ã‚’è¨˜éŒ²
  const startCmd = {
    type: "start",
    x: x,
    y: y,
    thickness: currentPenThickness,
    color: currentPenColor === 'black' ? '#000' : currentPenColor
  };
  drawingCommands.push(startCmd);
  console.log(`ğŸ“‹ DEBUG: startä¿å­˜ - é…åˆ—æ•°=${drawingCommands.length}ä»¶`);
  
  // Writer IDãŒæœªè¨­å®šã®å ´åˆã¯é€ä¿¡ã—ãªã„
  if (!myWriterId) {
    console.warn("âš ï¸ Writer IDæœªè¨­å®šã®ãŸã‚æç”»ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¾ã›ã‚“");
    if (confirm("Writer IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\nğŸ”„ è‡ªå‹•ã§å†è¦æ±‚ã—ã¾ã™ã‹ï¼Ÿ\n\nã€ŒOKã€= è‡ªå‹•è¦æ±‚\nã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€= æ‰‹å‹•ã§å³ä¸Šã€ŒIDç¢ºèªã€ãƒœã‚¿ãƒ³")) {
      requestWriterId();
    }
    return;
  }
  
  const startMsg = { 
    type: "start", 
    writerId: myWriterId, // Writer ID ã‚’è¿½åŠ 
    x, 
    y,
    thickness: currentPenThickness,
    color: currentPenColor,
    starEffect: starEffectEnabled,
    fairyDustEffect: fairyDustEffectEnabled,
    heartEffect: heartEffectEnabled,
    canvasSize: { width: canvas.width, height: canvas.height }
  };
  if (socket && socket.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify(startMsg));
    // console.log("ğŸ“¤ é€ä¿¡ start:", startMsg);
  } else {
    console.error("âŒ WebSocketæ¥ç¶šãªã— - starté€ä¿¡å¤±æ•—");
  }
  
  // æ›¸ãæ‰‹å´ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼šã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã‚’ãƒšãƒ¼ã‚¸åº§æ¨™ã«å¤‰æ›
  const rect = canvas.getBoundingClientRect();
  const pageX = rect.left + x;
  const pageY = rect.top + y;

  // æ˜Ÿã‚¨ãƒ•ã‚§ã‚¯ãƒˆãŒæœ‰åŠ¹ãªå ´åˆã¯æ˜Ÿã‚’ç”Ÿæˆ
  if (starEffectEnabled) {
    createSenderStar(pageX, pageY);
  }
  
  // å¦–ç²¾ã®ç²‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãŒæœ‰åŠ¹ãªå ´åˆã¯å¦–ç²¾ã®ç²‰ã‚’ç”Ÿæˆ
  if (fairyDustEffectEnabled) {
    createFairyDust(pageX, pageY);
  }
});

canvas.addEventListener("mouseup", () => {
  drawing = false;
  
  // ãƒ™ã‚¸ã‚§æ›²ç·šç”¨ã®ç‚¹å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
  pointHistory = [];
  
  // WriterIDåˆ¥æç”»çŠ¶æ…‹ã‚’æ›´æ–°
  const selfState = getWriterDrawingState('self');
  selfState.isDrawing = false;
  
  // ç™½åœ°èµ¤ç¸ã®å ´åˆã¯èµ¤ã„ç¸ã‚’è¿½åŠ 
  if (currentPenColor === 'white-red-border' && currentPath.length > 1) {
    // èµ¤ã„å¤ªç·šã‚’æç”»ï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœä»˜ãï¼‰
    ctx.save();
    
    // å¤–å´ã®è–„ã„èµ¤ï¼ˆæœ€ã‚‚å¤ªã„ï¼‰
    ctx.beginPath();
    ctx.moveTo(currentPath[0].x, currentPath[0].y);
    ctx.lineWidth = currentPenThickness + 10;
    ctx.globalAlpha = 0.2;
    ctx.strokeStyle = '#ffccdd';
    // ctx.shadowBlur = 15; // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã®ãŸã‚ç„¡åŠ¹åŒ–
    ctx.shadowColor = '#ffccdd';
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    for (let i = 1; i < currentPath.length; i++) {
      ctx.lineTo(currentPath[i].x, currentPath[i].y);
    }
    ctx.stroke();
    
    // ä¸­é–“ã®èµ¤
    ctx.beginPath();
    ctx.moveTo(currentPath[0].x, currentPath[0].y);
    ctx.lineWidth = currentPenThickness + 8;
    ctx.globalAlpha = 0.5;
    ctx.strokeStyle = '#ffaacc';
    // ctx.shadowBlur = 10; // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã®ãŸã‚ç„¡åŠ¹åŒ–
    ctx.shadowColor = '#ffaacc';
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    for (let i = 1; i < currentPath.length; i++) {
      ctx.lineTo(currentPath[i].x, currentPath[i].y);
    }
    ctx.stroke();
    
    // å†…å´ã®æ¿ƒã„èµ¤ï¼ˆã‚³ã‚¢ï¼‰
    ctx.beginPath();
    ctx.moveTo(currentPath[0].x, currentPath[0].y);
    ctx.lineWidth = currentPenThickness + 6;
    ctx.globalAlpha = 0.8;
    ctx.strokeStyle = '#ff88bb';
    // ctx.shadowBlur = 6; // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã®ãŸã‚ç„¡åŠ¹åŒ–
    ctx.shadowColor = '#ff88bb';
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    for (let i = 1; i < currentPath.length; i++) {
      ctx.lineTo(currentPath[i].x, currentPath[i].y);
    }
    ctx.stroke();
    
    ctx.restore();
    
    // å…ƒã®ç™½ã„ç·šã‚’ä¸Šã«å†æç”»ï¼ˆã‚°ãƒ­ãƒ¼åŠ¹æœä»˜ãï¼‰
    ctx.save();
    ctx.beginPath();
    ctx.moveTo(currentPath[0].x, currentPath[0].y);
    ctx.lineWidth = Math.max(1, currentPenThickness - 3);
    ctx.globalAlpha = 0.9;
    ctx.strokeStyle = '#ffffff';
    // ctx.shadowBlur = 10; // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã®ãŸã‚ç„¡åŠ¹åŒ–
    ctx.shadowColor = '#ffffff';
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    for (let i = 1; i < currentPath.length; i++) {
      ctx.lineTo(currentPath[i].x, currentPath[i].y);
    }
    ctx.stroke();
    ctx.restore();
  }
  
  // ãƒ‘ã‚¹ã‚’ã‚¯ãƒªã‚¢
  currentPath = [];
  
  // ğŸ”¸ ä¸è¦ãª"end"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ï¼ˆå—ä¿¡å´ã§å‡¦ç†ã—ã¦ã„ãªã„ãŸã‚ï¼‰
});

canvas.addEventListener("mousemove", (e) => {
  const mouseMoveStart = performance.now();
  if (!drawing) return;
  
  // ğŸš€ éä¾µå…¥çš„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ãƒã‚§ãƒƒã‚¯
  if (!performanceOptimizer.shouldProcessMouseEvent()) {
    return; // 16msä»¥å†…ã®é€£ç¶šã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—
  }
  
  // å¸¸ã«æç”»ç¶™ç¶šã‚’å¯èƒ½ã«ã™ã‚‹ï¼ˆhasSentDataãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤ï¼‰
  
  const x = e.offsetX;
  const y = e.offsetY;
  
  // éŸ³æ¥½åˆ¶å¾¡ã¯é€ä¿¡å´ã§ã¯ç„¡åŠ¹åŒ–ï¼ˆå—ä¿¡å´ã®ã¿ã§éŸ³æ¥½å†ç”Ÿï¼‰
  
  let actualColor;
  
  // ãƒ™ã‚¸ã‚§æ›²ç·šã«ã‚ˆã‚‹æ»‘ã‚‰ã‹ãªæç”»
  if (lastPosition) {
    // ãƒšãƒ³è¨­å®š
    if (currentPenColor === 'white-red-border') {
      actualColor = 'white-red-border';
      ctx.globalAlpha = 0.9;
      ctx.lineWidth = Math.max(1, currentPenThickness - 3);
      ctx.strokeStyle = '#ffffff';
      ctx.shadowColor = '#ffffff';
    } else {
      actualColor = currentPenColor === 'black' ? '#000' : (currentPenColor === 'white' ? '#fff' : (currentPenColor === 'green' ? '#008000' : (currentPenColor === 'pink' ? '#ff69b4' : currentPenColor)));
      ctx.lineWidth = currentPenThickness;
      ctx.strokeStyle = actualColor;
      ctx.shadowBlur = 0;
      ctx.shadowColor = 'transparent';
      ctx.globalAlpha = 1.0;
    }
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    // ç‚¹å±¥æ­´ã«ç¾åœ¨ã®ç‚¹ã‚’è¿½åŠ 
    pointHistory.push({ x, y });
    if (pointHistory.length > MAX_POINT_HISTORY) {
      pointHistory.shift();
    }
    
    // ç‚¹ãŒ2ã¤ä»¥ä¸Šã‚ã‚‹å ´åˆã«æç”»
    if (pointHistory.length >= 2) {
      const len = pointHistory.length;
      
      if (len === 2) {
        // 2ç‚¹ã®å ´åˆã¯ç›´ç·š
        ctx.beginPath();
        ctx.moveTo(pointHistory[0].x, pointHistory[0].y);
        ctx.lineTo(pointHistory[1].x, pointHistory[1].y);
        ctx.stroke();
      } else {
        // 3ç‚¹ã®å ´åˆã¯ãƒ™ã‚¸ã‚§æ›²ç·š
        const p0 = pointHistory[len - 3];
        const p1 = pointHistory[len - 2];
        const p2 = pointHistory[len - 1];
        
        // ä¸­ç‚¹ã‚’è¨ˆç®—ã—ã¦æ»‘ã‚‰ã‹ãªæ›²ç·šã‚’æç”»
        const midPoint1 = {
          x: (p0.x + p1.x) / 2,
          y: (p0.y + p1.y) / 2
        };
        const midPoint2 = {
          x: (p1.x + p2.x) / 2,
          y: (p1.y + p2.y) / 2
        };
        
        ctx.beginPath();
        ctx.moveTo(midPoint1.x, midPoint1.y);
        ctx.quadraticCurveTo(p1.x, p1.y, midPoint2.x, midPoint2.y);
        ctx.stroke();
      }
    }
    
    currentPath.push({ x, y });
    ctx.globalAlpha = 1.0;
  }
  
  // æç”»ã‚³ãƒãƒ³ãƒ‰ã‚’è¨˜éŒ²
  const drawCmd = {
    type: "draw",
    x: x,
    y: y,
    thickness: currentPenThickness,
    color: actualColor
  };
  drawingCommands.push(drawCmd);
  // console.log(`ğŸ“‹ DEBUG: drawä¿å­˜ - é…åˆ—æ•°=${drawingCommands.length}ä»¶`); // è»½é‡åŒ–
  
  // ç¾åœ¨ã®ä½ç½®ã‚’è¨˜éŒ²
  lastPosition = { x, y };
  
  // Writer IDãŒæœªè¨­å®šã®å ´åˆã¯é€ä¿¡ã—ãªã„
  if (!myWriterId) {
    return;
  }
  
  const drawMsg = { 
    type: "draw", 
    writerId: myWriterId, // Writer ID ã‚’è¿½åŠ 
    x, 
    y,
    thickness: currentPenThickness,
    color: currentPenColor,
    starEffect: starEffectEnabled,
    fairyDustEffect: fairyDustEffectEnabled,
    heartEffect: heartEffectEnabled,
    canvasSize: { width: canvas.width, height: canvas.height }
  };
  if (socket && socket.readyState === WebSocket.OPEN) {
    const wsStart = performance.now();
    socket.send(JSON.stringify(drawMsg));
    const wsEnd = performance.now();
    if (wsEnd - wsStart > 1) {
      console.log(`ğŸ“¡ WebSocket send slow: ${(wsEnd - wsStart).toFixed(2)}ms`);
    }
  }
  // console.log("ğŸ“¤ é€ä¿¡ draw:", drawMsg, `myWriterId=${myWriterId}`); // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
  
  
  // æ›¸ãæ‰‹å´ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼šã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã‚’ãƒšãƒ¼ã‚¸åº§æ¨™ã«å¤‰æ›
  const rect = canvas.getBoundingClientRect();
  const pageX = rect.left + x;
  const pageY = rect.top + y;

  // ğŸš€ éä¾µå…¥çš„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’éºå»¶å®Ÿè¡Œ
  if (starEffectEnabled) {
    performanceOptimizer.scheduleEffect(() => createSenderStar(pageX, pageY));
  }
  if (fairyDustEffectEnabled) {
    performanceOptimizer.scheduleEffect(() => createFairyDust(pageX, pageY));
  }
  if (heartEffectEnabled) {
    performanceOptimizer.scheduleEffect(() => createDrawingHeart(pageX, pageY));
  }
  
  const mouseMoveEnd = performance.now();
  if (mouseMoveEnd - mouseMoveStart > 10) {
    console.log(`ğŸ–±ï¸ mousemove slow: ${(mouseMoveEnd - mouseMoveStart).toFixed(2)}ms`);
  }
});

// ğŸ”¸ ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå¯¾å¿œï¼šã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆï¼ˆPCç”¨æç”»å‡¦ç†ã¨å®Œå…¨çµ±ä¸€ï¼‰
canvas.addEventListener("touchstart", (e) => {
  e.preventDefault();
  console.log('ğŸ“± DEBUG: touchstart - PCç”¨å‡¦ç†ã¨çµ±ä¸€');
  
  drawing = true;
  const touch = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  const x = (touch.clientX - rect.left) * scaleX;
  const y = (touch.clientY - rect.top) * scaleY;
  
  // ãƒ™ã‚¸ã‚§æ›²ç·šç”¨ã®ç‚¹å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ
  pointHistory = [{ x, y }];
  
  // èƒŒæ™¯ç”»åƒã®ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆPCç”¨ã¨åŒã˜å‡¦ç†ï¼‰
  if (!isWithinBackgroundArea(x, y)) {
    console.log('ğŸ“± èƒŒæ™¯ç”»åƒç¯„å›²å¤– - æç”»ä¸­æ–­');
    drawing = false;
    return;
  }
  
  // PCç”¨ã¨å®Œå…¨åŒã˜æç”»å‡¦ç†ã‚’ã‚³ãƒ”ãƒ¼
  isPaintDrawing = true;
  lastPaintPos = { x, y };
  
  ctx.shadowBlur = 0;
  ctx.shadowColor = 'transparent';
  ctx.globalAlpha = 1.0;
  
  // PCç”¨ã¨å®Œå…¨åŒã˜æç”»å‡¦ç†
  ctx.beginPath();
  
  let actualColor = currentPenColor === 'black' ? '#000' : (currentPenColor === 'white' ? '#fff' : (currentPenColor === 'green' ? '#008000' : (currentPenColor === 'pink' ? '#ff69b4' : currentPenColor)));
  
  if (currentPenColor === 'white-red-border') {
    // ç™½åœ°èµ¤ç¸ã®ç‰¹åˆ¥å‡¦ç†ï¼ˆPCç‰ˆã¨åŒã˜ï¼‰
    ctx.beginPath();
    ctx.globalAlpha = 0.3;
    ctx.lineWidth = currentPenThickness + 8;
    ctx.strokeStyle = '#ffccdd';
    ctx.shadowColor = '#ffccdd';
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.moveTo(x, y);
    ctx.lineTo(x + 0.1, y + 0.1);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.globalAlpha = 0.8;
    ctx.lineWidth = currentPenThickness + 6;
    ctx.strokeStyle = '#ff88bb';
    ctx.shadowColor = '#ff88bb';
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.moveTo(x, y);
    ctx.lineTo(x + 0.1, y + 0.1);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.globalAlpha = 0.9;
    ctx.lineWidth = Math.max(1, currentPenThickness - 3);
    ctx.strokeStyle = '#ffffff';
    ctx.shadowColor = '#ffffff';
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.moveTo(x, y);
    ctx.lineTo(x + 0.1, y + 0.1);
    ctx.stroke();
    
    ctx.globalAlpha = 1.0;
  } else {
    // é€šå¸¸ã®è‰²ã®æç”»ï¼ˆPCç‰ˆã¨åŒã˜ï¼‰
    ctx.lineWidth = currentPenThickness;
    ctx.strokeStyle = actualColor;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.moveTo(x, y);
    
    ctx.lineTo(x + 0.1, y + 0.1);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
  }
  
  // è‡ªåˆ†ã®æç”»ã‚³ãƒãƒ³ãƒ‰ã¨ã—ã¦ä¿å­˜ï¼ˆPCç‰ˆã¨åŒã˜ï¼‰
  const startCmd = {
    type: "start",
    x: x,
    y: y,
    thickness: currentPenThickness,
    color: currentPenColor === 'black' ? '#000' : currentPenColor
  };
  drawingCommands.push(startCmd);
  console.log(`ğŸ“‹ DEBUG: startä¿å­˜ - é…åˆ—æ•°=${drawingCommands.length}ä»¶`);
  
  // WebSocketé€ä¿¡ï¼ˆPCç‰ˆã¨åŒã˜ï¼‰
  const startMsg = {
    type: "start",
    x: x,
    y: y,
    thickness: currentPenThickness,
    color: currentPenColor,
    writerId: myWriterId,
    timestamp: Date.now()
  };
  if (socket && socket.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify(startMsg));
    const isValidCoord = x >= 0 && x <= canvas.width && y >= 0 && y <= canvas.height;
    /* console.log("ğŸ“¤ ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆæç”»é–‹å§‹ãƒ‡ãƒ¼ã‚¿é€ä¿¡:", {
      type: startMsg.type,
      writerId: startMsg.writerId,
      x: Math.round(x),
      y: Math.round(y),
      canvasSize: `${canvas.width}x${canvas.height}`,
      åº§æ¨™å¦¥å½“æ€§: isValidCoord
    }); */ // è»½é‡åŒ–
  }
  
  // æ›¸ãæ‰‹å´ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼šã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã‚’ãƒšãƒ¼ã‚¸åº§æ¨™ã«å¤‰æ›ï¼ˆæ—¢å­˜ã®rectå¤‰æ•°ã‚’å†åˆ©ç”¨ï¼‰
  const pageX = rect.left + x;
  const pageY = rect.top + y;

  // æ˜Ÿã‚¨ãƒ•ã‚§ã‚¯ãƒˆãŒæœ‰åŠ¹ãªå ´åˆã¯æ˜Ÿã‚’ç”Ÿæˆ
  if (starEffectEnabled) {
    createSenderStar(pageX, pageY);
  }
  
  // å¦–ç²¾ã®ç²‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãŒæœ‰åŠ¹ãªå ´åˆã¯å¦–ç²¾ã®ç²‰ã‚’ç”Ÿæˆ
  if (fairyDustEffectEnabled) {
    createFairyDust(pageX, pageY);
  }
});

canvas.addEventListener("touchend", (e) => {
  e.preventDefault();
  // console.log('ğŸ“± DEBUG: touchend - PCç”¨å‡¦ç†ã¨çµ±ä¸€'); // è»½é‡åŒ–
  
  // PCç”¨ã¨åŒã˜å‡¦ç†ã«çµ±ä¸€
  drawing = false;
  
  // ãƒ™ã‚¸ã‚§æ›²ç·šç”¨ã®ç‚¹å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
  pointHistory = [];
  isPaintDrawing = false;
  lastPaintPos = null;
  
  // ç™½åœ°èµ¤ç¸ã®å ´åˆã¯èµ¤ã„ç¸ã‚’è¿½åŠ 
  if (currentPenColor === 'white-red-border' && currentPath.length > 1) {
    // èµ¤ã„å¤ªç·šã‚’æç”»ï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœä»˜ãï¼‰
    ctx.save();
    
    // å¤–å´ã®è–„ã„èµ¤ï¼ˆæœ€ã‚‚å¤ªã„ï¼‰
    ctx.beginPath();
    ctx.moveTo(currentPath[0].x, currentPath[0].y);
    ctx.lineWidth = currentPenThickness + 10;
    ctx.globalAlpha = 0.2;
    ctx.strokeStyle = '#ffccdd';
    // ctx.shadowBlur = 15; // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã®ãŸã‚ç„¡åŠ¹åŒ–
    ctx.shadowColor = '#ffccdd';
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    for (let i = 1; i < currentPath.length; i++) {
      ctx.lineTo(currentPath[i].x, currentPath[i].y);
    }
    ctx.stroke();
    
    // ä¸­é–“ã®èµ¤
    ctx.beginPath();
    ctx.moveTo(currentPath[0].x, currentPath[0].y);
    ctx.lineWidth = currentPenThickness + 8;
    ctx.globalAlpha = 0.5;
    ctx.strokeStyle = '#ffaacc';
    // ctx.shadowBlur = 10; // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã®ãŸã‚ç„¡åŠ¹åŒ–
    ctx.shadowColor = '#ffaacc';
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    for (let i = 1; i < currentPath.length; i++) {
      ctx.lineTo(currentPath[i].x, currentPath[i].y);
    }
    ctx.stroke();
    
    // å†…å´ã®æ¿ƒã„èµ¤ï¼ˆã‚³ã‚¢ï¼‰
    ctx.beginPath();
    ctx.moveTo(currentPath[0].x, currentPath[0].y);
    ctx.lineWidth = currentPenThickness + 6;
    ctx.globalAlpha = 0.8;
    ctx.strokeStyle = '#ff88bb';
    // ctx.shadowBlur = 6; // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã®ãŸã‚ç„¡åŠ¹åŒ–
    ctx.shadowColor = '#ff88bb';
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    for (let i = 1; i < currentPath.length; i++) {
      ctx.lineTo(currentPath[i].x, currentPath[i].y);
    }
    ctx.stroke();
    
    ctx.restore();
    
    // å…ƒã®ç™½ã„ç·šã‚’ä¸Šã«å†æç”»ï¼ˆã‚°ãƒ­ãƒ¼åŠ¹æœä»˜ãï¼‰
    ctx.save();
    ctx.beginPath();
    ctx.moveTo(currentPath[0].x, currentPath[0].y);
    ctx.lineWidth = Math.max(1, currentPenThickness - 3);
    ctx.globalAlpha = 0.9;
    ctx.strokeStyle = '#ffffff';
    // ctx.shadowBlur = 10; // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã®ãŸã‚ç„¡åŠ¹åŒ–
    ctx.shadowColor = '#ffffff';
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    for (let i = 1; i < currentPath.length; i++) {
      ctx.lineTo(currentPath[i].x, currentPath[i].y);
    }
    ctx.stroke();
    ctx.restore();
  }
  
  // ãƒ‘ã‚¹ã‚’ã‚¯ãƒªã‚¢
  currentPath = [];
});

// ã‚¿ãƒƒãƒæç”»ã®ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ç”¨å¤‰æ•°
let touchAnimationFrame = null;
let pendingTouchData = null;

canvas.addEventListener("touchmove", (e) => {
  e.preventDefault();
  if (!isPaintDrawing || !lastPaintPos) return;
  
  // ğŸš€ éä¾µå…¥çš„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°
  if (!performanceOptimizer.shouldProcessTouchEvent()) {
    return; // 16msä»¥å†…ã®é€£ç¶šã‚¿ãƒƒãƒã‚’ã‚¹ã‚­ãƒƒãƒ—
  }
  
  // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æ¸›ã‚‰ã™ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰
  if (Math.random() < 0.01) {
    // console.log('ğŸ“± DEBUG: touchmove - PCç”¨å‡¦ç†ã¨çµ±ä¸€'); // è»½é‡åŒ–
  }
  
  const touch = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  const x = (touch.clientX - rect.left) * scaleX;
  const y = (touch.clientY - rect.top) * scaleY;
  
  // èƒŒæ™¯ç”»åƒã®ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆPCç”¨ã¨åŒã˜å‡¦ç†ï¼‰
  if (!isWithinBackgroundArea(x, y)) {
    console.log('ğŸ“± èƒŒæ™¯ç”»åƒç¯„å›²å¤– - æç”»ä¸­æ–­');
    isPaintDrawing = false;
    lastPaintPos = null;
    return;
  }
  
  // ãƒ™ã‚¸ã‚§æ›²ç·šã«ã‚ˆã‚‹æ»‘ã‚‰ã‹ãªæç”»
  pointHistory.push({ x, y });
  if (pointHistory.length > MAX_POINT_HISTORY) {
    pointHistory.shift();
  }
  
  // ç‚¹ãŒ2ã¤ä»¥ä¸Šã‚ã‚‹å ´åˆã«æç”»
  if (pointHistory.length >= 2) {
    const len = pointHistory.length;
    
    if (len === 2) {
      // 2ç‚¹ã®å ´åˆã¯ç›´ç·š
      ctx.beginPath();
      ctx.moveTo(pointHistory[0].x, pointHistory[0].y);
      ctx.lineTo(pointHistory[1].x, pointHistory[1].y);
      ctx.stroke();
    } else {
      // 3ç‚¹ã®å ´åˆã¯ãƒ™ã‚¸ã‚§æ›²ç·š
      const p0 = pointHistory[len - 3];
      const p1 = pointHistory[len - 2];
      const p2 = pointHistory[len - 1];
      
      // ä¸­ç‚¹ã‚’è¨ˆç®—ã—ã¦æ»‘ã‚‰ã‹ãªæ›²ç·šã‚’æç”»
      const midPoint1 = {
        x: (p0.x + p1.x) / 2,
        y: (p0.y + p1.y) / 2
      };
      const midPoint2 = {
        x: (p1.x + p2.x) / 2,
        y: (p1.y + p2.y) / 2
      };
      
      ctx.beginPath();
      ctx.moveTo(midPoint1.x, midPoint1.y);
      ctx.quadraticCurveTo(p1.x, p1.y, midPoint2.x, midPoint2.y);
      ctx.stroke();
    }
  }
  
  // è‡ªåˆ†ã®æç”»ã‚³ãƒãƒ³ãƒ‰ã¨ã—ã¦ä¿å­˜ï¼ˆPCç‰ˆã¨åŒã˜ï¼‰
  const actualColor = currentPenColor === 'white-red-border' ? '#ffffff' : 
                     (currentPenColor === 'black' ? '#000' : 
                     (currentPenColor === 'white' ? '#fff' : 
                     (currentPenColor === 'green' ? '#008000' : 
                     (currentPenColor === 'pink' ? '#ff69b4' : currentPenColor))));
  const drawCmd = {
    type: "draw",
    x: x,
    y: y,
    thickness: currentPenThickness,
    color: actualColor
  };
  drawingCommands.push(drawCmd);
  // console.log(`ğŸ“‹ DEBUG: drawä¿å­˜ - é…åˆ—æ•°=${drawingCommands.length}ä»¶`); // è»½é‡åŒ–
  
  // WebSocketé€ä¿¡ï¼ˆPCç‰ˆã¨åŒã˜ï¼‰
  const drawMsg = {
    type: "draw",
    x: x,
    y: y,
    thickness: currentPenThickness,
    color: currentPenColor,
    writerId: myWriterId,
    timestamp: Date.now(),
    starEffect: starEffectEnabled,
    fairyDustEffect: fairyDustEffectEnabled,
    canvasSize: {
      width: canvas.width,
      height: canvas.height
    }
  };
  if (socket && socket.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify(drawMsg));
    // ğŸš€ éä¾µå…¥çš„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: ãƒ­ã‚°ã‚’ã•ã‚‰ã«æ¸›ã‚‰ã™
    if (Math.random() < 0.01) {
      /* console.log("ğŸ“¤ ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆæç”»ç¶™ç¶šãƒ‡ãƒ¼ã‚¿é€ä¿¡:", {
        writerId: drawMsg.writerId,
        x: Math.round(x),
        y: Math.round(y)
      }); */ // è»½é‡åŒ–
    }
  }
  
  lastPaintPos = { x, y };
});

// ğŸ”¸ ãƒ“ãƒ‡ã‚ªã‚µã‚¤ã‚ºè¨­å®šé–¢æ•°
function setVideoSize(size) {
  currentVideoSize = size;
  
  // ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
  document.getElementById("size100Btn").classList.remove("selected");
  document.getElementById("size90Btn").classList.remove("selected");
  document.getElementById("size80Btn").classList.remove("selected");
  
  document.getElementById(`size${size}Btn`).classList.add("selected");
  
  // console.log(`ğŸ“ ãƒ“ãƒ‡ã‚ªã‚µã‚¤ã‚ºã‚’${size}%ã«è¨­å®š`);
  
  // å—ä¿¡å´ã«ã‚µã‚¤ã‚ºæƒ…å ±ã‚’é€ä¿¡
  if (socket.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({ 
      type: "videoSize", 
      size: size 
    }));
  }
}

// ğŸ”¸ ãƒ“ãƒ‡ã‚ªå†ç”Ÿé–¢æ•°
function playVideo() {
  if (socket.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({ 
      type: "playVideo",
      size: currentVideoSize
    }));
    // console.log(`ğŸ“¹ ãƒ“ãƒ‡ã‚ªå†ç”ŸæŒ‡ç¤ºã‚’é€ä¿¡ï¼ˆã‚µã‚¤ã‚º: ${currentVideoSize}%ï¼‰`);
  } else {
    console.error("âŒ WebSocketæ¥ç¶šãªã—");
  }
}

// ğŸ”¸ Dev Tools é–¢æ•°
function toggleDevTools() {
  const devTools = document.getElementById("devTools");
  devTools.style.display = devTools.style.display === "none" ? "block" : "none";
}

function updateCanvasScale(value) {
  canvasScale = parseFloat(value);
  document.getElementById("canvasScaleValue").textContent = value + "x";
  
  // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºå¤‰æ›´ã‚’å—ä¿¡å´ã«é€šçŸ¥
  if (socket.readyState === WebSocket.OPEN && myWriterId) {
    const canvasSize = {
      width: canvas.width,
      height: canvas.height
    };
    
    socket.send(JSON.stringify({
      type: "canvasSizeUpdate",
      canvasSize: canvasSize,
      scale: canvasScale,
      writerId: myWriterId
    }));
    
    console.log(`ğŸ“¡ ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºå¤‰æ›´ã‚’å—ä¿¡å´ã«é€ä¿¡: ${canvas.width}x${canvas.height}, scale=${canvasScale}`);
  }
}

function updateAnimationStartWait(value) {
  animationStartWaitTime = parseFloat(value);
  document.getElementById("animationStartWaitValue").textContent = value + "ç§’";
}

function updateRotationWait(value) {
  rotationWaitTime = parseFloat(value);
  document.getElementById("rotationWaitValue").textContent = value + "ç§’";
}

function sendDevSettings() {
  if (socket.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({
      type: "devSettings",
      canvasScale: canvasScale,
      animationStartWaitTime: animationStartWaitTime,
      rotationWaitTime: rotationWaitTime
    }));
    // console.log(`ğŸ”§ Devè¨­å®šé€ä¿¡: scale=${canvasScale}, animationWait=${animationStartWaitTime}, rotationWait=${rotationWaitTime}`);
    // console.log("âœ… è¨­å®šã‚’å—ä¿¡å´ã«é€ä¿¡ã—ã¾ã—ãŸ");
  } else {
    console.error("âŒ WebSocketæ¥ç¶šãªã—");
  }
}

// æç”»ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹é…åˆ—
let drawingCommands = [];

function saveRotatedImage() {
  // console.log('ğŸ“¤ é€ä¿¡ãƒœã‚¿ãƒ³: 180åº¦å›è»¢ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹');
  
  try {
    // æœ€çµ‚çš„ãªç”»åƒç”¨ã®canvasã‚’ä½œæˆ
    const finalCanvas = document.createElement('canvas');
    const finalCtx = finalCanvas.getContext('2d');
    finalCanvas.width = canvas.width;
    finalCanvas.height = canvas.height;
    
    // 1. èƒŒæ™¯ã‚’å…ˆã«æç”»ï¼ˆå›è»¢ã•ã›ãªã„ï¼‰
    if (backgroundImage) {
      finalCtx.drawImage(backgroundImage, 0, 0, finalCanvas.width, finalCanvas.height);
    } else {
      // ç™½èƒŒæ™¯ã§å¡—ã‚Šã¤ã¶ã—
      finalCtx.fillStyle = '#ffffff';
      finalCtx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
    }
    
    // 2. ãƒšã‚¤ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’180åº¦å›è»¢ã•ã›ã¦æç”»
    if (drawingCommands.length > 0) {
      // console.log(`ğŸ¨ æç”»ã‚³ãƒãƒ³ãƒ‰æ•°: ${drawingCommands.length}`);
      
      // 180åº¦å›è»¢å¤‰æ›ã‚’é©ç”¨
      finalCtx.save();
      finalCtx.translate(finalCanvas.width, finalCanvas.height);
      finalCtx.rotate(Math.PI);
      
      // æç”»ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œï¼ˆåº§æ¨™ã¯å…ƒã®ã¾ã¾ã€ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒå›è»¢ã—ã¦ã„ã‚‹ï¼‰
      drawingCommands.forEach(cmd => {
        if (cmd.type === 'start') {
          finalCtx.beginPath();
          finalCtx.moveTo(cmd.x, cmd.y);
        } else if (cmd.type === 'draw') {
          finalCtx.lineWidth = cmd.thickness || 8;
          finalCtx.strokeStyle = cmd.color || 'black';
          finalCtx.lineTo(cmd.x, cmd.y);
          finalCtx.stroke();
        }
      });
      
      finalCtx.restore();
      // console.log('ğŸ”„ ãƒšã‚¤ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®180åº¦å›è»¢å‡¦ç†å®Œäº†');
    } else {
      // console.log('âš ï¸ æç”»ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
    }
    
    // è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    const imageDataUrl = finalCanvas.toDataURL('image/png');
    const link = document.createElement('a');
    const now = new Date();
    const fileName = `rotated_${now.getFullYear()}${(now.getMonth() + 1)
      .toString().padStart(2, "0")}${now.getDate().toString().padStart(2, "0")}_${now
      .getHours().toString().padStart(2, "0")}${now.getMinutes().toString().padStart(2, "0")}${now
      .getSeconds().toString().padStart(2, "0")}.png`;
    
    link.download = fileName;
    link.href = imageDataUrl;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // console.log('ğŸ“¥ 180åº¦å›è»¢ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†:', fileName);
    
  } catch (error) {
    console.error('âŒ 180åº¦å›è»¢ç”»åƒä¿å­˜ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.message, error);
    alert('ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

// ç¾åœ¨ã®çŠ¶æ…‹ã‹ã‚‰æ›´ã«180åº¦å›è»¢ã•ã›ã¦ä¿å­˜ã™ã‚‹é–¢æ•°
function saveDoubleRotatedImage() {
  // éŸ³æ¥½åˆ¶å¾¡ã¯é€ä¿¡å´ã§ã¯ç„¡åŠ¹åŒ–ï¼ˆå—ä¿¡å´ã®ã¿ã§éŸ³æ¥½å†ç”Ÿï¼‰
  
  console.log(`ğŸ”„ğŸ”„ğŸ”„ é€ä¿¡ãƒœã‚¿ãƒ³æŠ¼ä¸‹: globalSendé€ä¿¡é–‹å§‹â†’${animationStartWaitTime}ç§’å¾Œã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ ğŸ”„ğŸ”„ğŸ”„`);
  
  // ğŸ”¸ ã¾ãšå—ä¿¡å´ã«å°åˆ·æŒ‡ç¤ºã‚’é€ä¿¡ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã£ã¦ã„ã‚‹çŠ¶æ…‹ã§ï¼‰
  console.log('ğŸ“¤ğŸ“¤ğŸ“¤ å—ä¿¡å´ã«globalSendæŒ‡ç¤ºã‚’é€ä¿¡ä¸­... ğŸ“¤ğŸ“¤ğŸ“¤');
  socket.send(JSON.stringify({
    type: "globalSend",
    writerId: myWriterId,
    timestamp: Date.now(),
    animationStartWaitTime: animationStartWaitTime,
    rotationWaitTime: rotationWaitTime
  }));
  console.log('âœ…âœ…âœ… å—ä¿¡å´ã¸ã®globalSendæŒ‡ç¤ºé€ä¿¡å®Œäº† âœ…âœ…âœ…');
  
  // ğŸ”¸ å°‘ã—å¾…ã£ã¦ã‹ã‚‰é€ä¿¡å´ã®å°åˆ·å‡¦ç†ã®ã¿å®Ÿè¡Œ
  setTimeout(() => {
    // console.log('ğŸ–¨ï¸ é€ä¿¡å´å°åˆ·å‡¦ç†ã‚’å®Ÿè¡Œ');
    // console.log(`ğŸ“ å°åˆ·å‰ã®æç”»ã‚³ãƒãƒ³ãƒ‰æ•°: ${drawingCommands.length}`);
    actualPrintProcess();
    // console.log('âœ… é€ä¿¡å´å°åˆ·å‡¦ç†å®Œäº†ï¼ˆæç”»ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒï¼‰');
  }, 500); // å—ä¿¡å´ã®å°åˆ·å‡¦ç†ãŒé–‹å§‹ã•ã‚Œã‚‹ã¾ã§500mså¾…æ©Ÿ
  
  // ğŸ”„ é€ä¿¡ç›´å¾Œã«æ–°ã—ã„æç”»ã‚’å¯èƒ½ã«ã™ã‚‹ãŸã‚ã€hasSentDataãƒ•ãƒ©ã‚°ã‚’å³åº§ã«ãƒªã‚»ãƒƒãƒˆ
  // é€ä¿¡æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã€ã™ãã«æ–°ã—ã„æç”»ã‚’å¯èƒ½ã«ã™ã‚‹
  hasSentData = false;
  console.log('ğŸ”“ é€ä¿¡ç›´å¾Œ: hasSentDataã‚’ãƒªã‚»ãƒƒãƒˆ - æ–°ã—ã„æç”»ã¨ä»–writerãƒ‡ãƒ¼ã‚¿å—ä¿¡ã‚’å†é–‹');
  
  // ğŸ”„ å—ä¿¡å´ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«é€ä¿¡è€…å´ã®ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ã¨è‡ªå‹•Clearå‡¦ç†ã‚’å®Ÿè¡Œ
  const totalAnimationTime = (animationStartWaitTime + 1 + rotationWaitTime + 2) * 1000; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹å¾…æ©Ÿ + å›è»¢1ç§’ + å›è»¢å¾Œå¾…æ©Ÿ + ã‚¹ãƒ©ã‚¤ãƒ‰2ç§’
  console.log(`ğŸ”„ é€ä¿¡å®Œäº† â†’ ${totalAnimationTime/1000}ç§’å¾Œï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œï¼‰ã«é€ä¿¡è€…ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ + è‡ªå‹•Clearå‡¦ç†ã‚’å®Ÿè¡Œ`);
  setTimeout(() => {
    // ğŸ”¸ é€ä¿¡è€…å´ã®ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œï¼‰
    otherWritersData = {};
    drawingCommands = []; // ğŸ”¥ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«è‡ªåˆ†ã®æç”»ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¯ãƒªã‚¢
    console.log('ğŸ§¹ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œ: å…¨æç”»ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢');
    console.log('ğŸ§¹ otherWritersDataé…å»¶ã‚¯ãƒªã‚¢:', Object.keys(otherWritersData).length);
    console.log('ğŸ§¹ drawingCommandsé…å»¶ã‚¯ãƒªã‚¢:', drawingCommands.length);
    
    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’å†æç”»ï¼ˆç©ºã®çŠ¶æ…‹ï¼‰- é…å»¶å®Ÿè¡Œ
    if (window.saveDoubleRotatedRedrawTimeout) {
      clearTimeout(window.saveDoubleRotatedRedrawTimeout);
    }
    
    window.saveDoubleRotatedRedrawTimeout = setTimeout(() => {
      redrawCanvasWithOthers();
      window.saveDoubleRotatedRedrawTimeout = null;
    }, 10);
    
    // å…¨æ›¸ãæ‰‹åŒæœŸã®ãŸã‚ã®ã‚¯ãƒªã‚¢å‘½ä»¤ã‚’é€ä¿¡
    socket.send(JSON.stringify({ 
      type: "globalClear",
      writerId: myWriterId,
      timestamp: Date.now()
    }));
    console.log('ğŸ“¤ è‡ªå‹•Clear: å…¨æ›¸ãæ‰‹ã«ã‚¯ãƒªã‚¢æŒ‡ç¤ºã‚’é€ä¿¡');
    console.log('âœ… è‡ªå‹•Clearå‡¦ç†å®Œäº†ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œï¼‰');
  }, totalAnimationTime); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«è‡ªå‹•Clearå®Ÿè¡Œ
  
  // ğŸ”¸ é€ä¿¡ãƒœã‚¿ãƒ³ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
  const sendButton = event.target;
  sendButton.style.transform = 'scale(0.95)';
  sendButton.style.backgroundColor = '#ff1493';
  sendButton.style.color = '#fff';
  sendButton.textContent = 'é€ä¿¡ä¸­...';
  sendButton.disabled = true;
  
  // ğŸ”¸ æ‰“ã¡ä¸Šã’èŠ±ç«æ¼”å‡ºã‚’è¿½åŠ ï¼ˆå—ä¿¡å´ã¨åŒæœŸï¼‰
  // å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œ1ç§’ã§å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã‚¿ã‚¤ãƒŸãƒ³ã‚°èª¿æ•´
  const fireworksCheckbox = document.getElementById('fireworksEffect');
  if (fireworksCheckbox.checked) {
    const fireworksDelay = animationStartWaitTime * 1000 + 2500; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹å¾…æ©Ÿæ™‚é–“ + å›è»¢æ™‚é–“(1.5ç§’) + 1ç§’
    setTimeout(() => {
      // console.log('ğŸ† é€ä¿¡å´ï¼šå›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œ1ç§’ã§èŠ±ç«ã‚’å®Ÿè¡Œ');
      createFireworks();
    }, fireworksDelay);
  } else {
    // console.log('ğŸ† èŠ±ç«æ¼”å‡ºã¯ã‚ªãƒ•ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™');
  }
  
  // ğŸ”¸ ç´™å¹é›ªæ¼”å‡ºã‚’è¿½åŠ ï¼ˆå—ä¿¡å´ã¨åŒæœŸï¼‰
  const confettiCheckbox = document.getElementById('confettiEffect');
  if (confettiCheckbox.checked) {
    const confettiDelay = animationStartWaitTime * 1000 + 2500 + (rotationWaitTime * 1000) - 1500; // èŠ±ç«ã¨åŒã˜ã‚¿ã‚¤ãƒŸãƒ³ã‚° + å›è»¢å¾Œå¾…æ©Ÿæ™‚é–“ - 1.5ç§’å‰
    setTimeout(() => {
      // console.log('ğŸŠ é€ä¿¡å´ï¼šç´™å¹é›ªæ¼”å‡ºã‚’å®Ÿè¡Œ');
      createConfetti();
    }, confettiDelay);
  } else {
    // console.log('ğŸŠ ç´™å¹é›ªæ¼”å‡ºã¯ã‚ªãƒ•ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™');
  }
  
  // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
  setTimeout(() => {
    sendButton.style.transform = 'scale(1)';
    sendButton.style.backgroundColor = '';
    sendButton.style.color = '';
    sendButton.textContent = 'é€ä¿¡';
    sendButton.disabled = false;
  }, 2000);
  
  // ğŸ”¸ å°åˆ·å‡¦ç†ã¯æ—¢ã«ä¸Šã§å®Ÿè¡Œæ¸ˆã¿
  
  // ğŸ”¸ å°åˆ·å‡¦ç†é–‹å§‹ã®è¨­å®šæ™‚é–“å¾Œã«å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
  // console.log(`ğŸ¬ å°åˆ·å‡¦ç†é–‹å§‹ã‹ã‚‰${animationStartWaitTime}ç§’å¾Œã«å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œäºˆå®š`);
  
  // è¨­å®šæ™‚é–“å¾Œã«WebSocketçµŒç”±ã§å—ä¿¡å´ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ã‚’é€šçŸ¥
  setTimeout(() => {
    if (socket && socket.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify({
        type: "startRotationAnimation",
        waitTime: rotationWaitTime, // å›è»¢å¾Œå¾…æ©Ÿæ™‚é–“ã‚’è¨­å®šå€¤ã‹ã‚‰å–å¾—
        fireworksEnabled: document.getElementById('fireworksEffect').checked,
        confettiEnabled: document.getElementById('confettiEffect').checked
      }));
      // console.log(`ğŸ¬ å°åˆ·é–‹å§‹ã‹ã‚‰${animationStartWaitTime}ç§’å¾Œã«å—ä¿¡å´ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ã‚’é€ä¿¡ (å›è»¢å¾Œ${rotationWaitTime}ç§’å¾…æ©Ÿ)`);
    }
  }, animationStartWaitTime * 1000); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹å¾…æ©Ÿæ™‚é–“ï¼ˆç§’ã‚’ãƒŸãƒªç§’ã«å¤‰æ›ï¼‰
  
  // ğŸ”¸ é€ä¿¡ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã‹ã‚‰10ç§’å¾Œã«ã‚¯ãƒªã‚¢ã‚’å®Ÿè¡Œï¼ˆå°åˆ·ãŒå³åº§ã«é–‹å§‹ã•ã‚Œã‚‹ãŸã‚ï¼‰
  setTimeout(() => {
    // console.log('ğŸ§¹ é€ä¿¡ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã‹ã‚‰10ç§’å¾Œã«ã‚¯ãƒªã‚¢å®Ÿè¡Œ');
    
    // ğŸ”’ é€ä¿¡æ¸ˆã¿ãƒ•ãƒ©ã‚°ã¯ç¶­æŒï¼ˆæ‰‹å‹•ã§Clearãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¾ã§ä»–ã®writerãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ãªã„ï¼‰
    // hasSentData = false; // ã“ã®è¡Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
    // console.log('ğŸ”’ é€ä¿¡æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ç¶­æŒ - ä»–ã®writerãƒ‡ãƒ¼ã‚¿å—ä¿¡ã‚’ç¶™ç¶šã—ã¦æ‹’å¦');
    
    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // èƒŒæ™¯ç”»åƒãŒã‚ã‚Œã°å†æç”»ï¼ˆå›è»¢ãªã—ï¼‰
    if (backgroundImage) {
      drawBackgroundImage(ctx, backgroundImage, canvas);
      // console.log('ğŸ–¼ï¸ èƒŒæ™¯ç”»åƒã‚’å†æç”»');
    }
    
    // å…¨ã¦ã®æç”»ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã‚¯ãƒªã‚¢
    drawingCommands = [];
    otherWritersData = {};
    // console.log('ğŸ§¹ é€ä¿¡å´ï¼šå…¨æç”»ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã‚¯ãƒªã‚¢');
    // console.log('ğŸ§¹ drawingCommandsé…åˆ—ã‚’ã‚¯ãƒªã‚¢:', drawingCommands.length);
    // console.log('ğŸ§¹ otherWritersDataé…åˆ—ã‚’ã‚¯ãƒªã‚¢:', Object.keys(otherWritersData).length);
    
    // å—ä¿¡å´ã«ã‚‚ã‚¯ãƒªã‚¢æŒ‡ç¤ºã‚’é€ä¿¡
    if (socket && socket.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify({ type: "clear" }));
      // console.log('ğŸ“¤ å—ä¿¡å´ã«ã‚¯ãƒªã‚¢æŒ‡ç¤ºã‚’é€ä¿¡');
    }
    
    // console.log('âœ… é€ä¿¡ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã‹ã‚‰10ç§’å¾Œã®ã‚¯ãƒªã‚¢å®Œäº†');
  }, 10000); // é€ä¿¡ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã‹ã‚‰10ç§’å¾Œã«ã‚¯ãƒªã‚¢
}

// å®Ÿéš›ã®å°åˆ·å‡¦ç†ã‚’è¡Œã†é–¢æ•°
function actualPrintProcess() {
  try {
    // æ–°ã—ã„canvasã‚’ä½œæˆï¼ˆtaintedã«ãªã‚‰ãªã„ã‚ˆã†ã«ï¼‰
    const cleanCanvas = document.createElement('canvas');
    const cleanCtx = cleanCanvas.getContext('2d');
    cleanCanvas.width = canvas.width;
    cleanCanvas.height = canvas.height;
    
    // ç™½èƒŒæ™¯ã§å¡—ã‚Šã¤ã¶ã—ï¼ˆèƒŒæ™¯ç”»åƒã¯ä½¿ã‚ãªã„ï¼‰
    cleanCtx.fillStyle = '#ffffff';
    cleanCtx.fillRect(0, 0, cleanCanvas.width, cleanCanvas.height);
    
    // ä¿å­˜ã•ã‚ŒãŸæç”»ã‚³ãƒãƒ³ãƒ‰ã‚’å†å®Ÿè¡Œï¼ˆ360åº¦å›è»¢ = å…ƒã®å‘ãï¼‰
    if (drawingCommands.length > 0) {
      // console.log(`ğŸ¨ æç”»ã‚³ãƒãƒ³ãƒ‰æ•°: ${drawingCommands.length}`);
      
      // æç”»ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œï¼ˆå›è»¢ãªã— = å…ƒã®å‘ãï¼‰
      drawingCommands.forEach(cmd => {
        if (cmd.type === 'start') {
          cleanCtx.beginPath();
          cleanCtx.moveTo(cmd.x, cmd.y);
        } else if (cmd.type === 'draw') {
          cleanCtx.lineWidth = cmd.thickness || 8;
          cleanCtx.strokeStyle = cmd.color || 'black';
          cleanCtx.lineTo(cmd.x, cmd.y);
          cleanCtx.stroke();
        }
      });
      
      // console.log('ğŸ”„ ãƒšã‚¤ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®360åº¦å›è»¢å‡¦ç†å®Œäº†ï¼ˆå…ƒã®å‘ãï¼‰');
    } else {
      // æç”»ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
      // console.log('ğŸ”„ æç”»ãƒ‡ãƒ¼ã‚¿ãŒãªã„ãŸã‚ã€ç™½ç´™ã§å°åˆ·');
      // console.log('ğŸ”„ canvasã«ã¯ä½•ã‚‚æç”»ã—ã¾ã›ã‚“');
      // console.log('ğŸ”„ drawingCommandsé…åˆ—:', drawingCommands);
    }
    
    // è‡ªå‹•å°åˆ·å‡¦ç†
    const imageDataUrl = cleanCanvas.toDataURL('image/png');
    
    // WebSocketçµŒç”±ã§å—ä¿¡å´ã«å°åˆ·æŒ‡ç¤ºã‚’é€ä¿¡
    if (socket && socket.readyState === WebSocket.OPEN) {
      // console.log('ğŸ–¨ï¸ WebSocketçµŒç”±ã§å—ä¿¡å´ã«å°åˆ·ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡');
      socket.send(JSON.stringify({
        type: "printRotatedImage",
        imageData: imageDataUrl,
        printType: 'double_rotated',
        paperSize: currentPaperSize,
        printMode: currentPrintMode,
        switchBotEnabled: document.getElementById('switchBotEffect').checked
      }));
      // console.log('âœ… æ›´ã«180åº¦å›è»¢ç”»åƒã®å°åˆ·å‡¦ç†ã‚’é–‹å§‹');
    } else {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      // console.log('âš ï¸ WebSocketæ¥ç¶šãŒãªã„ãŸã‚ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™');
      const link = document.createElement('a');
      const now = new Date();
      const fileName = `double_rotated_${now.getFullYear()}${(now.getMonth() + 1)
        .toString().padStart(2, "0")}${now.getDate().toString().padStart(2, "0")}_${now
        .getHours().toString().padStart(2, "0")}${now.getMinutes().toString().padStart(2, "0")}${now
        .getSeconds().toString().padStart(2, "0")}.png`;
      
      link.download = fileName;
      link.href = imageDataUrl;
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // console.log('ğŸ“¥ æ›´ã«180åº¦å›è»¢ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†:', fileName);
    }
    
    
  } catch (error) {
    console.error('âŒ æ›´ã«180åº¦å›è»¢ç”»åƒä¿å­˜ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.message, error);
    alert('æ›´ã«180åº¦å›è»¢ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

// ğŸ¤– SwitchBotãƒ†ã‚¹ãƒˆé–¢æ•°ï¼ˆé€ä¿¡å´ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ï¼‰
function testSwitchBot() {
  // console.log("ğŸ¤– é€ä¿¡å´ã‹ã‚‰SwitchBotãƒ†ã‚¹ãƒˆå®Ÿè¡Œ");
  
  // å—ä¿¡å´ã«SwitchBotãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
  if (socket.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({
      type: "switchBotTest"
    }));
    // console.log("ğŸ¤– å—ä¿¡å´ã«SwitchBotãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡");
  } else {
    console.error("âŒ WebSocketæ¥ç¶šãŒé–‰ã˜ã¦ã„ã¾ã™");
    alert("WebSocketæ¥ç¶šãŒé–‰ã˜ã¦ã„ã¾ã™");
  }
}

// ğŸ¨ ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆé–¢æ•°
function toggleTheme() {
  const body = document.body;
  const themeToggle = document.getElementById('themeToggle');
  
  if (body.classList.contains('modern')) {
    // ãƒ¢ãƒ€ãƒ³ â†’ ã‚¯ãƒ©ã‚·ãƒƒã‚¯
    body.classList.remove('modern');
    body.classList.add('classic');
    themeToggle.textContent = 'ğŸ¨ ãƒ¢ãƒ€ãƒ³';
    // console.log('ğŸ“ ã‚¯ãƒ©ã‚·ãƒƒã‚¯ãƒ†ãƒ¼ãƒã«åˆ‡ã‚Šæ›¿ãˆ');
  } else {
    // ã‚¯ãƒ©ã‚·ãƒƒã‚¯ â†’ ãƒ¢ãƒ€ãƒ³
    body.classList.remove('classic');
    body.classList.add('modern');
    themeToggle.textContent = 'ğŸ“ ã‚¯ãƒ©ã‚·ãƒƒã‚¯';
    // console.log('ğŸ¨ ãƒ¢ãƒ€ãƒ³ãƒ†ãƒ¼ãƒã«åˆ‡ã‚Šæ›¿ãˆ');
  }
}

// èƒŒæ™¯ç”»åƒã®å¤‰å½¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
let backgroundScale = 1.0; // ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆå¤§ãã•ï¼‰
let backgroundOffsetY = 0; // å‚ç›´ã‚ªãƒ•ã‚»ãƒƒãƒˆ

// ğŸ¬ é€ä¿¡å´å‹•ç”»é–¢æ•°ç¾¤ (createSenderVideo, playSenderVideo, stopSenderVideoAtLastFrame, hideSenderVideo, stopSenderVideo) ã¯video-sender.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// é€ä¿¡å´PNGèƒŒæ™¯è¡¨ç¤ºé–¢æ•°
// ğŸ–¼ï¸ showSenderPngBackgroundé–¢æ•°ã¯canvas-background.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// å‚¾ãã‚»ãƒ³ã‚µãƒ¼æ©Ÿèƒ½ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ

// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ï¼ˆçŸ¢å°ã‚­ãƒ¼ã§æ“ä½œ - ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ï¼‰
document.addEventListener('keydown', function(event) {
  // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹å ´åˆã¯ç„¡è¦–
  if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
    return;
  }
  
  switch(event.key) {
    case 'ArrowUp':
      event.preventDefault();
      // èƒŒæ™¯ã‚’ä¸Šã«ç§»å‹•ãƒ»æ‹¡å¤§
      backgroundOffsetY = Math.max(backgroundOffsetY - 20, -100);
      backgroundScale = Math.min(backgroundScale + 0.1, 2.0);
      updateBackgroundTransform();
      // console.log(`â¬†ï¸ çŸ¢å°ã‚­ãƒ¼ä¸Š - ã‚ªãƒ•ã‚»ãƒƒãƒˆ: ${backgroundOffsetY}, ã‚¹ã‚±ãƒ¼ãƒ«: ${backgroundScale.toFixed(1)}`);
      break;
    case 'ArrowDown':
      event.preventDefault();
      // èƒŒæ™¯ã‚’ä¸‹ã«ç§»å‹•ãƒ»ç¸®å°
      backgroundOffsetY = Math.min(backgroundOffsetY + 20, 100);
      backgroundScale = Math.max(backgroundScale - 0.1, 0.5);
      updateBackgroundTransform();
      // console.log(`â¬‡ï¸ çŸ¢å°ã‚­ãƒ¼ä¸‹ - ã‚ªãƒ•ã‚»ãƒƒãƒˆ: ${backgroundOffsetY}, ã‚¹ã‚±ãƒ¼ãƒ«: ${backgroundScale.toFixed(1)}`);
      break;
    case 'ArrowLeft':
      event.preventDefault();
      setBackground('./back3.png');
      // console.log('â¬…ï¸ çŸ¢å°ã‚­ãƒ¼å·¦ - èƒŒæ™¯1ã«å¤‰æ›´');
      break;
    case 'ArrowRight':
      event.preventDefault();
      setBackground('./back4.png');
      // console.log('â¡ï¸ çŸ¢å°ã‚­ãƒ¼å³ - èƒŒæ™¯3ã«å¤‰æ›´');
      break;
  }
});

// èƒŒæ™¯ç”»åƒã®å¤‰å½¢ã‚’é©ç”¨ã™ã‚‹é–¢æ•°
// ğŸ“ updateBackgroundTransformé–¢æ•°ã¯canvas-background.jsã«ç§»å‹•ã—ã¾ã—ãŸ

// åˆæœŸåŒ–å‡¦ç†ï¼šèµ·å‹•æ™‚ã«èƒŒæ™¯2ã‚’è¨­å®š
window.addEventListener('DOMContentLoaded', () => {
  // console.log('ğŸš€ åˆæœŸåŒ–å‡¦ç†é–‹å§‹');
  
  // ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºã¨è¨­å®šé©ç”¨
  const deviceInfo = DeviceManager.applyDeviceSettings();
  
  // ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ é˜²æ­¢ç”¨ã®å¤‰æ•°
  let lastTouchEnd = 0;
  
  // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã®ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ é˜²æ­¢ï¼ˆãƒšãƒ³æç”»æ™‚ã‚‚å«ã‚€ï¼‰
  document.addEventListener('touchstart', function(e) {
    // ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã®ã‚¿ãƒƒãƒã¯å…¨ã¦æç”»ã¨ã—ã¦æ‰±ã„ã€ã‚ºãƒ¼ãƒ ç„¡åŠ¹
    if (e.target.tagName === 'CANVAS' || e.target.id === 'drawCanvas') {
      e.preventDefault();
      return false;
    }
    if (e.touches.length > 1) {
      e.preventDefault();
    }
  }, { passive: false });
  
  document.addEventListener('touchend', function(e) {
    const now = new Date().getTime();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, { passive: false });
  
  document.addEventListener('touchmove', function(e) {
    // ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã§ã®å…¨ã¦ã®ã‚¿ãƒƒãƒãƒ ãƒ¼ãƒ–ã‚’ã‚ºãƒ¼ãƒ ç„¡åŠ¹ã«
    if (e.target.tagName === 'CANVAS' || e.target.id === 'drawCanvas') {
      e.preventDefault();
      return false;
    }
    if (e.touches.length > 1) {
      e.preventDefault();
    }
  }, { passive: false });
  
  // Pointer Events APIã§ãƒšãƒ³å…¥åŠ›ã‚‚åˆ¶å¾¡
  document.addEventListener('pointerdown', function(e) {
    if (e.target.tagName === 'CANVAS' || e.target.id === 'drawCanvas') {
      e.preventDefault();
    }
  }, { passive: false });
  
  // Gestureã‚¤ãƒ™ãƒ³ãƒˆï¼ˆSafariï¼‰ã‚‚ç„¡åŠ¹åŒ–
  document.addEventListener('gesturestart', function(e) {
    e.preventDefault();
  }, false);
  
  document.addEventListener('gesturechange', function(e) {
    e.preventDefault();
  }, false);
  
  document.addEventListener('gestureend', function(e) {
    e.preventDefault();
  }, false);
  
  // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¹ã‚±ãƒ¼ãƒ«0.7ã‚’é©ç”¨
  updateCanvasScale(0.7);
  
  // Writer IDã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’ä½œæˆ
  createWriterStatusDiv();
  
  // èƒŒæ™¯2ã‚’è‡ªå‹•è¨­å®š
  setTimeout(() => {
    // console.log('ğŸ–¼ï¸ èµ·å‹•æ™‚ã«èƒŒæ™¯2ã‚’è‡ªå‹•è¨­å®š');
    setBackground('./back2.png');
    
    // èƒŒæ™¯2ãƒœã‚¿ãƒ³ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
    const back2Btn = document.getElementById('back2Btn');
    if (back2Btn) {
      document.querySelectorAll('.bg-btn').forEach(btn => btn.classList.remove('selected'));
      back2Btn.classList.add('selected');
    }
  }, 500); // WebSocketæ¥ç¶šã‚’å¾…ã¤ãŸã‚å°‘ã—é…å»¶
});

// ğŸ¯ åº§æ¨™ãƒ†ã‚¹ãƒˆç”¨é–¢æ•°ï¼šå³ä¸‹ã«çŸ­ã„ç·šã‚’æç”»
// ğŸ¯ testDrawRightBottomé–¢æ•°ã¯canvas-background.jsã«ç§»å‹•ã—ã¾ã—ãŸ


</script>
</div>

<div class="color-panel">
  <h3>ãƒšãƒ³ã®è‰²</h3>
  <button class="color-btn selected" style="background: black;" onclick="setPenColor('black')"></button>
  <button class="color-btn" style="background: red;" onclick="setPenColor('red')"></button>
  <button class="color-btn" style="background: blue;" onclick="setPenColor('blue')"></button>
  <button class="color-btn" style="background: green;" onclick="setPenColor('green')"></button>
  <button class="color-btn" style="background: white; border: 4px solid red; box-sizing: border-box;" onclick="setPenColor('white-red-border')"></button>
</div>

<div class="thickness-panel">
  <h3>ãƒšãƒ³ã®å¤ªã•</h3>
  <button class="thickness-btn" onclick="setPenThickness(10)" title="å¤ªã„ (+30%)">
    <div style="width: 21px; height: 21px; border-radius: 50%; background: #333; flex-shrink: 0;"></div>
  </button>
  <button class="thickness-btn selected" onclick="setPenThickness(8)" title="æ¨™æº–">
    <div style="width: 16px; height: 16px; border-radius: 50%; background: #333; flex-shrink: 0;"></div>
  </button>
  <button class="thickness-btn" onclick="setPenThickness(6)" title="ç´°ã„ (-25%)">
    <div style="width: 12px; height: 12px; border-radius: 50%; background: #333; flex-shrink: 0;"></div>
  </button>
  <button class="thickness-btn" onclick="setPenThickness(4)" title="ã¨ã¦ã‚‚ç´°ã„ (-50%)">
    <div style="width: 8px; height: 8px; border-radius: 50%; background: #333; flex-shrink: 0;"></div>
  </button>
</div>

<!-- ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ã®é‡è¤‡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å‰Šé™¤ - ã‚·ãƒ³ãƒ—ãƒ«UI -->

</div>

<!-- è¦–è¦šã‚¨ãƒ•ã‚§ã‚¯ãƒˆæ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="effects.js"></script>

<!-- ç‰¹æ®Šã‚¨ãƒ•ã‚§ã‚¯ãƒˆæ©Ÿèƒ½ï¼ˆãƒãƒ¼ãƒˆãƒ»èŠ±ç«ãƒ»ç´™å¹é›ªï¼‰ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="special-effects.js"></script>

<!-- è¨­å®šãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="settings.js"></script>

<!-- WebSocketãƒ»é€šä¿¡æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="websocket.js"></script>

<!-- èƒŒæ™¯ãƒ»ã‚­ãƒ£ãƒ³ãƒã‚¹ç®¡ç†æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="canvas-background.js"></script>
<!-- é€ä¿¡å´å‹•ç”»æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="video-sender.js"></script>
<!-- éŸ³æ¥½ãƒ»éŸ³å£°æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="audio-music.js"></script>
<!-- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ»è¨ˆç®—æ©Ÿèƒ½ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
<script src="utils.js"></script>

</body>
</html>
